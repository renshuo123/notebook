

# æ–‡ç« æœç´¢

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131556570.png" alt="image-20210709140539138" style="zoom:80%;" />

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131708378.png" alt="image-20230613170844269" style="zoom:80%;" />

## æ­å»ºESç¯å¢ƒ

> è¯¦è§ESç¬”è®°

### æ‹‰å–é•œåƒ

```shell
docker pull elasticsearch:7.4.0
```

### åˆ›å»ºå®¹å™¨

```shell
docker run -id --name elasticsearch -d --restart=always -p 9200:9200 -p 9300:9300 -v /usr/share/elasticsearch/plugins:/usr/share/elasticsearch/plugins -e "discovery.type=single-node" elasticsearch:7.4.0
```

### é…ç½®ä¸­æ–‡åˆ†è¯å™¨ ik

> å› ä¸ºåœ¨åˆ›å»ºelasticsearchå®¹å™¨çš„æ—¶å€™ï¼Œæ˜ å°„äº†ç›®å½•ï¼Œæ‰€ä»¥å¯ä»¥åœ¨å®¿ä¸»æœºä¸Šè¿›è¡Œé…ç½®ikä¸­æ–‡åˆ†è¯å™¨
>

> åœ¨å»é€‰æ‹©ikåˆ†è¯å™¨çš„æ—¶å€™ï¼Œéœ€è¦ä¸elasticsearchçš„ç‰ˆæœ¬å¥½å¯¹åº”ä¸Š
>

> æŠŠèµ„æ–™ä¸­çš„`elasticsearch-analysis-ik-7.4.0.zip`ä¸Šä¼ åˆ°æœåŠ¡å™¨ä¸Š,æ”¾åˆ°å¯¹åº”ç›®å½•ï¼ˆpluginsï¼‰è§£å‹
>

```shell
#åˆ‡æ¢ç›®å½•
cd /usr/share/elasticsearch/plugins
#æ–°å»ºç›®å½•
mkdir analysis-ik
cd analysis-ik
#rootæ ¹ç›®å½•ä¸­æ‹·è´æ–‡ä»¶
mv elasticsearch-analysis-ik-7.4.0.zip /usr/share/elasticsearch/plugins/analysis-ik
#è§£å‹æ–‡ä»¶
cd /usr/share/elasticsearch/plugins/analysis-ik
unzip elasticsearch-analysis-ik-7.4.0.zip
```

### kibanaæµ‹è¯•

```
docker restart es kibana
```

è®¿é—®ï¼šhttp://192.168.88.101:5601/app/dev_tools#/console

```
GET _analyze
{
  "analyzer": "ik_smart",
  "text": "æ¬¢è¿ä½ ï¼Œå¤©æ´¥"
}
```

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230701201653795.png" alt="image-20230701201653795" style="zoom:67%;" />



## åˆ›å»ºç´¢å¼•-æ•°æ®

### éœ€æ±‚ - æ€è·¯åˆ†æ

> - ç”¨æˆ·è¾“å…¥å…³é”®å¯æœç´¢æ–‡ç« åˆ—è¡¨
>
> - å…³é”®è¯é«˜äº®æ˜¾ç¤º
>
> - æ–‡ç« åˆ—è¡¨å±•ç¤ºä¸homeå±•ç¤ºä¸€æ ·ï¼Œå½“ç”¨æˆ·ç‚¹å‡»æŸä¸€ç¯‡æ–‡ç« ï¼Œå¯æŸ¥çœ‹æ–‡ç« è¯¦æƒ…

![image-20210709141502366](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131556592.png)

> ä¸ºäº†åŠ å¿«æ£€ç´¢çš„æ•ˆç‡ï¼Œåœ¨æŸ¥è¯¢çš„æ—¶å€™ä¸ä¼šç›´æ¥ä»æ•°æ®åº“ä¸­æŸ¥è¯¢æ–‡ç« ï¼Œéœ€è¦åœ¨elasticsearchä¸­è¿›è¡Œæ£€ç´¢ã€‚

![image-20210709141558811](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131556591.png)

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131932744.png" alt="image-20230613193217481" style="zoom:80%;" />

### åˆ›å»ºç´¢å¼•å’Œæ˜ å°„

```json
PUT /app_info_article
{
    "mappings":{
        "properties":{
            "id":{
                "type":"long"
            },
            "publishTime":{
                "type":"date"
            },
            "layout":{
                "type":"integer"
            },
            "images":{
                "type":"keyword",
                "index": false
            },
            "staticUrl":{
                "type":"keyword",
                "index": false
            },
            "authorId": {
                "type": "long"
            },
            "authorName": {
                "type": "text"
            },
            "title":{
                "type":"text",
                "analyzer":"ik_smart"
            },
            "content":{
                "type":"text",
                "analyzer":"ik_smart"
            }
        }
    }
}
```

![1606653927638](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131556599.png)

> GETè¯·æ±‚æŸ¥è¯¢æ˜ å°„ï¼šhttp://192.168.200.130:9200/app_info_article
>
> DELETEè¯·æ±‚ï¼Œåˆ é™¤ç´¢å¼•åŠæ˜ å°„ï¼šhttp://192.168.200.130:9200/app_info_article
>
> GETè¯·æ±‚ï¼ŒæŸ¥è¯¢æ‰€æœ‰æ–‡æ¡£ï¼šhttp://192.168.200.130:9200/app_info_article/_search

### æ•°æ®åˆå§‹åŒ–åˆ°ç´¢å¼•åº“

#### es-init

![image-20210709142215818](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131556601.png)

#### ä¾èµ–åæ ‡

```xml
<dependencies>
    <!-- å¼•å…¥ä¾èµ–æ¨¡å— -->
    <dependency>
        <groupId>com.heima</groupId>
        <artifactId>heima-leadnews-common</artifactId>
    </dependency>
    <!-- Spring boot starter -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-test</artifactId>
        <scope>test</scope>
    </dependency>
    <!--elasticsearchæ ¸å¿ƒï¼Œå…¶ä»–çš„ä¾èµ–é™¤äº†testå…¶ä»–çš„æ²¡ç”¨ä¸Š-->
    <dependency>
        <groupId>org.elasticsearch.client</groupId>
        <artifactId>elasticsearch-rest-high-level-client</artifactId>
    </dependency>
    <dependency>
        <groupId>org.jsoup</groupId>
        <artifactId>jsoup</artifactId>
        <version>1.13.1</version>
    </dependency>
</dependencies>
```

#### application.yml

```yml
server:
  port: 9999
spring:
  application:
    name: es-article

  datasource:
    driver-class-name: com.mysql.jdbc.Driver
    url: jdbc:mysql://localhost:3306/leadnews_article?serverTimezone=UTC
    username: root
    password: 123456
# è®¾ç½®Mapperæ¥å£æ‰€å¯¹åº”çš„XMLæ–‡ä»¶ä½ç½®ï¼Œå¦‚æœä½ åœ¨Mapperæ¥å£ä¸­æœ‰è‡ªå®šä¹‰æ–¹æ³•ï¼Œéœ€è¦è¿›è¡Œè¯¥é…ç½®
mybatis-plus:
  mapper-locations: classpath*:mapper/*.xml
  # è®¾ç½®åˆ«ååŒ…æ‰«æè·¯å¾„ï¼Œé€šè¿‡è¯¥å±æ€§å¯ä»¥ç»™åŒ…ä¸­çš„ç±»æ³¨å†Œåˆ«å
  type-aliases-package: com.heima.model.article.pojos


#è‡ªå®šä¹‰elasticsearchè¿æ¥é…ç½®
elasticsearch:
  host: 192.168.88.101
  port: 9200
```

#### SearchArticleVo

```java
@Data
public class SearchArticleVo {
    // æ–‡ç« id
    private Long id;
    // æ–‡ç« æ ‡é¢˜
    private String title;
    // æ–‡ç« å‘å¸ƒæ—¶é—´
    private Date publishTime;
    // æ–‡ç« å¸ƒå±€
    private Integer layout;
    // å°é¢
    private String images;
    // ä½œè€…id
    private Long authorId;
    // ä½œè€…åè¯
    private String authorName;
    //é™æ€url
    private String staticUrl;
    //æ–‡ç« å†…å®¹
    private String content;
}
```

#### Mapper

```java
@Mapper
public interface ApArticleMapper extends BaseMapper<ApArticle> {
    public List<SearchArticleVo> loadArticleList();
}
```

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.heima.es.mapper.ApArticleMapper">
    <resultMap id="resultMap" type="com.heima.es.pojo.SearchArticleVo">
        <id column="id" property="id"/>
        <result column="title" property="title"/>
        <result column="author_id" property="authorId"/>
        <result column="author_name" property="authorName"/>
        <result column="layout" property="layout"/>
        <result column="images" property="images"/>
        <result column="publish_time" property="publishTime"/>
        <result column="static_url" property="staticUrl"/>
        <result column="content" property="content"/>
    </resultMap>
    <select id="loadArticleList" resultMap="resultMap">
        SELECT
            aa.*, aacon.content
        FROM
            `ap_article` aa,
            ap_article_config aac,
            ap_article_content aacon
        WHERE
            aa.id = aac.article_id
          AND aa.id = aacon.article_id
          AND aac.is_delete != 1
          AND aac.is_down != 1
    </select>
</mapper>
```

#### ElasticSearchConfig

```java
@Getter
@Setter
@Configuration
@ConfigurationProperties(prefix = "elasticsearch")
public class ElasticSearchConfig {
    private String host;
    private int port;

    @Bean
    public RestHighLevelClient client(){
        return new RestHighLevelClient(RestClient.builder(
                new HttpHost(
                        host,
                        port,
                        "http"
                )
        ));
    }
}
```

#### ApArticleTestâ­

> å¯¼å…¥æ–¹æ³•æ ¸å¿ƒ

```java
@SpringBootTest
@RunWith(SpringRunner.class)
public class ApArticleTest {

    @Resource
    private ApArticleMapper apArticleMapper;

    @Resource
    private RestHighLevelClient restHighLevelClient;


    // æ³¨æ„ï¼šæ•°æ®é‡çš„å¯¼å…¥ï¼Œå¦‚æœæ•°æ®é‡è¿‡å¤§ï¼Œéœ€è¦åˆ†é¡µå¯¼å…¥
    @Test
    public void init() throws Exception {
        //1.æŸ¥è¯¢æ‰€æœ‰ç¬¦åˆæ¡ä»¶çš„æ–‡ç« æ•°æ®
        List<SearchArticleVo> searchArticleVos = apArticleMapper.loadArticleList();
        //2.æ‰¹é‡å¯¼å…¥åˆ°esç´¢å¼•åº“
        BulkRequest bulkRequest = new BulkRequest("app_info_article");
        for (SearchArticleVo searchArticleVo : searchArticleVos) {
            IndexRequest indexRequest = new IndexRequest()
                    .id(searchArticleVo.getId().toString())
                    .source(JSON.toJSONString(searchArticleVo), XContentType.JSON);
            //æ‰¹é‡æ·»åŠ æ•°æ®
            bulkRequest.add(indexRequest);
        }
        restHighLevelClient.bulk(bulkRequest, RequestOptions.DEFAULT);
    }
}
```

#### æŸ¥è¯¢æµ‹è¯•

```json
GET /app_info_article/_search
{
  "query": {
    "match_all": {}
  },
  "from": 0,
  "size": 20
}
```

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230701221944276.png" alt="image-20230701221944276" style="zoom:80%;" />

## æ–‡ç« æœç´¢

### æ­å»ºæœç´¢å¾®æœåŠ¡

#### åŸºç¡€é…ç½®

> åˆ›å»ºï¼šheima-leadnews-searchæ¨¡å—
>

![image-20210709142616797](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131556162.png)

> ï¼ˆ2ï¼‰åœ¨heima-leadnews-serviceçš„pomä¸­æ·»åŠ ä¾èµ–
>

```xml
<!--elasticsearch-->
<dependency>
    <groupId>org.elasticsearch.client</groupId>
    <artifactId>elasticsearch-rest-high-level-client</artifactId>
</dependency>
```

> ï¼ˆ3ï¼‰nacosé…ç½®ä¸­å¿ƒleadnews-search

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230702100143233.png" alt="image-20230702100143233" style="zoom:80%;" />

```yaml
spring:
  autoconfigure:
    exclude: org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration
elasticsearch:
  host: 192.168.88.101
  port: 9200
```

```java
@Getter
@Setter
@Configuration
@ConfigurationProperties(prefix = "elasticsearch")
public class ElasticSearchConfig {
    private String host;
    private int port;

    @Bean
    public RestHighLevelClient client(){
        System.out.println(host);
        System.out.println(port);
        return new RestHighLevelClient(RestClient.builder(
                new HttpHost(
                        host,
                        port,
                        "http"
                )
        ));
    }
}
```

```java
@SpringBootApplication
@EnableDiscoveryClient
public class SearchApplication {

    public static void main(String[] args) {
        SpringApplication.run(SearchApplication.class,args);
    }
}
```

```yml
server:
  port: 51804
spring:
  application:
    name: leadnews-search
  cloud:
    nacos:
      discovery:
        server-addr: 192.168.88.101:8848
      config:
        server-addr: 192.168.88.101:8848
        file-extension: yml
```

#### æœç´¢å‚æ•°

```java
@Data
public class UserSearchDto {

    //æœç´¢å…³é”®å­—
    String searchWords;
    //å½“å‰é¡µ
    int pageNum;
    //åˆ†é¡µæ¡æ•°
    int pageSize;
    //æœ€å°æ—¶é—´
    Date minBehotTime;

    public int getFromIndex(){
        if(this.pageNum<1)return 0;
        if(this.pageSize<1) this.pageSize = 10;
        return this.pageSize * (pageNum-1);
    }
}
```

#### ä¸šåŠ¡å±‚å®ç°

> åˆ›å»ºä¸šåŠ¡å±‚æ¥å£ï¼šApArticleSearchService
>

```java
package com.heima.search.service;

public interface ArticleSearchService {
    // ESæ–‡ç« åˆ†é¡µæœç´¢
    ResponseResult search(UserSearchDto userSearchDto) throws IOException;
}
```

> å®ç°ç±»ï¼š
>

```java
package com.heima.search.service.impl;


@Service
@Slf4j
public class ArticleSearchServiceImpl implements ArticleSearchService {

    @Autowired
    private RestHighLevelClient restHighLevelClient;

    // esæ–‡ç« åˆ†é¡µæ£€ç´¢
    @Override
    public ResponseResult search(UserSearchDto dto) throws IOException {

        //1.æ£€æŸ¥å‚æ•°
        if(dto == null || StringUtils.isBlank(dto.getSearchWords())){
            return ResponseResult.errorResult(AppHttpCodeEnum.PARAM_INVALID);
        }

        //2.è®¾ç½®æŸ¥è¯¢æ¡ä»¶
        SearchRequest searchRequest = new SearchRequest("app_info_article");
        SearchSourceBuilder searchSourceBuilder = new SearchSourceBuilder();

        //å¸ƒå°”æŸ¥è¯¢
        BoolQueryBuilder boolQueryBuilder = QueryBuilders.boolQuery();

        //å…³é”®å­—çš„åˆ†è¯ä¹‹åæŸ¥è¯¢
        QueryStringQueryBuilder queryStringQueryBuilder = QueryBuilders
            .queryStringQuery(dto.getSearchWords())
            .field("title").field("content")
            .defaultOperator(Operator.OR);
        boolQueryBuilder.must(queryStringQueryBuilder);
        //æŸ¥è¯¢å°äºmindateçš„æ•°æ®
        RangeQueryBuilder rangeQueryBuilder = QueryBuilders
            .rangeQuery("publishTime")
            .lt(dto.getMinBehotTime().getTime());
        boolQueryBuilder.filter(rangeQueryBuilder);

        //åˆ†é¡µæŸ¥è¯¢
        searchSourceBuilder.from(0);
        searchSourceBuilder.size(dto.getPageSize());

        //æŒ‰ç…§å‘å¸ƒæ—¶é—´å€’åºæŸ¥è¯¢
        searchSourceBuilder.sort("publishTime", SortOrder.DESC);

        //è®¾ç½®é«˜äº®  title
        HighlightBuilder highlightBuilder = new HighlightBuilder();
        highlightBuilder.field("title");
        highlightBuilder.preTags("<font style='color: red; font-size: inherit;'>");
        highlightBuilder.postTags("</font>");
        searchSourceBuilder.highlighter(highlightBuilder);

		// æ‹¼æ¥æŸ¥è¯¢æ¡ä»¶
        searchSourceBuilder.query(boolQueryBuilder);
        searchRequest.source(searchSourceBuilder);
        SearchResponse searchResponse = restHighLevelClient
            .search(searchRequest, RequestOptions.DEFAULT);


        //3.ç»“æœå°è£…è¿”å›

        List<Map> list = new ArrayList<>();

        SearchHit[] hits = searchResponse.getHits().getHits();
        for (SearchHit hit : hits) {
            String json = hit.getSourceAsString();
            Map map = JSON.parseObject(json, Map.class);
            //å¤„ç†é«˜äº®
            if(hit.getHighlightFields() != null && hit.getHighlightFields().size() > 0){
                Text[] titles = hit.getHighlightFields().get("title").getFragments();
                String title = StringUtils.join(titles);
                //é«˜äº®æ ‡é¢˜
                map.put("h_title",title);
            }else {
                //åŸå§‹æ ‡é¢˜
                map.put("h_title",map.get("title"));
            }
            list.add(map);
        }

        return ResponseResult.okResult(list);

    }
}
```

#### æ§åˆ¶å±‚å®ç°

> æ–°å»ºæ§åˆ¶å™¨ArticleSearchController
>

```java
package com.heima.search.controller.v1;

@RestController
@RequestMapping("/api/v1/article/search")
public class ArticleSearchController {

    @Resource
    private ArticleSearchService articleSearchService;

    @PostMapping("/search")
    public ResponseResult search(@RequestBody UserSearchDto dto) throws IOException {
        return articleSearchService.search(dto);
    }
}
```

#### ç½‘å…³é…ç½®

> éœ€è¦åœ¨appçš„ç½‘å…³ä¸­æ·»åŠ æœç´¢å¾®æœåŠ¡çš„è·¯ç”±é…ç½®

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230702101512976.png" alt="image-20230702101512976" style="zoom:80%;" />

```yaml
#æœç´¢å¾®æœåŠ¡
- id: leadnews-search
 uri: lb://leadnews-search
 predicates:
   - Path=/search/**
 filters:
   - StripPrefix= 1
```

> å¯åŠ¨é¡¹ç›®è¿›è¡Œæµ‹è¯•ï¼Œè‡³å°‘è¦å¯åŠ¨æ–‡ç« å¾®æœåŠ¡ï¼Œç”¨æˆ·å¾®æœåŠ¡ï¼Œæœç´¢å¾®æœåŠ¡ï¼Œappç½‘å…³å¾®æœåŠ¡

#### åŠŸèƒ½æµ‹è¯•

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230702102650765.png" alt="image-20230702102650765" style="zoom:80%;" />

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230702102710540.png" alt="image-20230702102710540" style="zoom:80%;" />



### æ–°å¢æ–‡ç« åŒæ­¥æ„å»ºç´¢å¼•

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230702104556243.png" alt="image-20230702104556243" style="zoom:80%;" />

#### SearchArticleVo

```java
@Data
public class SearchArticleVo {
    // æ–‡ç« id
    private Long id;
    // æ–‡ç« æ ‡é¢˜
    private String title;
    // æ–‡ç« å‘å¸ƒæ—¶é—´
    private Date publishTime;
    // æ–‡ç« å¸ƒå±€
    private Integer layout;
    // å°é¢
    private String images;
    // ä½œè€…id
    private Long authorId;
    // ä½œè€…åè¯
    private String authorName;
    //é™æ€url
    private String staticUrl;
    //æ–‡ç« å†…å®¹
    private String content;
}
```

####  ArticleConstants

> åœ¨ArticleConstantsç±»ä¸­æ·»åŠ æ–°çš„å¸¸é‡ï¼Œå®Œæ•´ä»£ç å¦‚ä¸‹

```java
package com.heima.common.constants;

public class ArticleConstants {
    public static final Short LOADTYPE_LOAD_MORE = 1;
    public static final Short LOADTYPE_LOAD_NEW = 2;
    public static final String DEFAULT_TAG = "__all__";

    public static final String ARTICLE_ES_SYNC_TOPIC = "article.es.sync.topic";

    public static final Integer HOT_ARTICLE_LIKE_WEIGHT = 3;
    public static final Integer HOT_ARTICLE_COMMENT_WEIGHT = 5;
    public static final Integer HOT_ARTICLE_COLLECTION_WEIGHT = 8;

    public static final String HOT_ARTICLE_FIRST_PAGE = "hot_article_first_page_";
}
```

#### ArticleFreemarkerServiceImpl

> æ–‡ç« å¾®æœåŠ¡çš„ArticleFreemarkerServiceä¸­çš„buildArticleToMinIOæ–¹æ³•ä¸­æ”¶é›†æ•°æ®å¹¶å‘é€æ¶ˆæ¯

> å®Œæ•´ä»£ç å¦‚ä¸‹ï¼š
>

```java
package com.heima.article.service.impl;


@Service
@Slf4j
@Transactional
public class ArticleFreemarkerServiceImpl implements ArticleFreemarkerService {

    @Autowired
    private ApArticleContentMapper apArticleContentMapper;

    @Autowired
    private Configuration configuration;

    @Autowired
    private FileStorageService fileStorageService;

    @Autowired
    private ApArticleService apArticleService;

    // ç”Ÿæˆé™æ€æ–‡ä»¶ä¸Šä¼ åˆ°minIOä¸­
    @Async
    @Override
    public void buildArticleToMinIO(ApArticle apArticle, String content) {
        //å·²çŸ¥æ–‡ç« çš„id
        //4.1 è·å–æ–‡ç« å†…å®¹
        if(StringUtils.isNotBlank(content)){
            //4.2 æ–‡ç« å†…å®¹é€šè¿‡freemarkerç”Ÿæˆhtmlæ–‡ä»¶
            Template template = null;
            StringWriter out = new StringWriter();
            try {
                template = configuration.getTemplate("article.ftl");
                //æ•°æ®æ¨¡å‹
                Map<String,Object> contentDataModel = new HashMap<>();
                contentDataModel.put("content", JSONArray.parseArray(content));
                //åˆæˆ
                template.process(contentDataModel,out);
            } catch (Exception e) {
                e.printStackTrace();
            }
            //4.3 æŠŠhtmlæ–‡ä»¶ä¸Šä¼ åˆ°minioä¸­
            InputStream in = new ByteArrayInputStream(out.toString().getBytes());
            String path = fileStorageService.uploadHtmlFile("", apArticle.getId() + 
                                                            ".html", in);


            //4.4 ä¿®æ”¹ap_articleè¡¨ï¼Œä¿å­˜static_urlå­—æ®µ
            apArticleService.update(Wrappers.<ApArticle>lambdaUpdate()
                                    .eq(ApArticle::getId,apArticle.getId())
                    .set(ApArticle::getStaticUrl,path));

            //å‘é€æ¶ˆæ¯ï¼Œåˆ›å»ºç´¢å¼•ğŸš—
            createArticleESIndex(apArticle,content,path);
        }
    }

    @Autowired
    private KafkaTemplate<String,String> kafkaTemplate;

    // å‘é€æ¶ˆæ¯ï¼Œåˆ›å»ºç´¢å¼•
    private void createArticleESIndex(ApArticle apArticle, 
                                      String content, String path) {
        SearchArticleVo vo = new SearchArticleVo();
        BeanUtils.copyProperties(apArticle,vo);
        vo.setContent(content);
        vo.setStaticUrl(path);

        kafkaTemplate.send(ArticleConstants.ARTICLE_ES_SYNC_TOPIC, 
                           JSON.toJSONString(vo));
    }

}
```

#### nacosé…ç½®

> åœ¨æ–‡ç« å¾®æœåŠ¡çš„nacosçš„é…ç½®ä¸­å¿ƒæ·»åŠ å¦‚ä¸‹é…ç½®

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230702103943466.png" alt="image-20230702103943466" style="zoom:80%;" />

```yaml
spring:
  kafka:
    bootstrap-servers: 192.168.88.101:9092
    producer:
      retries: 10
      key-serializer: org.apache.kafka.common.serialization.StringSerializer
      value-serializer: org.apache.kafka.common.serialization.StringSerializer
```

> æœç´¢å¾®æœåŠ¡ä¸­æ·»åŠ kafkaçš„é…ç½®,nacosé…ç½®å¦‚ä¸‹

```yaml
spring:
  kafka:
    bootstrap-servers: 192.168.88.101:9092
    consumer:
      group-id: ${spring.application.name}
      key-deserializer: org.apache.kafka.common.serialization.StringDeserializer
      value-deserializer: org.apache.kafka.common.serialization.StringDeserializer
```

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230702104046053.png" alt="image-20230702104046053" style="zoom:80%;" />

#### SyncArticleListener

> searchæ¨¡å—å®šä¹‰ç›‘å¬æ¥æ”¶æ¶ˆæ¯,ä¿å­˜ç´¢å¼•æ•°æ®

```java
package com.heima.search.listener;

@Component
@Slf4j
public class SyncArticleListener {

    @Autowired
    private RestHighLevelClient restHighLevelClient;

    @KafkaListener(topics = ArticleConstants.ARTICLE_ES_SYNC_TOPIC)
    public void onMessage(String message){
        if(StringUtils.isNotBlank(message)){

            log.info("SyncArticleListener,message={}",message);

            SearchArticleVo searchArticleVo = JSON.parseObject(message, 
                                                               SearchArticleVo.class);
            IndexRequest indexRequest = new IndexRequest("app_info_article");
            indexRequest.id(searchArticleVo.getId().toString());
            indexRequest.source(message, XContentType.JSON);
            try {
                restHighLevelClient.index(indexRequest, RequestOptions.DEFAULT);
            } catch (IOException e) {
                e.printStackTrace();
                log.error("sync es error={}",e);
            }
        }

    }
}
```

#### åŠŸèƒ½æµ‹è¯•

> æš‚æ—¶æ²¡æœ‰æµ‹è¯•

## MongoDBåŸºç¡€

### éœ€æ±‚åˆ†æ

> - å±•ç¤ºç”¨æˆ·çš„æœç´¢è®°å½•10æ¡ï¼ŒæŒ‰ç…§æœç´¢å…³é”®è¯çš„æ—¶é—´å€’åº
> - å¯ä»¥åˆ é™¤æœç´¢è®°å½•
> - ä¿å­˜å†å²è®°å½•ï¼Œä¿å­˜10æ¡ï¼Œå¤šä½™çš„åˆ™åˆ é™¤æœ€ä¹…çš„å†å²è®°å½•

![1587366878895](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131556220.png)

### æ•°æ®å­˜å‚¨è¯´æ˜

> ç”¨æˆ·çš„æœç´¢è®°å½•ï¼Œéœ€è¦ç»™æ¯ä¸€ä¸ªç”¨æˆ·éƒ½ä¿å­˜ä¸€ä»½ï¼Œæ•°æ®é‡è¾ƒå¤§ï¼Œè¦æ±‚åŠ è½½é€Ÿåº¦å¿«ï¼Œé€šå¸¸è¿™æ ·çš„æ•°æ®å­˜å‚¨åˆ°mongodbæ›´åˆé€‚ï¼Œä¸å»ºè®®ç›´æ¥å­˜å‚¨åˆ°å…³ç³»å‹æ•°æ®åº“ä¸­
>

![image-20210709153428259](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131556457.png)

### MongoDBå®‰è£…é…ç½®

> æ‹‰å–é•œåƒ
>

```
docker pull mongo
```

> åˆ›å»ºå®¹å™¨
>

```sh
docker run -di --name mongo-service --restart=always -p 27017:27017 -v ~/data/mongodata:/data mongo
```

### mongo-demo

#### åŸºæœ¬é…ç½®

å…¶ä¸­æœ‰ä¸‰é¡¹é…ç½®æ¯”è¾ƒå…³é”®ï¼š

> ç¬¬ä¸€ï¼šmongoä¾èµ–
>

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-mongodb</artifactId>
</dependency>
```

> ç¬¬äºŒï¼šmongoé…ç½®
>

```yaml
server:
  port: 9998
spring:
  data:
    mongodb:
      host: 192.168.88.101
      port: 27017
      database: leadnews-history
```

> ç¬¬ä¸‰ï¼šæ˜ å°„
>

```java
package com.itheima.mongo.pojo;

// è”æƒ³è¯è¡¨
@Data
@Document("ap_associate_words")
public class ApAssociateWords implements Serializable {

    private static final long serialVersionUID = 1L;
    private String id;

    // è”æƒ³è¯
    private String associateWords;

    // åˆ›å»ºæ—¶é—´
    private Date createdTime;
}
```

> å¯åŠ¨ç±»

```java
@SpringBootApplication
public class MongoApplication {

    public static void main(String[] args) {
        SpringApplication.run(MongoApplication.class,args);
    }
}
```

#### æ ¸å¿ƒæ–¹æ³•

```java
package com.itheima.mongo.test;


import com.itheima.mongo.MongoApplication;
import com.itheima.mongo.pojo.ApAssociateWords;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.data.domain.Sort;
import org.springframework.data.mongodb.core.MongoTemplate;
import org.springframework.data.mongodb.core.query.Criteria;
import org.springframework.data.mongodb.core.query.Query;
import org.springframework.test.context.junit4.SpringRunner;

import java.util.Date;
import java.util.List;

@SpringBootTest(classes = MongoApplication.class)
@RunWith(SpringRunner.class)
public class MongoTest {


    @Autowired
    private MongoTemplate mongoTemplate;

    //ä¿å­˜
    @Test
    public void saveTest(){
        /*for (int i = 0; i < 10; i++) {
            ApAssociateWords apAssociateWords = new ApAssociateWords();
            apAssociateWords.setAssociateWords("é»‘é©¬å¤´æ¡");
            apAssociateWords.setCreatedTime(new Date());
            mongoTemplate.save(apAssociateWords);
        }*/
        ApAssociateWords apAssociateWords = new ApAssociateWords();
        apAssociateWords.setAssociateWords("é»‘é©¬ç›´æ’­");
        apAssociateWords.setCreatedTime(new Date());
        mongoTemplate.save(apAssociateWords);

    }

    //æŸ¥è¯¢ä¸€ä¸ª
    @Test
    public void saveFindOne(){
        ApAssociateWords apAssociateWords = 
            mongoTemplate.findById("60bd973eb0c1d430a71a7928",                                                                ApAssociateWords.class);
        System.out.println(apAssociateWords);
    }

    //æ¡ä»¶æŸ¥è¯¢
    @Test
    public void testQuery(){
        Query query = Query.query(Criteria.where("associateWords").is("é»‘é©¬å¤´æ¡"))
                .with(Sort.by(Sort.Direction.DESC,"createdTime"));
        List<ApAssociateWords> apAssociateWordsList = mongoTemplate.
            find(query, ApAssociateWords.class);
        System.out.println(apAssociateWordsList);
    }

    @Test
    public void testDel(){
        mongoTemplate.remove(Query.query(Criteria.where("associateWords")
                                         .is("é»‘é©¬å¤´æ¡")),ApAssociateWords.class);
    }
}
```

## ä¿å­˜æœç´¢è®°å½•

### å®ç°æ€è·¯

![image-20210709153935904](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131556557.png)

> ç”¨æˆ·è¾“å…¥å…³é”®å­—è¿›è¡Œæœç´¢çš„å¼‚æ­¥è®°å½•å…³é”®å­—
>

![image-20210709154053892](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131556766.png)

### å®ç°æ­¥éª¤

> 1.æœç´¢å¾®æœåŠ¡é›†æˆmongodb

> â‘ ï¼špomä¾èµ–
>

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-mongodb</artifactId>
</dependency>
```

> â‘¡ï¼šnacosé…ç½®

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230702122031792.png" alt="image-20230702122031792" style="zoom:80%;" />

```yaml
spring:
  data:
   mongodb:
    host: 192.168.88.101
    port: 27017
    database: leadnews-history
```

### pojos

> searchæ¨¡å—

```java
@Data
@Document("ap_associate_words")
public class ApAssociateWords implements Serializable {
    private static final long serialVersionUID = 1L;
    private String id;
    //è”æƒ³è¯
    private String associateWords;
    //åˆ›å»ºæ—¶é—´
    private Date createdTime;
}
```

```java
@Data
@Document("ap_user_search")
public class ApUserSearch implements Serializable {

    private static final long serialVersionUID = 1L;
    //ä¸»é”®
    private String id;
    //ç”¨æˆ·ID
    private Integer userId;
    //æœç´¢è¯
    private String keyword;
    //åˆ›å»ºæ—¶é—´
    private Date createdTime;
}
```

### ApUserSearchService

> searchæ¨¡å—

> åˆ›å»ºApUserSearchServiceæ–°å¢insertæ–¹æ³•

```java
public interface ApUserSearchService {
    /**
     * ä¿å­˜ç”¨æˆ·æœç´¢å†å²è®°å½•
     * @param keyword
     * @param userId
     */
    public void insert(String keyword,Integer userId);
}
```

> å®ç°ç±»
>

```java
@Service
@Slf4j
public class ApUserSearchServiceImpl implements ApUserSearchService {

    @Autowired
    private MongoTemplate mongoTemplate;

    @Override
    @Async
    public void insert(String keyword, Integer userId) {
        //1.æŸ¥è¯¢å½“å‰ç”¨æˆ·çš„æœç´¢å…³é”®è¯
        Query query = Query.query(Criteria.where("userId").is(userId)
                                  .and("keyword").is(keyword));
        ApUserSearch apUserSearch = mongoTemplate.findOne(query, ApUserSearch.class);

        //2.å­˜åœ¨ æ›´æ–°åˆ›å»ºæ—¶é—´
        if(apUserSearch != null){
            apUserSearch.setCreatedTime(new Date());
            mongoTemplate.save(apUserSearch);
            return;
        }

        //3.ä¸å­˜åœ¨ï¼Œåˆ¤æ–­å½“å‰å†å²è®°å½•æ€»æ•°é‡æ˜¯å¦è¶…è¿‡10
        apUserSearch = new ApUserSearch();
        apUserSearch.setUserId(userId);
        apUserSearch.setKeyword(keyword);
        apUserSearch.setCreatedTime(new Date());

        Query query1 = Query.query(Criteria.where("userId").is(userId));
        query1.with(Sort.by(Sort.Direction.DESC,"createdTime"));
        List<ApUserSearch> apUserSearchList = mongoTemplate.find(query1, 
                                                                 ApUserSearch.class);

        if(apUserSearchList == null || apUserSearchList.size() < 10){
            mongoTemplate.save(apUserSearch);
        }else {
            ApUserSearch lastUserSearch = apUserSearchList
                .get(apUserSearchList.size() - 1);
            mongoTemplate.findAndReplace(Query.query(Criteria.where("id")                                                 .is(lastUserSearch.getId())),apUserSearch);
        }
    }
}
```

### æ‹¦æˆªå™¨é…ç½®

> appç½‘å…³é…ç½®ï¼šå‚è€ƒè‡ªåª’ä½“ç›¸å…³å¾®æœåŠ¡ï¼Œåœ¨æœç´¢å¾®æœåŠ¡ä¸­è·å–å½“å‰ç™»å½•çš„ç”¨æˆ·

```java
//è·å¾—tokenè§£æåä¸­çš„ç”¨æˆ·ä¿¡æ¯
Object userId = claimsBody.get("id");
//åœ¨headerä¸­æ·»åŠ æ–°çš„ä¿¡æ¯
ServerHttpRequest serverHttpRequest = request.mutate().headers(httpHeaders -> {
    httpHeaders.add("userId", userId + "");
}).build();
//é‡ç½®å½“å‰çš„header
exchange.mutate().request(serverHttpRequest).build();
```

> åœ¨searchæ¨¡å—ä¸­é…ç½®æ‹¦æˆªå™¨

```java
@Slf4j
public class ApUserInterceptor implements HandlerInterceptor {

    // å¾—åˆ°headerä¸­çš„ç”¨æˆ·ä¿¡æ¯(åœ¨ç½‘å…³ä¸­ä¿å­˜çš„)ï¼Œå¹¶ä¸”å­˜å…¥å½“å‰çº¿ç¨‹ä¸­
    @Override
    public boolean preHandle(HttpServletRequest request, 
                             HttpServletResponse response,
                             Object handler) throws Exception {
        // å¾—åˆ°headerä¸­çš„ä¿¡æ¯
        String userId = request.getHeader("userId");
        // åˆ¤æ–­userIdæ˜¯å¦ä¸ºç©º
        Optional<String> optional = Optional.ofNullable(userId);
        if(optional.isPresent()){
            //æŠŠç”¨æˆ·idå­˜å…¥threadloaclçº¿ç¨‹ä¸­
            ApUser apUser = new ApUser();
            apUser.setId(Integer.valueOf(userId));
            AppTheadLocalUtil.setUser(apUser);
            log.info("AppTheadLocalUtilè®¾ç½®ç”¨æˆ·ä¿¡æ¯åˆ°threadlocalä¸­...");
        }

        return true;
    }

    // æ¸…ç†çº¿ç¨‹ä¸­çš„æ•°æ®
    @Override
    public void afterCompletion(HttpServletRequest request, 
                                HttpServletResponse response, 
                                Object handler, 
                                @Nullable Exception ex) throws Exception {
        log.info("æ¸…ç†threadlocal...");
        AppTheadLocalUtil.clear();
    }
}
```

> åœ¨utilæ¨¡å—åˆ›å»ºThreadLocal

```java
public class AppTheadLocalUtil {
  private final static ThreadLocal<ApUser> APP_USER_THREAD_LOCAL = new ThreadLocal<>();

    // æ·»åŠ ç”¨æˆ·
    public static void  setUser(ApUser apUser){
        APP_USER_THREAD_LOCAL.set(apUser);
    }

    //è·å–ç”¨æˆ·
    public static ApUser getUser(){
        return APP_USER_THREAD_LOCAL.get();
    }

    //æ¸…ç†ç”¨æˆ·
    public static void clear(){
        APP_USER_THREAD_LOCAL.remove();
    }
}
```

> æ¿€æ´»æ‹¦æˆªå™¨

```java
@Configuration
public class WebMvcConfig implements WebMvcConfigurer {

    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        registry.addInterceptor(new ApUserInterceptor()).addPathPatterns("/**");
    }
}
```

### ArticleSearchService

> åœ¨ArticleSearchServiceçš„searchæ–¹æ³•ä¸­è°ƒç”¨ä¿å­˜å†å²è®°å½•ï¼Œå®Œæ•´ä»£ç å¦‚ä¸‹ï¼š

```java
package com.heima.search.service.impl;


@Service
@Slf4j
public class ArticleSearchServiceImpl implements ArticleSearchService {

    @Autowired
    private RestHighLevelClient restHighLevelClient;
	// ä¿å­˜æœç´¢ç»“æœ
    @Autowired
    private ApUserSearchService apUserSearchService;

    // esæ–‡ç« åˆ†é¡µæ£€ç´¢
    @Override
    public ResponseResult search(UserSearchDto dto) throws IOException {

        //1.æ£€æŸ¥å‚æ•°
        if(dto == null || StringUtils.isBlank(dto.getSearchWords())){
            return ResponseResult.errorResult(AppHttpCodeEnum.PARAM_INVALID);
        }
		// è¿™é‡Œè¿›è¡Œå¼‚æ­¥è°ƒç”¨ğŸš—
        ApUser user = AppThreadLocalUtil.getUser();

        //å¼‚æ­¥è°ƒç”¨ ä¿å­˜æœç´¢è®°å½•
        if(user != null && dto.getFromIndex() == 0){
            apUserSearchService.insert(dto.getSearchWords(), user.getId());
        }
		....
        return ResponseResult.okResult(list);
    }
}
```

> 6.åœ¨æœç´¢å¾®æœåŠ¡å¼•å¯¼ç±»ä¸Šå¼€å¯å¼‚æ­¥è°ƒç”¨

![image-20210709154841113](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131556780.png)

### åŠŸèƒ½æµ‹è¯•

> æµ‹è¯•ï¼Œæœç´¢åæŸ¥çœ‹ç»“æœï¼šå¯åŠ¨searchã€Articleã€Userã€UserGateWayå››ä¸ªå¾®æœåŠ¡

> ç™»å½•å¹¶ä¿å­˜token

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230702130524773.png" alt="image-20230702130524773" style="zoom:80%;" />

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230702130537267.png" alt="image-20230702130537267" style="zoom:80%;" />

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230702130610275.png" alt="image-20230702130610275" style="zoom:80%;" />

> æˆåŠŸä¿å­˜å†å²è®°å½•

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230702130636167.png" alt="image-20230702130636167" style="zoom:80%;" />

## åŠ è½½æœç´¢è®°å½•

### æ€è·¯åˆ†æ

æŒ‰ç…§å½“å‰ç”¨æˆ·ï¼ŒæŒ‰ç…§æ—¶é—´å€’åºæŸ¥è¯¢

|          | **è¯´æ˜**             |
| -------- | -------------------- |
| æ¥å£è·¯å¾„ | /api/v1/history/load |
| è¯·æ±‚æ–¹å¼ | POST                 |
| å‚æ•°     | æ—                    |
| å“åº”ç»“æœ | ResponseResult       |

### mapper

> å·²å®šä¹‰
>

### ä¸šåŠ¡å±‚

åœ¨ApUserSearchServiceä¸­æ–°å¢æ–¹æ³•

```java
public interface ApUserSearchService {
    // ä¿å­˜ç”¨æˆ·æœç´¢å†å²è®°å½•
    public void insert(String keyword,Integer userId);

    // æŸ¥è¯¢æœç´¢å†å²
    ResponseResult findUserSearch();
}
```

å®ç°æ–¹æ³•

```java
// æŸ¥è¯¢æœç´¢å†å²
@Override
public ResponseResult findUserSearch() {
    //è·å–å½“å‰ç”¨æˆ·
    ApUser user = AppTheadLocalUtil.getUser();
    if(user == null){
        return ResponseResult.errorResult(AppHttpCodeEnum.NEED_LOGIN);
    }
    //æ ¹æ®ç”¨æˆ·æŸ¥è¯¢æ•°æ®ï¼ŒæŒ‰ç…§æ—¶é—´å€’åº
    List<ApUserSearch> apUserSearches = mongoTemplate
        .find(Query.query(Criteria.where("userId")                                               .is(user.getId())).with(Sort.by(Sort.Direction.DESC, "createdTime")), 
              ApUserSearch.class);
    return ResponseResult.okResult(apUserSearches);
}
```

### æ§åˆ¶å™¨

```java
//  APPç”¨æˆ·æœç´¢ä¿¡æ¯è¡¨ å‰ç«¯æ§åˆ¶å™¨
@Slf4j
@RestController
@RequestMapping("/api/v1/history")
public class ApUserSearchController{

    @Autowired
    private ApUserSearchService apUserSearchService;

    @PostMapping("/load")
    public ResponseResult findUserSearch() {
        return apUserSearchService.findUserSearch();
    }
}
```

### åŠŸèƒ½æµ‹è¯•

> é‡å¯searchæ¨¡å—ï¼Œæ‰“å¼€appçš„æœç´¢é¡µé¢ï¼Œå¯ä»¥æŸ¥çœ‹æœç´¢è®°å½•åˆ—è¡¨

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230702131450543.png" alt="image-20230702131450543" style="zoom:80%;" />

## åˆ é™¤æœç´¢è®°å½•

### æ€è·¯åˆ†æ

æŒ‰ç…§æœç´¢å†å²idåˆ é™¤

|          | **è¯´æ˜**            |
| -------- | ------------------- |
| æ¥å£è·¯å¾„ | /api/v1/history/del |
| è¯·æ±‚æ–¹å¼ | POST                |
| å‚æ•°     | HistorySearchDto    |
| å“åº”ç»“æœ | ResponseResult      |

### HistorySearchDto

```java
@Data
public class HistorySearchDto {
    // æ¥æ”¶æœç´¢å†å²è®°å½•id
    String id;
}
```

### ä¸šåŠ¡å±‚

> åœ¨ApUserSearchServiceä¸­æ–°å¢æ–¹æ³•
>

```java
public interface ApUserSearchService {
    // ä¿å­˜ç”¨æˆ·æœç´¢å†å²è®°å½•
    public void insert(String keyword,Integer userId);

    // æŸ¥è¯¢æœç´¢å†å²
    ResponseResult findUserSearch();

    // åˆ é™¤æœç´¢å†å²
    ResponseResult delUserSearch(HistorySearchDto historySearchDto);
}
```

> å®ç°æ–¹æ³•
>

```java
// åˆ é™¤å†å²è®°å½•
@Override
public ResponseResult delUserSearch(HistorySearchDto dto) {
    //1.æ£€æŸ¥å‚æ•°
    if(dto.getId() == null){
        return ResponseResult.errorResult(AppHttpCodeEnum.PARAM_INVALID);
    }
    //2.åˆ¤æ–­æ˜¯å¦ç™»å½•
    ApUser user = AppTheadLocalUtil.getUser();
    if(user == null){
        return ResponseResult.errorResult(AppHttpCodeEnum.NEED_LOGIN);
    }

    //3.åˆ é™¤
    mongoTemplate.remove(Query.query(Criteria.where("userId")
                                     .is(user.getId()).and("id")
                                     .is(dto.getId())),ApUserSearch.class);
    return ResponseResult.okResult(AppHttpCodeEnum.SUCCESS);
}
```

### æ§åˆ¶å™¨

> ä¿®æ”¹ApUserSearchControllerï¼Œè¡¥å…¨æ–¹æ³•
>

```java
@PostMapping("/del")
public ResponseResult delUserSearch(@RequestBody HistorySearchDto historySearchDto) {
    return apUserSearchService.delUserSearch(historySearchDto);
}
```

### åŠŸèƒ½æµ‹è¯•

> é‡å¯searchæ¨¡å—ï¼Œæ‰“å¼€appå¯ä»¥åˆ é™¤æœç´¢è®°å½•

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230702132232150.png" alt="image-20230702132232150" style="zoom:80%;" />

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230702132253021.png" alt="image-20230702132253021" style="zoom:80%;" />



## å…³é”®å­—è”æƒ³è¯

### éœ€æ±‚åˆ†æ

![1587366921085](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131557494.png)

> æ ¹æ®ç”¨æˆ·è¾“å…¥çš„å…³é”®å­—å±•ç¤ºè”æƒ³è¯

### å®ä½“ç±»

```java
package com.heima.search.pojos;

import lombok.Data;
import org.springframework.data.mongodb.core.mapping.Document;

import java.io.Serializable;
import java.util.Date;

/**
 * <p>
 * è”æƒ³è¯è¡¨
 * </p>
 *
 * @author itheima
 */
@Data
@Document("ap_associate_words")
public class ApAssociateWords implements Serializable {

    private static final long serialVersionUID = 1L;

    private String id;

    // è”æƒ³è¯
    private String associateWords;

    //  åˆ›å»ºæ—¶é—´
    private Date createdTime;

}
```

### æœç´¢è¯-æ•°æ®æ¥æº

> é€šå¸¸æ˜¯ç½‘ä¸Šæœç´¢é¢‘ç‡æ¯”è¾ƒé«˜çš„ä¸€äº›è¯ï¼Œé€šå¸¸åœ¨ä¼ä¸šä¸­æœ‰ä¸¤éƒ¨åˆ†æ¥æºï¼š
>

> ç¬¬ä¸€ï¼šè‡ªå·±ç»´æŠ¤æœç´¢è¯
>

> é€šè¿‡åˆ†æç”¨æˆ·æœç´¢é¢‘ç‡è¾ƒé«˜çš„è¯ï¼ŒæŒ‰ç…§æ’åä½œä¸ºæœç´¢è¯
>

> ç¬¬äºŒï¼šç¬¬ä¸‰æ–¹è·å–
>

> å…³é”®è¯è§„åˆ’å¸ˆï¼ˆç™¾åº¦ï¼‰ã€5118ã€çˆ±ç«™ç½‘
>

![image-20210709160036983](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131557498.png)

> å¯¼å…¥èµ„æ–™ä¸­çš„ap_associate_words.jsè„šæœ¬åˆ°mongoä¸­
>

### åŠŸèƒ½å®ç°

#### æ¥å£å®šä¹‰

|          | **è¯´æ˜**                 |
| -------- | ------------------------ |
| æ¥å£è·¯å¾„ | /api/v1/associate/search |
| è¯·æ±‚æ–¹å¼ | POST                     |
| å‚æ•°     | UserSearchDto            |
| å“åº”ç»“æœ | ResponseResult           |

#### ä¸šåŠ¡å±‚

æ–°å»ºè”æƒ³è¯ä¸šåŠ¡å±‚æ¥å£

```java
package com.heima.search.service;

// è”æƒ³è¯è¡¨ æœåŠ¡ç±»
public interface ApAssociateWordsService {
    // è”æƒ³è¯
    ResponseResult findAssociate(UserSearchDto userSearchDto);
}
```

> å®ç°ç±»
>

```java
package com.heima.search.service.impl;

@Service
public class ApAssociateWordsServiceImpl implements ApAssociateWordsService {

    @Autowired
    MongoTemplate mongoTemplate;

    // è”æƒ³è¯
    @Override
    public ResponseResult findAssociate(UserSearchDto userSearchDto) {
        //1 å‚æ•°æ£€æŸ¥
        if(userSearchDto == null || 
           StringUtils.isBlank(userSearchDto.getSearchWords())){
            return ResponseResult.errorResult(AppHttpCodeEnum.PARAM_INVALID);
        }
        //åˆ†é¡µæ£€æŸ¥
        if (userSearchDto.getPageSize() > 20) {
            userSearchDto.setPageSize(20);
        }

        //3 æ‰§è¡ŒæŸ¥è¯¢ æ¨¡ç³ŠæŸ¥è¯¢
        Query query = Query.query(Criteria.where("associateWords")
                                  .regex(".*?\\" + userSearchDto.getSearchWords() + 
                                         ".*"));
        query.limit(userSearchDto.getPageSize());
        List<ApAssociateWords> wordsList = mongoTemplate.find(query, 
                                                              ApAssociateWords.class);
        return ResponseResult.okResult(wordsList);
    }
}
```

#### æ§åˆ¶å™¨

> æ–°å»ºè”æƒ³è¯æ§åˆ¶å™¨
>

```java
package com.heima.search.controller.v1;

import com.heima.model.common.dtos.ResponseResult;
import com.heima.model.search.dtos.UserSearchDto;
import com.heima.search.service.ApAssociateWordsService;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

// è”æƒ³è¯è¡¨ å‰ç«¯æ§åˆ¶å™¨
@Slf4j
@RestController
@RequestMapping("/api/v1/associate")
public class ApAssociateWordsController{

    @Autowired
    private ApAssociateWordsService apAssociateWordsService;

    @PostMapping("/search")
    public ResponseResult findAssociate(@RequestBody UserSearchDto userSearchDto) {
        return apAssociateWordsService.findAssociate(userSearchDto);
    }
}
```

#### åŠŸèƒ½æµ‹è¯•

> åŒæ ·ï¼Œæ‰“å¼€å‰ç«¯è”è°ƒæµ‹è¯•æ•ˆæœ

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230702153354128.png" alt="image-20230702153354128" style="zoom:80%;" />





# åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦

## ä»Šæ—¥å†…å®¹

### éœ€æ±‚åˆ†æ

![image-20210729224950851](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131558948.png)

ç›®å‰å®ç°çš„æ€è·¯ï¼šä»æ•°æ®åº“ç›´æ¥æŒ‰ç…§å‘å¸ƒæ—¶é—´å€’åºæŸ¥è¯¢

> - é—®é¢˜1ï¼šå¦‚ä½•è®¿é—®é‡è¾ƒå¤§ï¼Œç›´æ¥æŸ¥è¯¢æ•°æ®åº“ï¼Œå‹åŠ›è¾ƒå¤§
>
> - é—®é¢˜2ï¼šæ–°å‘å¸ƒçš„æ–‡ç« ä¼šå±•ç¤ºåœ¨å‰é¢ï¼Œå¹¶ä¸æ˜¯çƒ­ç‚¹æ–‡ç« 

### å®ç°æ€è·¯

> æŠŠçƒ­ç‚¹æ•°æ®å­˜å…¥redisè¿›è¡Œå±•ç¤º

> åˆ¤æ–­æ–‡ç« æ˜¯å¦æ˜¯çƒ­ç‚¹ï¼Œæœ‰å‡ é¡¹æ ‡å‡†ï¼š ç‚¹èµæ•°é‡ï¼Œè¯„è®ºæ•°é‡ï¼Œé˜…è¯»æ•°é‡ï¼Œæ”¶è—æ•°é‡

è®¡ç®—æ–‡ç« çƒ­åº¦ï¼Œæœ‰ä¸¤ç§æ–¹æ¡ˆï¼š

> - å®šæ—¶è®¡ç®—æ–‡ç« çƒ­åº¦
>
> - å®æ—¶è®¡ç®—æ–‡ç« çƒ­åº¦

### å®šæ—¶è®¡ç®—

![image-20210729225206299](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131558956.png)

> - æ ¹æ®æ–‡ç« çš„è¡Œä¸ºï¼ˆç‚¹èµã€è¯„è®ºã€é˜…è¯»ã€æ”¶è—ï¼‰è®¡ç®—æ–‡ç« çš„åˆ†å€¼ï¼Œåˆ©ç”¨å®šæ—¶ä»»åŠ¡æ¯å¤©å®Œæˆä¸€æ¬¡è®¡ç®—
>
> - æŠŠåˆ†å€¼è¾ƒå¤§çš„æ–‡ç« æ•°æ®å­˜å…¥åˆ°redisä¸­
>
> - Appç«¯ç”¨æˆ·æŸ¥è¯¢æ–‡ç« åˆ—è¡¨çš„æ—¶å€™ï¼Œä¼˜å…ˆä»redisä¸­æŸ¥è¯¢çƒ­åº¦è¾ƒé«˜çš„æ–‡ç« æ•°æ®

### å®šæ—¶ä»»åŠ¡æ¡†æ¶

springä¼ ç»Ÿçš„å®šæ—¶ä»»åŠ¡@Scheduledï¼Œä½†æ˜¯è¿™æ ·å­˜åœ¨è¿™ä¸€äº›é—®é¢˜ ï¼š

> - åšé›†ç¾¤ä»»åŠ¡çš„é‡å¤æ‰§è¡Œé—®é¢˜
> - cronè¡¨è¾¾å¼å®šä¹‰åœ¨ä»£ç ä¹‹ä¸­ï¼Œä¿®æ”¹ä¸æ–¹ä¾¿
> - å®šæ—¶ä»»åŠ¡å¤±è´¥äº†ï¼Œæ— æ³•é‡è¯•ä¹Ÿæ²¡æœ‰ç»Ÿè®¡
> - å¦‚æœä»»åŠ¡é‡è¿‡å¤§ï¼Œä¸èƒ½æœ‰æ•ˆçš„åˆ†ç‰‡æ‰§è¡Œ
> - è§£å†³è¿™äº›é—®é¢˜çš„æ–¹æ¡ˆä¸ºï¼šxxl-job åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦æ¡†æ¶

## åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦

> å½“å‰è½¯ä»¶çš„æ¶æ„å·²ç»å¼€å§‹å‘åˆ†å¸ƒå¼æ¶æ„è½¬å˜ï¼Œå°†å•ä½“ç»“æ„æ‹†åˆ†ä¸ºè‹¥å¹²æœåŠ¡ï¼ŒæœåŠ¡ä¹‹é—´é€šè¿‡ç½‘ç»œäº¤äº’æ¥å®Œæˆä¸šåŠ¡å¤„ç†ã€‚åœ¨åˆ†å¸ƒå¼æ¶æ„ä¸‹ï¼Œä¸€ä¸ªæœåŠ¡å¾€å¾€ä¼šéƒ¨ç½²å¤šä¸ªå®ä¾‹æ¥è¿è¡Œæˆ‘ä»¬çš„ä¸šåŠ¡ï¼Œå¦‚æœåœ¨è¿™ç§åˆ†å¸ƒå¼ç³»ç»Ÿç¯å¢ƒä¸‹è¿è¡Œä»»åŠ¡è°ƒåº¦ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸º**åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦**ã€‚
>

![image-20210729230059884](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131558959.png)

> å°†ä»»åŠ¡è°ƒåº¦ç¨‹åºåˆ†å¸ƒå¼æ„å»ºï¼Œè¿™æ ·å°±å¯ä»¥å…·æœ‰åˆ†å¸ƒå¼ç³»ç»Ÿçš„ç‰¹ç‚¹ï¼Œå¹¶ä¸”æé«˜ä»»åŠ¡çš„è°ƒåº¦å¤„ç†èƒ½åŠ›ï¼š
>

### å¹¶è¡Œä»»åŠ¡è°ƒåº¦

> å¹¶è¡Œä»»åŠ¡è°ƒåº¦å®ç°é å¤šçº¿ç¨‹ï¼Œå¦‚æœæœ‰å¤§é‡ä»»åŠ¡éœ€è¦è°ƒåº¦ï¼Œæ­¤æ—¶å…‰é å¤šçº¿ç¨‹å°±ä¼šæœ‰ç“¶é¢ˆäº†ï¼Œå› ä¸ºä¸€å°è®¡ç®—æœºCPUçš„å¤„ç†èƒ½åŠ›æ˜¯æœ‰é™çš„ã€‚
>

> å¦‚æœå°†ä»»åŠ¡è°ƒåº¦ç¨‹åºåˆ†å¸ƒå¼éƒ¨ç½²ï¼Œæ¯ä¸ªç»“ç‚¹è¿˜å¯ä»¥éƒ¨ç½²ä¸ºé›†ç¾¤ï¼Œè¿™æ ·å°±å¯ä»¥è®©å¤šå°è®¡ç®—æœºå…±åŒå»å®Œæˆä»»åŠ¡è°ƒåº¦ï¼Œæˆ‘ä»¬å¯ä»¥å°†ä»»åŠ¡åˆ†å‰²ä¸ºè‹¥å¹²ä¸ªåˆ†ç‰‡ï¼Œç”±ä¸åŒçš„å®ä¾‹å¹¶è¡Œæ‰§è¡Œï¼Œæ¥æé«˜ä»»åŠ¡è°ƒåº¦çš„å¤„ç†æ•ˆç‡ã€‚
>

### é«˜å¯ç”¨

> è‹¥æŸä¸€ä¸ªå®ä¾‹å®•æœºï¼Œä¸å½±å“å…¶ä»–å®ä¾‹æ¥æ‰§è¡Œä»»åŠ¡ã€‚
>

### å¼¹æ€§æ‰©å®¹

> å½“é›†ç¾¤ä¸­å¢åŠ å®ä¾‹å°±å¯ä»¥æé«˜å¹¶æ‰§è¡Œä»»åŠ¡çš„å¤„ç†æ•ˆç‡ã€‚
>

### ä»»åŠ¡ç®¡ç†ä¸ç›‘æµ‹

> å¯¹ç³»ç»Ÿä¸­å­˜åœ¨çš„æ‰€æœ‰å®šæ—¶ä»»åŠ¡è¿›è¡Œç»Ÿä¸€çš„ç®¡ç†åŠç›‘æµ‹ã€‚è®©å¼€å‘äººå‘˜åŠè¿ç»´äººå‘˜èƒ½å¤Ÿæ—¶åˆ»äº†è§£ä»»åŠ¡æ‰§è¡Œæƒ…å†µï¼Œä»è€Œåšå‡ºå¿«é€Ÿçš„åº”æ€¥å¤„ç†å“åº”ã€‚
>

### åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦é¢ä¸´é—®é¢˜

> å½“ä»»åŠ¡è°ƒåº¦ä»¥é›†ç¾¤æ–¹å¼éƒ¨ç½²ï¼ŒåŒä¸€ä¸ªä»»åŠ¡è°ƒåº¦å¯èƒ½ä¼šæ‰§è¡Œå¤šæ¬¡ï¼Œä¾‹å¦‚ï¼šç”µå•†ç³»ç»Ÿå®šæœŸå‘æ”¾ä¼˜æƒ åˆ¸ï¼Œå°±å¯èƒ½é‡å¤å‘æ”¾ä¼˜æƒ åˆ¸ï¼Œå¯¹å…¬å¸é€ æˆæŸå¤±ï¼Œä¿¡ç”¨å¡è¿˜æ¬¾æé†’å°±ä¼šé‡å¤æ‰§è¡Œå¤šæ¬¡ï¼Œç»™ç”¨æˆ·é€ æˆçƒ¦æ¼ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æ§åˆ¶ç›¸åŒçš„ä»»åŠ¡åœ¨å¤šä¸ªè¿è¡Œå®ä¾‹ä¸Šåªæ‰§è¡Œä¸€æ¬¡ã€‚å¸¸è§è§£å†³æ–¹æ¡ˆï¼š
>

> åˆ†å¸ƒå¼é”ï¼Œå¤šä¸ªå®ä¾‹åœ¨ä»»åŠ¡æ‰§è¡Œå‰é¦–å…ˆéœ€è¦è·å–é”ï¼Œå¦‚æœè·å–å¤±è´¥é‚£ä¹ˆå°±è¯æ˜æœ‰å…¶ä»–æœåŠ¡å·²ç»åœ¨è¿è¡Œï¼Œå¦‚æœè·å–æˆåŠŸé‚£ä¹ˆè¯æ˜æ²¡æœ‰æœåŠ¡åœ¨è¿è¡Œå®šæ—¶ä»»åŠ¡ï¼Œé‚£ä¹ˆå°±å¯ä»¥æ‰§è¡Œã€‚

> ZooKeeperé€‰ä¸¾ï¼Œåˆ©ç”¨ZooKeeperå¯¹Leaderå®ä¾‹æ‰§è¡Œå®šæ—¶ä»»åŠ¡ï¼Œæ‰§è¡Œå®šæ—¶ä»»åŠ¡çš„æ—¶å€™åˆ¤æ–­è‡ªå·±æ˜¯å¦æ˜¯Leaderï¼Œå¦‚æœä¸æ˜¯åˆ™ä¸æ‰§è¡Œï¼Œå¦‚æœæ˜¯åˆ™æ‰§è¡Œä¸šåŠ¡é€»è¾‘ï¼Œè¿™æ ·ä¹Ÿèƒ½è¾¾åˆ°ç›®çš„ã€‚

## xxl-Jobç®€ä»‹

> é’ˆå¯¹åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦çš„éœ€æ±‚ï¼Œå¸‚åœºä¸Šå‡ºç°äº†å¾ˆå¤šçš„äº§å“ï¼š

### ä»»åŠ¡è°ƒåº¦æ¡†æ¶

> 1ï¼‰ TBScheduleï¼šæ·˜å®æ¨å‡ºçš„ä¸€æ¬¾éå¸¸ä¼˜ç§€çš„é«˜æ€§èƒ½åˆ†å¸ƒå¼è°ƒåº¦æ¡†æ¶ï¼Œç›®å‰è¢«åº”ç”¨äºé˜¿é‡Œã€äº¬ä¸œã€æ”¯ä»˜å®ã€å›½ç¾ç­‰å¾ˆå¤šäº’è”ç½‘ä¼ä¸šçš„æµç¨‹è°ƒåº¦ç³»ç»Ÿä¸­ã€‚ä½†æ˜¯å·²ç»å¤šå¹´æœªæ›´æ–°ï¼Œæ–‡æ¡£ç¼ºå¤±ä¸¥é‡ï¼Œç¼ºå°‘ç»´æŠ¤ã€‚

> 2ï¼‰ XXL-Jobï¼šå¤§ä¼—ç‚¹è¯„çš„åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦å¹³å°ï¼Œæ˜¯ä¸€ä¸ªè½»é‡çº§åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦å¹³å°, å…¶æ ¸å¿ƒè®¾è®¡ç›®æ ‡æ˜¯å¼€å‘è¿…é€Ÿã€å­¦ä¹ ç®€å•ã€è½»é‡çº§ã€æ˜“æ‰©å±•ã€‚ç°å·²å¼€æ”¾æºä»£ç å¹¶æ¥å…¥å¤šå®¶å…¬å¸çº¿ä¸Šäº§å“çº¿ï¼Œå¼€ç®±å³ç”¨ã€‚

> 3ï¼‰Elastic-jobï¼šå½“å½“ç½‘å€Ÿé‰´TBScheduleå¹¶åŸºäºquartz äºŒæ¬¡å¼€å‘çš„å¼¹æ€§åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦ç³»ç»Ÿï¼ŒåŠŸèƒ½ä¸°å¯Œå¼ºå¤§ï¼Œé‡‡ç”¨zookeeperå®ç°åˆ†å¸ƒå¼åè°ƒï¼Œå…·æœ‰ä»»åŠ¡é«˜å¯ç”¨ä»¥åŠåˆ†ç‰‡åŠŸèƒ½ã€‚

> 4ï¼‰Saturnï¼š å”¯å“ä¼šå¼€æºçš„ä¸€ä¸ªåˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦å¹³å°ï¼ŒåŸºäºElastic-jobï¼Œå¯ä»¥å…¨åŸŸç»Ÿä¸€é…ç½®ï¼Œç»Ÿä¸€ç›‘
> æ§ï¼Œå…·æœ‰ä»»åŠ¡é«˜å¯ç”¨ä»¥åŠåˆ†ç‰‡åŠŸèƒ½ã€‚ 

> XXL-JOBæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦å¹³å°ï¼Œå…¶æ ¸å¿ƒè®¾è®¡ç›®æ ‡æ˜¯å¼€å‘è¿…é€Ÿã€å­¦ä¹ ç®€å•ã€è½»é‡çº§ã€æ˜“æ‰©å±•ã€‚ç°å·²å¼€æ”¾æºä»£ç å¹¶æ¥å…¥å¤šå®¶å…¬å¸çº¿ä¸Šäº§å“çº¿ï¼Œå¼€ç®±å³ç”¨ã€‚
>

æºç åœ°å€ï¼šhttps://gitee.com/xuxueli0323/xxl-job

æ–‡æ¡£åœ°å€ï¼šhttps://www.xuxueli.com/xxl-job/

### xxl-jobç‰¹æ€§

> **ç®€å•çµæ´»**
> æä¾›Webé¡µé¢å¯¹ä»»åŠ¡è¿›è¡Œç®¡ç†ï¼Œç®¡ç†ç³»ç»Ÿæ”¯æŒç”¨æˆ·ç®¡ç†ã€æƒé™æ§åˆ¶ï¼›
> æ”¯æŒå®¹å™¨éƒ¨ç½²ï¼›
> æ”¯æŒé€šè¿‡é€šç”¨HTTPæä¾›è·¨å¹³å°ä»»åŠ¡è°ƒåº¦ï¼›

> **ä¸°å¯Œçš„ä»»åŠ¡ç®¡ç†åŠŸèƒ½**
> æ”¯æŒé¡µé¢å¯¹ä»»åŠ¡CRUDæ“ä½œï¼›
> æ”¯æŒåœ¨é¡µé¢ç¼–å†™è„šæœ¬ä»»åŠ¡ã€å‘½ä»¤è¡Œä»»åŠ¡ã€Javaä»£ç ä»»åŠ¡å¹¶æ‰§è¡Œï¼›
> æ”¯æŒä»»åŠ¡çº§è”ç¼–æ’ï¼Œçˆ¶ä»»åŠ¡æ‰§è¡Œç»“æŸåè§¦å‘å­ä»»åŠ¡æ‰§è¡Œï¼›
> æ”¯æŒè®¾ç½®æŒ‡å®šä»»åŠ¡æ‰§è¡ŒèŠ‚ç‚¹è·¯ç”±ç­–ç•¥ï¼ŒåŒ…æ‹¬è½®è¯¢ã€éšæœºã€å¹¿æ’­ã€æ•…éšœè½¬ç§»ã€å¿™ç¢Œè½¬ç§»ç­‰ï¼›
> æ”¯æŒCronæ–¹å¼ã€ä»»åŠ¡ä¾èµ–ã€è°ƒåº¦ä¸­å¿ƒAPIæ¥å£æ–¹å¼è§¦å‘ä»»åŠ¡æ‰§è¡Œ

> **é«˜æ€§èƒ½**
> ä»»åŠ¡è°ƒåº¦æµç¨‹å…¨å¼‚æ­¥åŒ–è®¾è®¡å®ç°ï¼Œå¦‚å¼‚æ­¥è°ƒåº¦ã€å¼‚æ­¥è¿è¡Œã€å¼‚æ­¥å›è°ƒç­‰ï¼Œæœ‰æ•ˆå¯†é›†è°ƒåº¦è¿›è¡Œæµé‡å‰Šå³°ï¼›

> **é«˜å¯ç”¨**
> ä»»åŠ¡è°ƒåº¦ä¸­å¿ƒã€ä»»åŠ¡æ‰§è¡ŒèŠ‚ç‚¹å‡ é›†ç¾¤éƒ¨ç½²ï¼Œæ”¯æŒåŠ¨æ€æ‰©å±•ã€æ•…éšœè½¬ç§»
> æ”¯æŒä»»åŠ¡é…ç½®è·¯ç”±æ•…éšœè½¬ç§»ç­–ç•¥ï¼Œæ‰§è¡Œå™¨èŠ‚ç‚¹ä¸å¯ç”¨æ˜¯è‡ªåŠ¨è½¬ç§»åˆ°å…¶ä»–èŠ‚ç‚¹æ‰§è¡Œ
> æ”¯æŒä»»åŠ¡è¶…æ—¶æ§åˆ¶ã€å¤±è´¥é‡è¯•é…ç½®
> æ”¯æŒä»»åŠ¡å¤„ç†é˜»å¡ç­–ç•¥ï¼šè°ƒåº¦å½“ä»»åŠ¡æ‰§è¡ŒèŠ‚ç‚¹å¿™ç¢Œæ—¶æ¥ä¸åŠæ‰§è¡Œä»»åŠ¡çš„å¤„ç†ç­–ç•¥ï¼ŒåŒ…æ‹¬ï¼šä¸²è¡Œã€æŠ›å¼ƒã€è¦†ç›–ç­–ç•¥

> **æ˜“äºç›‘æ§è¿ç»´**
> æ”¯æŒè®¾ç½®ä»»åŠ¡å¤±è´¥é‚®ä»¶å‘Šè­¦ï¼Œé¢„ç•™æ¥å£æ”¯æŒçŸ­ä¿¡ã€é’‰é’‰å‘Šè­¦ï¼›
> æ”¯æŒå®æ—¶æŸ¥çœ‹ä»»åŠ¡æ‰§è¡Œè¿è¡Œæ•°æ®ç»Ÿè®¡å›¾è¡¨ã€ä»»åŠ¡è¿›åº¦ç›‘æ§æ•°æ®ã€ä»»åŠ¡å®Œæ•´æ‰§è¡Œæ—¥å¿—ï¼›

## ç¯å¢ƒæ­å»º

### æºç å®‰è£…

#### è°ƒåº¦ä¸­å¿ƒç¯å¢ƒè¦æ±‚

- Maven3+
- Jdk1.8+
- Mysql5.7+

#### æºç ä»“åº“åœ°å€

| æºç ä»“åº“åœ°å€                         | Release Download                                          |
| :----------------------------------- | :-------------------------------------------------------- |
| https://github.com/xuxueli/xxl-job   | [Download](https://github.com/xuxueli/xxl-job/releases)   |
| http://gitee.com/xuxueli0323/xxl-job | [Download](http://gitee.com/xuxueli0323/xxl-job/releases) |

#### åˆå§‹åŒ–â€œè°ƒåº¦æ•°æ®åº“â€

> è¯·ä¸‹è½½é¡¹ç›®æºç å¹¶è§£å‹ï¼Œè·å– â€œè°ƒåº¦æ•°æ®åº“åˆå§‹åŒ–SQLè„šæœ¬â€ å¹¶æ‰§è¡Œå³å¯ã€‚
>

> ä½ç½®ï¼š`/xxl-job/doc/db/tables_xxl_job.sql`  å…±8å¼ è¡¨
>

![image-20210730001433997](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131558961.png)

```java
- xxl_job_lockï¼šä»»åŠ¡è°ƒåº¦é”è¡¨ï¼›
- xxl_job_groupï¼šæ‰§è¡Œå™¨ä¿¡æ¯è¡¨ï¼Œç»´æŠ¤ä»»åŠ¡æ‰§è¡Œå™¨ä¿¡æ¯ï¼›
- xxl_job_infoï¼šè°ƒåº¦æ‰©å±•ä¿¡æ¯è¡¨ï¼š ç”¨äºä¿å­˜XXL-JOBè°ƒåº¦ä»»åŠ¡çš„æ‰©å±•ä¿¡æ¯ï¼Œå¦‚ä»»åŠ¡åˆ†ç»„ã€ä»»åŠ¡åã€æœºå™¨åœ°å€ã€æ‰§è¡Œå™¨ã€æ‰§è¡Œå…¥å‚å’ŒæŠ¥è­¦é‚®ä»¶ç­‰ç­‰ï¼›
- xxl_job_logï¼šè°ƒåº¦æ—¥å¿—è¡¨ï¼š ç”¨äºä¿å­˜XXL-JOBä»»åŠ¡è°ƒåº¦çš„å†å²ä¿¡æ¯ï¼Œå¦‚è°ƒåº¦ç»“æœã€æ‰§è¡Œç»“æœã€è°ƒåº¦å…¥å‚ã€è°ƒåº¦æœºå™¨å’Œæ‰§è¡Œå™¨ç­‰ç­‰ï¼›
- xxl_job_logglueï¼šä»»åŠ¡GLUEæ—¥å¿—ï¼šç”¨äºä¿å­˜GLUEæ›´æ–°å†å²ï¼Œç”¨äºæ”¯æŒGLUEçš„ç‰ˆæœ¬å›æº¯åŠŸèƒ½ï¼›
- xxl_job_registryï¼šæ‰§è¡Œå™¨æ³¨å†Œè¡¨ï¼Œç»´æŠ¤åœ¨çº¿çš„æ‰§è¡Œå™¨å’Œè°ƒåº¦ä¸­å¿ƒæœºå™¨åœ°å€ä¿¡æ¯ï¼›
- xxl_job_userï¼šç³»ç»Ÿç”¨æˆ·è¡¨ï¼›
```

> è°ƒåº¦ä¸­å¿ƒæ”¯æŒé›†ç¾¤éƒ¨ç½²ï¼Œé›†ç¾¤æƒ…å†µä¸‹å„èŠ‚ç‚¹åŠ¡å¿…è¿æ¥åŒä¸€ä¸ªmysqlå®ä¾‹;
>
> å¦‚æœmysqlåšä¸»ä»,è°ƒåº¦ä¸­å¿ƒé›†ç¾¤èŠ‚ç‚¹åŠ¡å¿…å¼ºåˆ¶èµ°ä¸»åº“;

#### ç¼–è¯‘æºç 

> è§£å‹æºç ,æŒ‰ç…§mavenæ ¼å¼å°†æºç å¯¼å…¥IDE, ä½¿ç”¨mavenè¿›è¡Œç¼–è¯‘å³å¯ï¼Œæºç ç»“æ„å¦‚ä¸‹ï¼š
>

![image-20210729230502703](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131558966.png)

#### é…ç½®éƒ¨ç½²â€œè°ƒåº¦ä¸­å¿ƒâ€

> è°ƒåº¦ä¸­å¿ƒé¡¹ç›®ï¼šxxl-job-admin
>

> ä½œç”¨ï¼šç»Ÿä¸€ç®¡ç†ä»»åŠ¡è°ƒåº¦å¹³å°ä¸Šè°ƒåº¦ä»»åŠ¡ï¼Œè´Ÿè´£è§¦å‘è°ƒåº¦æ‰§è¡Œï¼Œå¹¶ä¸”æä¾›ä»»åŠ¡ç®¡ç†å¹³å°ã€‚
>

> æ­¥éª¤ä¸€ï¼šè°ƒåº¦ä¸­å¿ƒé…ç½®
>

> è°ƒåº¦ä¸­å¿ƒé…ç½®æ–‡ä»¶ï¼š`/xxl-job/xxl-job-admin/src/main/resources/application.properties`
>

> æ•°æ®åº“çš„è¿æ¥ä¿¡æ¯ä¿®æ”¹ä¸ºè‡ªå·±çš„æ•°æ®åº“
>

```properties
### web
server.port=8888
server.servlet.context-path=/xxl-job-admin

### actuator
management.server.servlet.context-path=/actuator
management.health.mail.enabled=false

### resources
spring.mvc.servlet.load-on-startup=0
spring.mvc.static-path-pattern=/static/**
spring.resources.static-locations=classpath:/static/

### freemarker
spring.freemarker.templateLoaderPath=classpath:/templates/
spring.freemarker.suffix=.ftl
spring.freemarker.charset=UTF-8
spring.freemarker.request-context-attribute=request
spring.freemarker.settings.number_format=0.##########

### mybatis
mybatis.mapper-locations=classpath:/mybatis-mapper/*Mapper.xml
#mybatis.type-aliases-package=com.xxl.job.admin.core.model

### xxl-job, datasource
spring.datasource.url=jdbc:mysql://127.0.0.1:3306/xxl_job?Unicode=true&serverTimezone=Asia/Shanghai&characterEncoding=UTF-8
spring.datasource.username=root
spring.datasource.password=root
spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver

### datasource-pool
spring.datasource.type=com.zaxxer.hikari.HikariDataSource
spring.datasource.hikari.minimum-idle=10
spring.datasource.hikari.maximum-pool-size=30
spring.datasource.hikari.auto-commit=true
spring.datasource.hikari.idle-timeout=30000
spring.datasource.hikari.pool-name=HikariCP
spring.datasource.hikari.max-lifetime=900000
spring.datasource.hikari.connection-timeout=10000
spring.datasource.hikari.connection-test-query=SELECT 1

### xxl-job, email
spring.mail.host=smtp.qq.com
spring.mail.port=25
spring.mail.username=xxx@qq.com
spring.mail.password=xxx
spring.mail.properties.mail.smtp.auth=true
spring.mail.properties.mail.smtp.starttls.enable=true
spring.mail.properties.mail.smtp.starttls.required=true
spring.mail.properties.mail.smtp.socketFactory.class=javax.net.ssl.SSLSocketFactory

### xxl-job, access token
xxl.job.accessToken=

### xxl-job, i18n (default is zh_CN, and you can choose "zh_CN", "zh_TC" and "en")
xxl.job.i18n=zh_CN

## xxl-job, triggerpool max size
xxl.job.triggerpool.fast.max=200
xxl.job.triggerpool.slow.max=100

### xxl-job, log retention days
xxl.job.logretentiondays=30
```

> å¯åŠ¨è°ƒåº¦ä¸­å¿ƒï¼Œé»˜è®¤ç™»å½•è´¦å· â€œadmin/123456â€, ç™»å½•åè¿è¡Œç•Œé¢å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚
>

![image-20210729230630495](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131558971.png)



### Dockerå®‰è£…

> 1.åˆ›å»ºmysqlå®¹å™¨ï¼Œåˆå§‹åŒ–xxl-jobçš„SQLè„šæœ¬

```shell
docker run -p 3308:3306 --name mysql57 \
-v /opt/mysql/conf:/etc/mysql \
-v /opt/mysql/logs:/var/log/mysql \
-v /opt/mysql/data:/var/lib/mysql \
-e MYSQL_ROOT_PASSWORD=123456 \
-d mysql:5.7
```

> å’Œä¸Šé¢ä¸€æ ·ï¼Œå¯¼å…¥è¿™8å¼ è¡¨ï¼š`/xxl-job/doc/db/tables_xxl_job.sql`  å…±8å¼ è¡¨

![image-20210730001433997](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131558961.png)

> 2.æ‹‰å–é•œåƒ

```shell
docker pull xuxueli/xxl-job-admin:2.3.0
```

> 3.åˆ›å»ºå®¹å™¨

```shell
docker run -e PARAMS="--spring.datasource.url=jdbc:mysql://192.168.88.101:3308/xxl_job?Unicode=true&characterEncoding=UTF-8 \
--spring.datasource.username=root \
--spring.datasource.password=123456" \
-p 8888:8080 -v /tmp:/data/applogs \
--name xxl-job-admin --restart=always  -d xuxueli/xxl-job-admin:2.3.0
```

> å¯åŠ¨è°ƒåº¦ä¸­å¿ƒï¼Œé»˜è®¤ç™»å½•è´¦å· â€œadmin/123456â€, ç™»å½•åè¿è¡Œç•Œé¢å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚

> http://192.168.88.101:8888/xxl-job-admin

![image-20210729230630495](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131558971.png)



## å¿«é€Ÿå…¥é—¨

> ç™»å½•è°ƒåº¦ä¸­å¿ƒï¼Œç‚¹å‡»ä¸‹å›¾æ‰€ç¤ºâ€œæ–°å»ºä»»åŠ¡â€æŒ‰é’®ï¼Œæ–°å»ºç¤ºä¾‹ä»»åŠ¡

![image-20210729232146585](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131558473.png)

> åˆ›å»ºxxljob-demoé¡¹ç›®ï¼Œå¯¼å…¥ä¾èµ–

```xml
<dependencies>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>

    <!--xxl-job-->
    <dependency>
        <groupId>com.xuxueli</groupId>
        <artifactId>xxl-job-core</artifactId>
        <version>2.3.0</version>
    </dependency>
</dependencies>
```

```java
@SpringBootApplication
public class XxlJobApplication {
    public static void main(String[] args) {
        SpringApplication.run(XxlJobApplication.class,args);
    }
}
```

### åŸºç¡€é…ç½®

```yaml
server:
  port: 8881
xxl:
  job:
    admin:
      addresses: http://192.168.88.101:8888/xxl-job-admin
    executor:
      appname: xxl-job-executor-sample # æ‰§è¡Œå™¨åç§°å’Œç½‘ç«™ä¸Šä¸€æ ·ï¼Œæ˜¯é»˜è®¤çš„
      port: 9999
```

```java
package com.heima.xxljob.config;


// xxl-job config
@Configuration
public class XxlJobConfig {
    private Logger logger = LoggerFactory.getLogger(XxlJobConfig.class);

    @Value("${xxl.job.admin.addresses}")
    private String adminAddresses;

    @Value("${xxl.job.executor.appname}")
    private String appname;

    @Value("${xxl.job.executor.port}")
    private int port;


    @Bean
    public XxlJobSpringExecutor xxlJobExecutor() {
        logger.info(">>>>>>>>>>> xxl-job config init.");
        XxlJobSpringExecutor xxlJobSpringExecutor = new XxlJobSpringExecutor();
        xxlJobSpringExecutor.setAdminAddresses(adminAddresses);
        xxlJobSpringExecutor.setAppname(appname);
        xxlJobSpringExecutor.setPort(port);
        return xxlJobSpringExecutor;
    }
}
```

### ä»»åŠ¡é…ç½®

> ä»»åŠ¡ä»£ç 

```java
package com.heima.xxljob.job;

@Component
public class HelloJob {

    @XxlJob("demoJobHandler")
    public void helloJob(){
        System.out.println("ç®€å•ä»»åŠ¡æ‰§è¡Œäº†ã€‚ã€‚ã€‚ã€‚");

    }
}
```

> æ–°å¢ä»»åŠ¡

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230702160552515.png" alt="image-20230702160552515" style="zoom:80%;" />

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230702160706318.png" alt="image-20230702160706318" style="zoom:80%;" />

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230702160720480.png" alt="image-20230702160720480" style="zoom:80%;" />



## ä»»åŠ¡è¯¦è§£

### ä»»åŠ¡è¯¦è§£-æ‰§è¡Œå™¨

> æ‰§è¡Œå™¨ï¼šä»»åŠ¡çš„ç»‘å®šçš„æ‰§è¡Œå™¨ï¼Œä»»åŠ¡è§¦å‘è°ƒåº¦æ—¶å°†ä¼šè‡ªåŠ¨å‘ç°æ³¨å†ŒæˆåŠŸçš„æ‰§è¡Œå™¨, å®ç°ä»»åŠ¡è‡ªåŠ¨å‘ç°åŠŸèƒ½; å¦ä¸€æ–¹é¢ä¹Ÿå¯ä»¥æ–¹ä¾¿çš„è¿›è¡Œä»»åŠ¡åˆ†ç»„ã€‚æ¯ä¸ªä»»åŠ¡å¿…é¡»ç»‘å®šä¸€ä¸ªæ‰§è¡Œå™¨

![image-20210729232926534](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131558490.png)

![image-20210729232825564](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131558529.png)

 ä»¥ä¸‹æ˜¯æ‰§è¡Œå™¨çš„å±æ€§è¯´æ˜ï¼š

| å±æ€§åç§° | è¯´æ˜                                                         |
| -------- | ------------------------------------------------------------ |
| AppName  | æ˜¯æ¯ä¸ªæ‰§è¡Œå™¨é›†ç¾¤çš„å”¯ä¸€æ ‡ç¤ºAppName, æ‰§è¡Œå™¨ä¼šå‘¨æœŸæ€§ä»¥AppNameä¸ºå¯¹è±¡è¿›è¡Œè‡ªåŠ¨æ³¨å†Œã€‚å¯é€šè¿‡è¯¥é…ç½®è‡ªåŠ¨å‘ç°æ³¨å†ŒæˆåŠŸçš„æ‰§è¡Œå™¨, ä¾›ä»»åŠ¡è°ƒåº¦æ—¶ä½¿ç”¨; |
| åç§°     | æ‰§è¡Œå™¨çš„åç§°, å› ä¸ºAppNameé™åˆ¶å­—æ¯æ•°å­—ç­‰ç»„æˆ,å¯è¯»æ€§ä¸å¼º, åç§°ä¸ºäº†æé«˜æ‰§è¡Œå™¨çš„å¯è¯»æ€§; |
| æ’åº     | æ‰§è¡Œå™¨çš„æ’åº, ç³»ç»Ÿä¸­éœ€è¦æ‰§è¡Œå™¨çš„åœ°æ–¹,å¦‚ä»»åŠ¡æ–°å¢, å°†ä¼šæŒ‰ç…§è¯¥æ’åºè¯»å–å¯ç”¨çš„æ‰§è¡Œå™¨åˆ—è¡¨; |
| æ³¨å†Œæ–¹å¼ | è°ƒåº¦ä¸­å¿ƒè·å–æ‰§è¡Œå™¨åœ°å€çš„æ–¹å¼ï¼›                               |
| æœºå™¨åœ°å€ | æ³¨å†Œæ–¹å¼ä¸º"æ‰‹åŠ¨å½•å…¥"æ—¶æœ‰æ•ˆï¼Œæ”¯æŒäººå·¥ç»´æŠ¤æ‰§è¡Œå™¨çš„åœ°å€ä¿¡æ¯ï¼›   |

> è‡ªåŠ¨æ³¨å†Œå’Œæ‰‹åŠ¨æ³¨å†Œçš„åŒºåˆ«å’Œé…ç½®
>

![image-20210729233016355](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131558707.png)

### ä»»åŠ¡è¯¦è§£-åŸºç¡€é…ç½®

![image-20210729233926457](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131558799.png)

#### åŸºç¡€é…ç½®

> - æ‰§è¡Œå™¨ï¼šæ¯ä¸ªä»»åŠ¡å¿…é¡»ç»‘å®šä¸€ä¸ªæ‰§è¡Œå™¨, æ–¹ä¾¿ç»™ä»»åŠ¡è¿›è¡Œåˆ†ç»„
>
> - ä»»åŠ¡æè¿°ï¼šä»»åŠ¡çš„æè¿°ä¿¡æ¯ï¼Œä¾¿äºä»»åŠ¡ç®¡ç†ï¼›
>
> - è´Ÿè´£äººï¼šä»»åŠ¡çš„è´Ÿè´£äººï¼›
>
> - æŠ¥è­¦é‚®ä»¶ï¼šä»»åŠ¡è°ƒåº¦å¤±è´¥æ—¶é‚®ä»¶é€šçŸ¥çš„é‚®ç®±åœ°å€ï¼Œæ”¯æŒé…ç½®å¤šé‚®ç®±åœ°å€ï¼Œå¤šä¸ªé‚®ç®±é€—å·åˆ†éš”

![image-20210729234009010](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131558817.png)

#### è°ƒåº¦é…ç½®

- æ— ï¼šè¯¥ç±»å‹ä¸ä¼šä¸»åŠ¨è§¦å‘è°ƒåº¦ï¼›
- CRONï¼šè¯¥ç±»å‹å°†ä¼šé€šè¿‡CRONï¼Œè§¦å‘ä»»åŠ¡è°ƒåº¦ï¼›
- å›ºå®šé€Ÿåº¦ï¼šè¯¥ç±»å‹å°†ä¼šä»¥å›ºå®šé€Ÿåº¦ï¼Œè§¦å‘ä»»åŠ¡è°ƒåº¦ï¼›æŒ‰ç…§å›ºå®šçš„é—´éš”æ—¶é—´ï¼Œå‘¨æœŸæ€§è§¦å‘ï¼›

![image-20210729234114283](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131558935.png)

#### ä»»åŠ¡é…ç½®

- è¿è¡Œæ¨¡å¼ï¼šBEANæ¨¡å¼ï¼šä»»åŠ¡ä»¥JobHandleræ–¹å¼ç»´æŠ¤åœ¨æ‰§è¡Œå™¨ç«¯ï¼›éœ€è¦ç»“åˆ "JobHandler" å±æ€§åŒ¹é…æ‰§è¡Œå™¨ä¸­ä»»åŠ¡ï¼›

- JobHandlerï¼šè¿è¡Œæ¨¡å¼ä¸º "BEANæ¨¡å¼" æ—¶ç”Ÿæ•ˆï¼Œå¯¹åº”æ‰§è¡Œå™¨ä¸­æ–°å¼€å‘çš„JobHandlerç±»â€œ@JobHandlerâ€æ³¨è§£è‡ªå®šä¹‰çš„valueå€¼ï¼›

- æ‰§è¡Œå‚æ•°ï¼šä»»åŠ¡æ‰§è¡Œæ‰€éœ€çš„å‚æ•°ï¼›

![image-20210729234219162](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131558109.png)

#### é˜»å¡å¤„ç†ç­–ç•¥

é˜»å¡å¤„ç†ç­–ç•¥ï¼šè°ƒåº¦è¿‡äºå¯†é›†æ‰§è¡Œå™¨æ¥ä¸åŠå¤„ç†æ—¶çš„å¤„ç†ç­–ç•¥ï¼›

- å•æœºä¸²è¡Œï¼ˆé»˜è®¤ï¼‰ï¼šè°ƒåº¦è¯·æ±‚è¿›å…¥å•æœºæ‰§è¡Œå™¨åï¼Œè°ƒåº¦è¯·æ±‚è¿›å…¥FIFO(First Input First Output)é˜Ÿåˆ—å¹¶ä»¥ä¸²è¡Œæ–¹å¼è¿è¡Œï¼›

- ä¸¢å¼ƒåç»­è°ƒåº¦ï¼šè°ƒåº¦è¯·æ±‚è¿›å…¥å•æœºæ‰§è¡Œå™¨åï¼Œå‘ç°æ‰§è¡Œå™¨å­˜åœ¨è¿è¡Œçš„è°ƒåº¦ä»»åŠ¡ï¼Œæœ¬æ¬¡è¯·æ±‚å°†ä¼šè¢«ä¸¢å¼ƒå¹¶æ ‡è®°ä¸ºå¤±è´¥ï¼›

- è¦†ç›–ä¹‹å‰è°ƒåº¦ï¼šè°ƒåº¦è¯·æ±‚è¿›å…¥å•æœºæ‰§è¡Œå™¨åï¼Œå‘ç°æ‰§è¡Œå™¨å­˜åœ¨è¿è¡Œçš„è°ƒåº¦ä»»åŠ¡ï¼Œå°†ä¼šç»ˆæ­¢è¿è¡Œä¸­çš„è°ƒåº¦ä»»åŠ¡å¹¶æ¸…ç©ºé˜Ÿåˆ—ï¼Œç„¶åè¿è¡Œæœ¬åœ°è°ƒåº¦ä»»åŠ¡ï¼›

![image-20210729234256062](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131558206.png)

#### è·¯ç”±ç­–ç•¥

å½“æ‰§è¡Œå™¨é›†ç¾¤éƒ¨ç½²æ—¶ï¼Œæä¾›ä¸°å¯Œçš„è·¯ç”±ç­–ç•¥ï¼ŒåŒ…æ‹¬ï¼›

- FIRSTï¼ˆç¬¬ä¸€ä¸ªï¼‰ï¼šå›ºå®šé€‰æ‹©ç¬¬ä¸€ä¸ªæœºå™¨ï¼›

- LASTï¼ˆæœ€åä¸€ä¸ªï¼‰ï¼šå›ºå®šé€‰æ‹©æœ€åä¸€ä¸ªæœºå™¨ï¼›

- **ROUNDï¼ˆè½®è¯¢ï¼‰**

- RANDOMï¼ˆéšæœºï¼‰ï¼šéšæœºé€‰æ‹©åœ¨çº¿çš„æœºå™¨ï¼›

- CONSISTENT_HASHï¼ˆä¸€è‡´æ€§HASHï¼‰ï¼šæ¯ä¸ªä»»åŠ¡æŒ‰ç…§Hashç®—æ³•å›ºå®šé€‰æ‹©æŸä¸€å°æœºå™¨ï¼Œä¸”æ‰€æœ‰ä»»åŠ¡å‡åŒ€æ•£åˆ—åœ¨ä¸åŒæœºå™¨ä¸Šã€‚

- LEAST_FREQUENTLY_USEDï¼ˆæœ€ä¸ç»å¸¸ä½¿ç”¨ï¼‰ï¼šä½¿ç”¨é¢‘ç‡æœ€ä½çš„æœºå™¨ä¼˜å…ˆè¢«é€‰ä¸¾ï¼›

- LEAST_RECENTLY_USEDï¼ˆæœ€è¿‘æœ€ä¹…æœªä½¿ç”¨ï¼‰ï¼šæœ€ä¹…æœªä½¿ç”¨çš„æœºå™¨ä¼˜å…ˆè¢«é€‰ä¸¾ï¼›

- FAILOVERï¼ˆæ•…éšœè½¬ç§»ï¼‰ï¼šæŒ‰ç…§é¡ºåºä¾æ¬¡è¿›è¡Œå¿ƒè·³æ£€æµ‹ï¼Œç¬¬ä¸€ä¸ªå¿ƒè·³æ£€æµ‹æˆåŠŸçš„æœºå™¨é€‰å®šä¸ºç›®æ ‡æ‰§è¡Œå™¨å¹¶å‘èµ·è°ƒåº¦ï¼›

- BUSYOVERï¼ˆå¿™ç¢Œè½¬ç§»ï¼‰ï¼šæŒ‰ç…§é¡ºåºä¾æ¬¡è¿›è¡Œç©ºé—²æ£€æµ‹ï¼Œç¬¬ä¸€ä¸ªç©ºé—²æ£€æµ‹æˆåŠŸçš„æœºå™¨é€‰å®šä¸ºç›®æ ‡æ‰§è¡Œå™¨å¹¶å‘èµ·è°ƒåº¦ï¼›

- **SHARDING_BROADCAST(åˆ†ç‰‡å¹¿æ’­)ï¼šå¹¿æ’­è§¦å‘å¯¹åº”é›†ç¾¤ä¸­æ‰€æœ‰æœºå™¨æ‰§è¡Œä¸€æ¬¡ä»»åŠ¡ï¼ŒåŒæ—¶ç³»ç»Ÿè‡ªåŠ¨ä¼ é€’åˆ†ç‰‡å‚æ•°ï¼›å¯æ ¹æ®åˆ†ç‰‡å‚æ•°å¼€å‘åˆ†ç‰‡ä»»åŠ¡ï¼›**

![image-20210729234409132](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131558222.png)

## è·¯ç”±ç­–ç•¥

### è·¯ç”±ç­–ç•¥(è½®è¯¢)-æ¡ˆä¾‹

> 1.ä¿®æ”¹ä»»åŠ¡ä¸ºè½®è¯¢

![image-20210729234513775](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131558341.png)

> 2.å¯åŠ¨å¤šä¸ªå¾®æœåŠ¡

![image-20210729234536483](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131558496.png)

ä¿®æ”¹ymlé…ç½®æ–‡ä»¶

```yaml
server:
  port: ${port:8881}


xxl:
  job:
    admin:
      addresses: http://192.168.200.130:8888/xxl-job-admin
    executor:
      appname: xxl-job-executor-sample
      port: ${executor.port:9999}
```

> 3.å¯åŠ¨å¤šä¸ªå¾®æœåŠ¡

> æ¯ä¸ªå¾®æœåŠ¡è½®è¯¢çš„å»æ‰§è¡Œä»»åŠ¡
>

### è·¯ç”±ç­–ç•¥(åˆ†ç‰‡å¹¿æ’­)

#### åˆ†ç‰‡é€»è¾‘

> æ‰§è¡Œå™¨é›†ç¾¤éƒ¨ç½²æ—¶ï¼Œä»»åŠ¡è·¯ç”±ç­–ç•¥é€‰æ‹©â€åˆ†ç‰‡å¹¿æ’­â€æƒ…å†µä¸‹ï¼Œä¸€æ¬¡ä»»åŠ¡è°ƒåº¦å°†ä¼šå¹¿æ’­è§¦å‘å¯¹åº”é›†ç¾¤ä¸­æ‰€æœ‰æ‰§è¡Œå™¨æ‰§è¡Œä¸€æ¬¡ä»»åŠ¡
>

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131558519.png" alt="image-20210729234756221" style="zoom:80%;" />

> æ‰§è¡Œå™¨é›†ç¾¤éƒ¨ç½²æ—¶ï¼Œä»»åŠ¡è·¯ç”±ç­–ç•¥é€‰æ‹©â€åˆ†ç‰‡å¹¿æ’­â€æƒ…å†µä¸‹ï¼Œä¸€æ¬¡ä»»åŠ¡è°ƒåº¦å°†ä¼šå¹¿æ’­è§¦å‘å¯¹åº”é›†ç¾¤ä¸­æ‰€æœ‰æ‰§è¡Œå™¨æ‰§è¡Œä¸€æ¬¡ä»»åŠ¡
>

![image-20210729234822935](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131558637.png)

#### è·¯ç”±ç­–ç•¥(åˆ†ç‰‡å¹¿æ’­)-æ¡ˆä¾‹

> éœ€æ±‚ï¼šè®©ä¸¤ä¸ªèŠ‚ç‚¹åŒæ—¶æ‰§è¡Œ10000ä¸ªä»»åŠ¡ï¼Œæ¯ä¸ªèŠ‚ç‚¹åˆ†åˆ«æ‰§è¡Œ5000ä¸ªä»»åŠ¡
>

> â‘ ï¼šåˆ›å»ºåˆ†ç‰‡æ‰§è¡Œå™¨
>

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230702163230554.png" alt="image-20230702163230554" style="zoom:80%;" />

> â‘¡ï¼šåˆ›å»ºä»»åŠ¡ï¼Œè·¯ç”±ç­–ç•¥ä¸ºåˆ†ç‰‡å¹¿æ’­
>

![image-20210729234948571](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131558838.png)

> â‘¢ï¼šåˆ†ç‰‡å¹¿æ’­ä»£ç ï¼Œåˆ†ç‰‡å‚æ•°

> â€‹     indexï¼šå½“å‰åˆ†ç‰‡åºå·(ä»0å¼€å§‹)ï¼Œæ‰§è¡Œå™¨é›†ç¾¤åˆ—è¡¨ä¸­å½“å‰æ‰§è¡Œå™¨çš„åºå·ï¼›
>
> â€‹     totalï¼šæ€»åˆ†ç‰‡æ•°ï¼Œæ‰§è¡Œå™¨é›†ç¾¤çš„æ€»æœºå™¨æ•°é‡ï¼›

ä¿®æ”¹ymlé…ç½®

```yaml
server:
  port: ${port:8881}

xxl:
  job:
    admin:
      addresses: http://192.168.88.101:8888/xxl-job-admin
    executor:
      appname: xxl-job-sharding-executor
      port: ${executor.port:9999}
```

```java
package com.heima.xxljob.job;

@Component
public class HelloJob {

    @Value("${server.port}")
    private String port;


    @XxlJob("demoJobHandler")
    public void helloJob(){
        System.out.println("ç®€å•ä»»åŠ¡æ‰§è¡Œäº†ã€‚ã€‚ã€‚ã€‚"+port);

    }

    @XxlJob("shardingJobHandler")
    public void shardingJobHandler(){
        //åˆ†ç‰‡çš„å‚æ•°
        int shardIndex = XxlJobHelper.getShardIndex();
        int shardTotal = XxlJobHelper.getShardTotal();

        //ä¸šåŠ¡é€»è¾‘
        List<Integer> list = getList();
        for (Integer integer : list) {
            if(integer % shardTotal == shardIndex){
                System.out.println("å½“å‰ç¬¬"+shardIndex+"åˆ†ç‰‡æ‰§è¡Œäº†ï¼Œä»»åŠ¡é¡¹ä¸ºï¼š"+integer);
            }
        }
    }

    public List<Integer> getList(){
        List<Integer> list = new ArrayList<>();
        for (int i = 0; i < 10000; i++) {
            list.add(i);
        }
        return list;
    }
}
```

> â‘£ï¼šæµ‹è¯•ï¼Œå¯åŠ¨å¤šä¸ªå¾®æœåŠ¡æµ‹è¯•ï¼Œä¸€æ¬¡æ‰§è¡Œå¯ä»¥æ‰§è¡Œå¤šä¸ªä»»åŠ¡





# çƒ­ç‚¹æ–‡ç« -å®šæ—¶è®¡ç®—

## éœ€æ±‚-æ€è·¯

> éœ€æ±‚ï¼šä¸ºæ¯ä¸ªé¢‘é“ç¼“å­˜çƒ­åº¦è¾ƒé«˜çš„30æ¡æ–‡ç« ä¼˜å…ˆå±•ç¤º
>

![image-20210729235644605](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131558935.png)

> åˆ¤æ–­æ–‡ç« çƒ­åº¦è¾ƒé«˜çš„æ ‡å‡†æ˜¯ä»€ä¹ˆï¼Ÿæ–‡ç« ï¼šé˜…è¯»ï¼Œç‚¹èµï¼Œè¯„è®ºï¼Œæ”¶è—
>

> å®ç°æ€è·¯

![image-20210729235731309](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131558119.png)

## å®ç°æ­¥éª¤

> åˆ†å€¼è®¡ç®—ä¸æ¶‰åŠåˆ°å‰ç«¯å·¥ç¨‹ï¼Œä¹Ÿæ— éœ€æä¾›apiæ¥å£ï¼Œæ˜¯ä¸€ä¸ªçº¯åå°çš„åŠŸèƒ½çš„å¼€å‘ã€‚
>

### è¿œç¨‹æ¥å£

> è®¡ç®—å®Œæˆæ–°çƒ­æ•°æ®åï¼Œéœ€è¦ç»™æ¯ä¸ªé¢‘é“ç¼“å­˜ä¸€ä»½æ•°æ®ï¼Œæ‰€ä»¥éœ€è¦æŸ¥è¯¢æ‰€æœ‰é¢‘é“ä¿¡æ¯
>

> â‘  åœ¨heima-leadnews-feign-apiå®šä¹‰è¿œç¨‹æ¥å£
>

```java
package com.heima.apis.wemedia;
@FeignClient("leadnews-wemedia")
public interface IWemediaClient {

    @GetMapping("/api/v1/channel/list")
    public ResponseResult getChannels();
}
```

> â‘¡ heima-leadnews-wemediaç«¯æä¾›æ¥å£
>

```java
package com.heima.wemedia.feign;

@RestController
public class WemediaClient implements IWemediaClient {

    @Autowired
    private WmChannelService wmChannelService;

    @GetMapping("/api/v1/channel/list")
    @Override
    public ResponseResult getChannels() {
        return wmChannelService.findAll();
    }
}
```

> åœ¨ApArticleMapper.xmlæ–°å¢æ–¹æ³•
>

```xml
<select id="findArticleListByLast5days" resultMap="resultMap">
    SELECT
    aa.*
    FROM
    `ap_article` aa
    LEFT JOIN ap_article_config aac ON aa.id = aac.article_id
    <where>
        and aac.is_delete != 1
        and aac.is_down != 1
        <if test="dayParam != null">
            and aa.publish_time <![CDATA[>=]]> #{dayParam}
        </if>
    </where>
</select>
```

> ä¿®æ”¹ApArticleMapperç±»
>

```java
package com.heima.article.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.heima.model.article.dtos.ArticleHomeDto;
import com.heima.model.article.pojos.ApArticle;
import org.apache.ibatis.annotations.Mapper;
import org.apache.ibatis.annotations.Param;

import java.util.Date;
import java.util.List;

@Mapper
public interface ApArticleMapper extends BaseMapper<ApArticle> {

    /**
     * åŠ è½½æ–‡ç« åˆ—è¡¨
     * @param dto
     * @param type  1  åŠ è½½æ›´å¤š   2è®°è½½æœ€æ–°
     * @return
     */
    public List<ApArticle> loadArticleList(ArticleHomeDto dto,Short type);

    public List<ApArticle> findArticleListByLast5days(@Param("dayParam") Date dayParam);
}
```

### çƒ­æ–‡ç« ä¸šåŠ¡å±‚

> å®šä¹‰ä¸šåŠ¡å±‚æ¥å£
>

```java
package com.heima.article.service;

public interface HotArticleService {

    // è®¡ç®—çƒ­ç‚¹æ–‡ç« 
    public void computeHotArticle();
}
```

> ä¿®æ”¹ArticleConstans
>

```java
package com.heima.common.constants;

public class ArticleConstants {
    public static final Short LOADTYPE_LOAD_MORE = 1;
    public static final Short LOADTYPE_LOAD_NEW = 2;
    public static final String DEFAULT_TAG = "__all__";

    public static final String ARTICLE_ES_SYNC_TOPIC = "article.es.sync.topic";

    public static final Integer HOT_ARTICLE_LIKE_WEIGHT = 3;
    public static final Integer HOT_ARTICLE_COMMENT_WEIGHT = 5;
    public static final Integer HOT_ARTICLE_COLLECTION_WEIGHT = 8;

    public static final String HOT_ARTICLE_FIRST_PAGE = "hot_article_first_page_";
}
```

> åˆ›å»ºä¸€ä¸ªvoæ¥æ”¶è®¡ç®—åˆ†å€¼åçš„å¯¹è±¡
>

```java
package com.heima.model.article.vos;

// ç»§æ‰¿ApArticleçš„å­—æ®µ
@Data
public class HotArticleVo extends ApArticle {
    // æ–‡ç« åˆ†å€¼
    private Integer score;
}
```

> nacosé…ç½®

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230702180102673.png" alt="image-20230702180102673" style="zoom:80%;" />

```
spring:
  redis:
    host: 192.168.88.101
    password: leadnews
    port: 6380
```

### ä¸šåŠ¡å±‚å®ç°ç±»

```java
@Service
@Slf4j
public class HotArticleServiceImpl implements HotArticleService {

    @Resource
    private ApArticleMapper apArticleMapper;

    // è®¡ç®—çƒ­ç‚¹æ–‡ç« 
    @Override
    public void computeHotArticle() {
        //1.æŸ¥è¯¢å‰5å¤©çš„æ–‡ç« æ•°æ®,å› ä¸ºæ•°æ®ä¸å¤Ÿï¼Œå°±å†™å¤šäº†
        Date dateParam = DateTime.now().minusDays(5000).toDate();
        List<ApArticle> apArticleList = apArticleMapper
                .findArticleListByLast5days(dateParam);
        //2.è®¡ç®—æ–‡ç« çš„åˆ†å€¼
        List<HotArticleVo> hotArticleVoList = computeHotArticle(apArticleList);
        System.out.println(hotArticleVoList);
        //3.ä¸ºæ¯ä¸ªé¢‘é“ç¼“å­˜30æ¡åˆ†å€¼è¾ƒé«˜çš„æ–‡ç« 
        cacheTagToRedis(hotArticleVoList);
    }

    @Autowired
    private IWemediaClient wemediaClient;

    @Resource
    private StringRedisTemplate stringRedisTemplate;

    // ä¸ºæ¯ä¸ªé¢‘é“ç¼“å­˜30æ¡åˆ†å€¼è¾ƒé«˜çš„æ–‡ç« 
    private void cacheTagToRedis(List<HotArticleVo> hotArticleVoList) {
        System.out.println(456);
        System.out.println(hotArticleVoList);
        //æ¯ä¸ªé¢‘é“ç¼“å­˜30æ¡åˆ†å€¼è¾ƒé«˜çš„æ–‡ç« 
        ResponseResult responseResult = wemediaClient.getChannels();
        if(responseResult.getCode().equals(200)){
            String channelJson = JSON.toJSONString(responseResult.getData());
            List<WmChannel> wmChannels = JSON.parseArray(channelJson, WmChannel.class);
            System.out.println(wmChannels);
            //System.out.println(wmChannels);
            //æ£€ç´¢å‡ºæ¯ä¸ªé¢‘é“çš„æ–‡ç« 
            if(wmChannels != null && wmChannels.size() > 0){
                for (WmChannel wmChannel : wmChannels) {
                    List<HotArticleVo> hotArticleVos =
                            hotArticleVoList.stream().filter(x -> x.getChannelId()==wmChannel.getId())
                                    .collect(Collectors.toList());
                    //ç»™æ–‡ç« è¿›è¡Œæ’åºï¼Œå–30æ¡åˆ†å€¼è¾ƒé«˜çš„æ–‡ç« å­˜å…¥redis
                    // keyï¼šé¢‘é“id   valueï¼š30æ¡åˆ†å€¼è¾ƒé«˜çš„æ–‡ç« 
                    sortAndCache(hotArticleVos,
                            ArticleConstants.HOT_ARTICLE_FIRST_PAGE +
                                    wmChannel.getId());
                }
            }
        }
        //è®¾ç½®æ¨èæ•°æ®
        //ç»™æ–‡ç« è¿›è¡Œæ’åºï¼Œå–30æ¡åˆ†å€¼è¾ƒé«˜çš„æ–‡ç« å­˜å…¥redis  keyï¼šé¢‘é“id   valueï¼š30æ¡åˆ†å€¼è¾ƒé«˜çš„æ–‡ç« 
        sortAndCache(hotArticleVoList, ArticleConstants.HOT_ARTICLE_FIRST_PAGE+
                ArticleConstants.DEFAULT_TAG);


    }

    // æ’åºå¹¶ä¸”ç¼“å­˜æ•°æ®
    private void sortAndCache(List<HotArticleVo> hotArticleVos, String key) {
        hotArticleVos = hotArticleVos.stream().sorted(Comparator
                .comparing(HotArticleVo::getScore)                                                      .reversed()).collect(Collectors.toList());
        if (hotArticleVos.size() > 30) {
            hotArticleVos = hotArticleVos.subList(0, 30);
        }
        stringRedisTemplate.opsForValue().set(key, JSON.toJSONString(hotArticleVos));
    }

    // è®¡ç®—æ–‡ç« åˆ†å€¼
    private List<HotArticleVo> computeHotArticle(List<ApArticle> apArticleList) {
        List<HotArticleVo> hotArticleVoList = new ArrayList<>();
        if(apArticleList != null && apArticleList.size() > 0){
            for (ApArticle apArticle : apArticleList) {
                HotArticleVo hot = new HotArticleVo();
                // å±æ€§æ‹·è´ï¼šåŸï¼šç›®æ ‡
                BeanUtils.copyProperties(apArticle,hot);
                Integer score = computeScore(apArticle);
                hot.setScore(score);
                hotArticleVoList.add(hot);
            }
        }
        return hotArticleVoList;
    }

    // è®¡ç®—æ–‡ç« çš„å…·ä½“åˆ†å€¼
    private Integer computeScore(ApArticle apArticle) {
        Integer scere = 0;
        if(apArticle.getLikes() != null){
            scere += apArticle.getLikes() * ArticleConstants.HOT_ARTICLE_LIKE_WEIGHT;
        }
        if(apArticle.getViews() != null){
            scere += apArticle.getViews();
        }
        if(apArticle.getComment() != null){
            scere += apArticle.getComment() *
                    ArticleConstants.HOT_ARTICLE_COMMENT_WEIGHT;
        }
        if(apArticle.getCollection() != null){
            scere += apArticle.getCollection() *
                    ArticleConstants.HOT_ARTICLE_COLLECTION_WEIGHT;
        }
        return scere;
    }
}
```

> åœ¨ArticleApplicationçš„å¼•å¯¼ç±»ä¸­æ·»åŠ ä»¥ä¸‹æ³¨è§£
>

```java
@EnableFeignClients(basePackages = "com.heima.apis")
```

> ç°åœ¨æ•°æ®åº“ä¸­å‡†å¤‡ç‚¹æ•°æ®

```sql
use leadnews_article;
update ap_article
set likes =2 and  views = 3 
and comment=5 and collection=6 where author_id=4;
```

```java
package com.heima.article.service.impl;

@SpringBootTest(classes = ArticleApplication.class)
@RunWith(SpringRunner.class)
public class HotArticleServiceImplTest {

    @Autowired
    private HotArticleService hotArticleService;

    @Test
    public void computeHotArticle() {
        hotArticleService.computeHotArticle();
    }
}
```

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230702180125713.png" alt="image-20230702180125713" style="zoom:80%;" />

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230702180206123.png" alt="image-20230702180206123" style="zoom:80%;" />

### xxl-jobå®šæ—¶è®¡ç®—

> â‘ ï¼šåœ¨heima-leadnews-articleä¸­çš„pomæ–‡ä»¶ä¸­æ–°å¢ä¾èµ–
>

```xml
<!--xxl-job-->
<dependency>
    <groupId>com.xuxueli</groupId>
    <artifactId>xxl-job-core</artifactId>
    <version>2.3.0</version>
</dependency>
```

> â‘¡ åœ¨xxl-job-adminä¸­æ–°å»ºæ‰§è¡Œå™¨å’Œä»»åŠ¡
>

> æ–°å»ºæ‰§è¡Œå™¨ï¼šleadnews-hot-article-executor
>

![image-20210730000549587](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131558134.png)

> æ–°å»ºä»»åŠ¡computeHotArticleJobï¼šè·¯ç”±ç­–ç•¥ä¸ºè½®è¯¢ï¼ŒCronè¡¨è¾¾å¼ï¼š0 0 2 * * ?     
>
> 0/10 * * * * ? *ï¼Œè¿™æ˜¯æ¯10ç§’æ‰§è¡Œä¸€æ¬¡ï¼Œä¸Šé¢æ˜¯å‡Œæ™¨2ç‚¹æ‰§è¡Œä¸€æ¬¡ï¼Œè¿™æ ·çœ‹ä¸åˆ°æ•ˆæœäº†ï¼Œç”¨10sçš„  

![image-20210730000626824](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131558242.png)

> â‘¢ leadnews-articleä¸­é›†æˆxxl-job
>

> XxlJobConfig
>

```java
package com.heima.article.config;

import com.xxl.job.core.executor.impl.XxlJobSpringExecutor;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

// xxl-job config
@Configuration
public class XxlJobConfig {
    private Logger logger = LoggerFactory.getLogger(XxlJobConfig.class);

    @Value("${xxl.job.admin.addresses}")
    private String adminAddresses;

    @Value("${xxl.job.executor.appname}")
    private String appname;

    @Value("${xxl.job.executor.port}")
    private int port;


    @Bean
    public XxlJobSpringExecutor xxlJobExecutor() {
        logger.info(">>>>>>>>>>> xxl-job config init.");
        XxlJobSpringExecutor xxlJobSpringExecutor = new XxlJobSpringExecutor();
        xxlJobSpringExecutor.setAdminAddresses(adminAddresses);
        xxlJobSpringExecutor.setAppname(appname);
        xxlJobSpringExecutor.setPort(port);
        return xxlJobSpringExecutor;
    }
}
```

> åœ¨nacosé…ç½®æ–°å¢é…ç½®

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230702180931440.png" alt="image-20230702180931440" style="zoom:80%;" />

```yaml
xxl:
  job:
    admin:
      addresses: http://192.168.88.101:8888/xxl-job-admin
    executor:
      appname: leadnews-hot-article-executor
      port: 9999
```

> â‘£ï¼šåœ¨articleå¾®æœåŠ¡ä¸­æ–°å»ºä»»åŠ¡ç±»
>

```java
package com.heima.article.job;

import com.heima.article.service.HotArticleService;
import com.xxl.job.core.handler.annotation.XxlJob;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

@Component
@Slf4j
public class ComputeHotArticleJob {

    @Autowired
    private HotArticleService hotArticleService;

    @XxlJob("computeHotArticleJob")
    public void handle(){
        log.info("çƒ­æ–‡ç« åˆ†å€¼è®¡ç®—è°ƒåº¦ä»»åŠ¡å¼€å§‹æ‰§è¡Œ...");
        hotArticleService.computeHotArticle();
        log.info("çƒ­æ–‡ç« åˆ†å€¼è®¡ç®—è°ƒåº¦ä»»åŠ¡ç»“æŸ...");
    }
}
```

### åŠŸèƒ½æµ‹è¯•

> é‡å¯Articleæ¨¡å—

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230702181218026.png" alt="image-20230702181218026" style="zoom:80%;" />

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230702181406595.png" alt="image-20230702181406595" style="zoom:80%;" />

## æŸ¥è¯¢æ–‡ç« æ”¹é€ 

### æ€è·¯åˆ†æ

![image-20210613110712894](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131558418.png)

### åŠŸèƒ½å®ç°

> åœ¨ApArticleServiceä¸­æ–°å¢æ–¹æ³•

```java
public ResponseResult load2(ArticleHomeDto dto,Short type,boolean firstPage);
```

> å®ç°æ–¹æ³•
>

```java
// åŠ è½½æ–‡ç« åˆ—è¡¨    1 åŠ è½½æ›´å¤š   2 åŠ è½½æœ€æ–°
// firstPage true  æ˜¯é¦–é¡µ  flase éé¦–é¡µ
@Resource
private StringRedisTemplate stringRedisTemplate;

@Override
public ResponseResult load2(ArticleHomeDto dto, Short type, boolean firstPage) {
    // æ˜¯é¦–é¡µï¼Œä»Redisä¸­å–æ•°æ®
    if(firstPage){
        String jsonStr = stringRedisTemplate.opsForValue()
            .get(ArticleConstants.HOT_ARTICLE_FIRST_PAGE + 
                                          dto.getTag());
        if(StringUtils.isNotBlank(jsonStr)){
            List<HotArticleVo> hotArticleVoList = JSON.parseArray(jsonStr, 
                                                                  HotArticleVo.class);
            ResponseResult responseResult = ResponseResult.okResult(hotArticleVoList);
            return responseResult;
        }
    }
    // ä¸æ˜¯é¦–é¡µï¼ŒæŸ¥è¯¢æ•°æ®åº“
    return load(type,dto);
}
```

#### ä¿®æ”¹æ§åˆ¶å™¨

```java
// åŠ è½½é¦–é¡µ
@PostMapping("/load")
public ResponseResult load(@RequestBody ArticleHomeDto dto){
    // return apArticleService.load(dto, ArticleConstants.LOADTYPE_LOAD_MORE);
    return apArticleService.load2(dto, ArticleConstants.LOADTYPE_LOAD_MORE,true);
}
```

### åŠŸèƒ½æµ‹è¯•

```json
{
    "maxBehotTime": "2023-08-04T01:12:12",
    "minBehotTime": "2019-08-04T01:12:12",
    "size": 1,
    "tag": 1
}
```

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230702182823401.png" alt="image-20230702182823401" style="zoom:80%;" />



# çƒ­ç‚¹æ–‡ç« -å®æ—¶è®¡ç®—

## ä»Šæ—¥å†…å®¹

### å®šæ—¶è®¡ç®—ä¸å®æ—¶è®¡ç®—

![image-20210730201509223](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131559319.png)

### ä»Šæ—¥å†…å®¹

kafkaStream

> - ä»€ä¹ˆæ˜¯æµå¼è®¡ç®—
>
> - kafkaStreamæ¦‚è¿°
>
> - kafkaStreamå…¥é—¨æ¡ˆä¾‹
>
> - Springbooté›†æˆkafkaStream

å®æ—¶è®¡ç®—

> - ç”¨æˆ·è¡Œä¸ºå‘é€æ¶ˆæ¯
>
> - kafkaStreamèšåˆå¤„ç†æ¶ˆæ¯
>
> - æ›´æ–°æ–‡ç« è¡Œä¸ºæ•°é‡
>
> - æ›¿æ¢çƒ­ç‚¹æ–‡ç« æ•°æ®

## å®æ—¶æµå¼è®¡ç®—

### åŸºæœ¬æ¦‚å¿µ

> ä¸€èˆ¬æµå¼è®¡ç®—ä¼šä¸æ‰¹é‡è®¡ç®—ç›¸æ¯”è¾ƒã€‚åœ¨æµå¼è®¡ç®—æ¨¡å‹ä¸­ï¼Œè¾“å…¥æ˜¯æŒç»­çš„ï¼Œå¯ä»¥è®¤ä¸ºåœ¨æ—¶é—´ä¸Šæ˜¯æ— ç•Œçš„ï¼Œä¹Ÿå°±æ„å‘³ç€ï¼Œæ°¸è¿œæ‹¿ä¸åˆ°å…¨é‡æ•°æ®å»åšè®¡ç®—ã€‚åŒæ—¶ï¼Œè®¡ç®—ç»“æœæ˜¯æŒç»­è¾“å‡ºçš„ï¼Œä¹Ÿå³è®¡ç®—ç»“æœåœ¨æ—¶é—´ä¸Šä¹Ÿæ˜¯æ— ç•Œçš„ã€‚æµå¼è®¡ç®—ä¸€èˆ¬å¯¹å®æ—¶æ€§è¦æ±‚è¾ƒé«˜ï¼ŒåŒæ—¶ä¸€èˆ¬æ˜¯å…ˆå®šä¹‰ç›®æ ‡è®¡ç®—ï¼Œç„¶åæ•°æ®åˆ°æ¥ä¹‹åå°†è®¡ç®—é€»è¾‘åº”ç”¨äºæ•°æ®ã€‚åŒæ—¶ä¸ºäº†æé«˜è®¡ç®—æ•ˆç‡ï¼Œå¾€å¾€å°½å¯èƒ½é‡‡ç”¨å¢é‡è®¡ç®—ä»£æ›¿å…¨é‡è®¡ç®—ã€‚
>

![image-20210731090637590](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131559322.png)

> æµå¼è®¡ç®—å°±ç›¸å½“äºä¸Šå›¾çš„å³ä¾§æ‰¶æ¢¯ï¼Œæ˜¯å¯ä»¥æºæºä¸æ–­çš„äº§ç”Ÿæ•°æ®ï¼Œæºæºä¸æ–­çš„æ¥æ”¶æ•°æ®ï¼Œæ²¡æœ‰è¾¹ç•Œã€‚
>

### åº”ç”¨åœºæ™¯

> - æ—¥å¿—åˆ†æï¼šç½‘ç«™çš„ç”¨æˆ·è®¿é—®æ—¥å¿—è¿›è¡Œå®æ—¶çš„åˆ†æï¼Œè®¡ç®—è®¿é—®é‡ï¼Œç”¨æˆ·ç”»åƒï¼Œç•™å­˜ç‡ç­‰ç­‰ï¼Œå®æ—¶çš„è¿›è¡Œæ•°æ®åˆ†æï¼Œå¸®åŠ©ä¼ä¸šè¿›è¡Œå†³ç­–
>
> - å¤§å±çœ‹æ¿ç»Ÿè®¡ï¼šå¯ä»¥å®æ—¶çš„æŸ¥çœ‹ç½‘ç«™æ³¨å†Œæ•°é‡ï¼Œè®¢å•æ•°é‡ï¼Œè´­ä¹°æ•°é‡ï¼Œé‡‘é¢ç­‰ã€‚
>
> - å…¬äº¤å®æ—¶æ•°æ®ï¼šå¯ä»¥éšæ—¶æ›´æ–°å…¬äº¤è½¦æ–¹ä½ï¼Œè®¡ç®—å¤šä¹…åˆ°è¾¾ç«™ç‰Œç­‰
>
> - å®æ—¶æ–‡ç« åˆ†å€¼è®¡ç®—ï¼šå¤´æ¡ç±»æ–‡ç« çš„åˆ†å€¼è®¡ç®—ï¼Œé€šè¿‡ç”¨æˆ·çš„è¡Œä¸ºå®æ—¶æ–‡ç« çš„åˆ†å€¼ï¼Œåˆ†å€¼è¶Šé«˜è¶Šæ¨è

### æŠ€æœ¯æ–¹æ¡ˆé€‰å‹

#### Hadoop 

![image-20210731090700382](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131559332.png)

#### Apche Storm

> Storm æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼å®æ—¶å¤§æ•°æ®å¤„ç†ç³»ç»Ÿï¼Œå¯ä»¥å¸®åŠ©æˆ‘ä»¬æ–¹ä¾¿åœ°å¤„ç†æµ·é‡æ•°æ®ï¼Œå…·æœ‰é«˜å¯é ã€é«˜å®¹é”™ã€é«˜æ‰©å±•çš„ç‰¹ç‚¹ã€‚æ˜¯æµå¼æ¡†æ¶ï¼Œæœ‰å¾ˆé«˜çš„æ•°æ®ååèƒ½åŠ›ã€‚

#### Kafka Stream 

> å¯ä»¥è½»æ¾åœ°å°†å…¶åµŒå…¥ä»»ä½•Javaåº”ç”¨ç¨‹åºä¸­ï¼Œå¹¶ä¸ç”¨æˆ·ä¸ºå…¶æµåº”ç”¨ç¨‹åºæ‰€æ‹¥æœ‰çš„ä»»ä½•ç°æœ‰æ‰“åŒ…ï¼Œéƒ¨ç½²å’Œæ“ä½œå·¥å…·é›†æˆã€‚

## Kafka Stream 

### åŸºæœ¬æ¦‚è¿°

> Kafka Streamæ˜¯Apache Kafkaä»0.10ç‰ˆæœ¬å¼•å…¥çš„ä¸€ä¸ªæ–°Featureã€‚å®ƒæ˜¯æä¾›äº†å¯¹å­˜å‚¨äºKafkaå†…çš„æ•°æ®è¿›è¡Œæµå¼å¤„ç†å’Œåˆ†æçš„åŠŸèƒ½ã€‚Kafka Streamçš„ç‰¹ç‚¹å¦‚ä¸‹ï¼š

> - Kafka Streamæä¾›äº†ä¸€ä¸ªéå¸¸ç®€å•è€Œè½»é‡çš„Libraryï¼Œå®ƒå¯ä»¥éå¸¸æ–¹ä¾¿åœ°åµŒå…¥ä»»æ„Javaåº”ç”¨ä¸­ï¼Œä¹Ÿå¯ä»¥ä»»æ„æ–¹å¼æ‰“åŒ…å’Œéƒ¨ç½²
> - **é™¤äº†Kafkaå¤–ï¼Œæ— ä»»ä½•å¤–éƒ¨ä¾èµ–**
> - å……åˆ†åˆ©ç”¨Kafkaåˆ†åŒºæœºåˆ¶å®ç°æ°´å¹³æ‰©å±•å’Œé¡ºåºæ€§ä¿è¯
> - é€šè¿‡å¯å®¹é”™çš„state storeå®ç°é«˜æ•ˆçš„çŠ¶æ€æ“ä½œï¼ˆå¦‚windowed joinå’Œaggregationï¼‰
> - æ”¯æŒæ­£å¥½ä¸€æ¬¡å¤„ç†è¯­ä¹‰
> - æä¾›è®°å½•çº§çš„å¤„ç†èƒ½åŠ›ï¼Œä»è€Œå®ç°æ¯«ç§’çº§çš„ä½å»¶è¿Ÿ
> - æ”¯æŒåŸºäºäº‹ä»¶æ—¶é—´çš„çª—å£æ“ä½œï¼Œå¹¶ä¸”å¯å¤„ç†æ™šåˆ°çš„æ•°æ®ï¼ˆlate arrival of recordsï¼‰
> - åŒæ—¶æä¾›åº•å±‚çš„å¤„ç†åŸè¯­Processorï¼ˆç±»ä¼¼äºStormçš„spoutå’Œboltï¼‰ï¼Œä»¥åŠé«˜å±‚æŠ½è±¡çš„DSLï¼ˆç±»ä¼¼äºSparkçš„map/group/reduceï¼‰



![image-20210730201706437](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131559333.png)

### å…³é”®æ¦‚å¿µ

> **æºå¤„ç†å™¨ï¼ˆSource Processorï¼‰**ï¼šæºå¤„ç†å™¨æ˜¯ä¸€ä¸ªæ²¡æœ‰ä»»ä½•ä¸Šæ¸¸å¤„ç†å™¨çš„ç‰¹æ®Šç±»å‹çš„æµå¤„ç†å™¨ã€‚å®ƒä»ä¸€ä¸ªæˆ–å¤šä¸ªkafkaä¸»é¢˜ç”Ÿæˆè¾“å…¥æµã€‚é€šè¿‡æ¶ˆè´¹è¿™äº›ä¸»é¢˜çš„æ¶ˆæ¯å¹¶å°†å®ƒä»¬è½¬å‘åˆ°ä¸‹æ¸¸å¤„ç†å™¨ã€‚

> **Sinkå¤„ç†å™¨**ï¼šsinkå¤„ç†å™¨æ˜¯ä¸€ä¸ªæ²¡æœ‰ä¸‹æ¸¸æµå¤„ç†å™¨çš„ç‰¹æ®Šç±»å‹çš„æµå¤„ç†å™¨ã€‚å®ƒæ¥æ”¶ä¸Šæ¸¸æµå¤„ç†å™¨çš„æ¶ˆæ¯å‘é€åˆ°ä¸€ä¸ªæŒ‡å®šçš„**Kafkaä¸»é¢˜**ã€‚

![image-20210731090727323](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131559334.png)

### KStream

> ï¼ˆ1ï¼‰æ•°æ®ç»“æ„ç±»ä¼¼äºmap,å¦‚ä¸‹å›¾ï¼Œkey-valueé”®å€¼å¯¹
>

![image-20210731090746415](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131559341.png)

> ï¼ˆ2ï¼‰KStream
>

![image-20210730201817959](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131559805.png)

> **KStream**æ•°æ®æµï¼ˆdata streamï¼‰ï¼Œå³æ˜¯ä¸€æ®µé¡ºåºçš„ï¼Œå¯ä»¥æ— é™é•¿ï¼Œä¸æ–­æ›´æ–°çš„æ•°æ®é›†ã€‚æ•°æ®æµä¸­æ¯”è¾ƒå¸¸è®°å½•çš„æ˜¯äº‹ä»¶ï¼Œè¿™äº›äº‹ä»¶å¯ä»¥æ˜¯ä¸€æ¬¡é¼ æ ‡ç‚¹å‡»ï¼ˆclickï¼‰ï¼Œä¸€æ¬¡äº¤æ˜“ï¼Œæˆ–æ˜¯ä¼ æ„Ÿå™¨è®°å½•çš„ä½ç½®æ•°æ®ã€‚

> KStreamè´Ÿè´£æŠ½è±¡çš„ï¼Œå°±æ˜¯æ•°æ®æµã€‚ä¸Kafkaè‡ªèº«topicä¸­çš„æ•°æ®ä¸€æ ·ï¼Œç±»ä¼¼æ—¥å¿—ï¼Œæ¯ä¸€æ¬¡æ“ä½œéƒ½æ˜¯**å‘å…¶ä¸­æ’å…¥ï¼ˆinsertï¼‰æ–°æ•°æ®ã€‚**
>

> ä¸ºäº†è¯´æ˜è¿™ä¸€ç‚¹ï¼Œä»¥ä¸‹ä¸¤ä¸ªæ•°æ®è®°å½•æ­£åœ¨å‘é€åˆ°æµä¸­ï¼šï¼ˆâ€œ aliceâ€ï¼Œ1ï¼‰->ï¼ˆâ€œâ€ aliceâ€œï¼Œ3ï¼‰
>

> å¦‚æœæ‚¨çš„æµå¤„ç†åº”ç”¨æ˜¯è¦æ€»ç»“æ¯ä¸ªç”¨æˆ·çš„ä»·å€¼ï¼Œå®ƒå°†è¿”å›`4`äº†`alice`ã€‚ä¸ºä»€ä¹ˆï¼Ÿå› ä¸ºç¬¬äºŒæ¡æ•°æ®è®°å½•å°†ä¸è¢«è§†ä¸ºå…ˆå‰è®°å½•çš„æ›´æ–°ã€‚ï¼ˆinsertï¼‰æ–°æ•°æ®
>

### Kafka Streamå…¥é—¨æ¡ˆä¾‹

> ï¼ˆ1ï¼‰éœ€æ±‚åˆ†æï¼Œæ±‚å•è¯ä¸ªæ•°ï¼ˆword countï¼‰
>

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230702194307294.png" alt="image-20230702194307294" style="zoom:80%;" />

> ï¼ˆ2ï¼‰å¼•å…¥ä¾èµ–ï¼Œåœ¨ä¹‹å‰çš„kafka-demoå·¥ç¨‹çš„pomæ–‡ä»¶ä¸­å¼•å…¥
>

```xml
<dependency>
    <groupId>org.apache.kafka</groupId>
    <artifactId>kafka-streams</artifactId>
    <exclusions>
        <exclusion>
            <artifactId>connect-json</artifactId>
            <groupId>org.apache.kafka</groupId>
        </exclusion>
        <exclusion>
            <groupId>org.apache.kafka</groupId>
            <artifactId>kafka-clients</artifactId>
        </exclusion>
    </exclusions>
</dependency>
```

> (3)åˆ›å»ºåŸç”Ÿçš„kafka stareamå…¥é—¨æ¡ˆä¾‹
>

```java
package com.heima.kafka.sample;

import org.apache.kafka.common.serialization.Serdes;
import org.apache.kafka.streams.KafkaStreams;
import org.apache.kafka.streams.KeyValue;
import org.apache.kafka.streams.StreamsBuilder;
import org.apache.kafka.streams.StreamsConfig;
import org.apache.kafka.streams.kstream.KStream;
import org.apache.kafka.streams.kstream.TimeWindows;
import org.apache.kafka.streams.kstream.ValueMapper;
import java.time.Duration;
import java.util.Arrays;
import java.util.Properties;

// æµå¼å¤„ç†
public class KafkaStreamQuickStart {

    public static void main(String[] args) {

        //kafkaçš„é…ç½®ä¿¡å¿ƒ
        Properties prop = new Properties();
        prop.put(StreamsConfig.BOOTSTRAP_SERVERS_CONFIG,"192.168.88.101:9092");
        prop.put(StreamsConfig.DEFAULT_KEY_SERDE_CLASS_CONFIG, 
                 Serdes.String().getClass());
        prop.put(StreamsConfig.DEFAULT_VALUE_SERDE_CLASS_CONFIG, 
                 Serdes.String().getClass());
        prop.put(StreamsConfig.APPLICATION_ID_CONFIG,"streams-quickstart");

        //stream æ„å»ºå™¨
        StreamsBuilder streamsBuilder = new StreamsBuilder();

        //æµå¼è®¡ç®—
        streamProcessor(streamsBuilder);

        //åˆ›å»ºkafkaStreamå¯¹è±¡
        KafkaStreams kafkaStreams = new KafkaStreams(streamsBuilder.build(),prop);
        //å¼€å¯æµå¼è®¡ç®—
        kafkaStreams.start();
    }

    /**
     * æµå¼è®¡ç®—
     * æ¶ˆæ¯çš„å†…å®¹ï¼šhello kafka  hello itcast
     * @param streamsBuilder
     */
    private static void streamProcessor(StreamsBuilder streamsBuilder) {
        //åˆ›å»ºkstreamå¯¹è±¡ï¼ŒåŒæ—¶æŒ‡å®šä»é‚£ä¸ªtopicä¸­æ¥æ”¶æ¶ˆæ¯
        KStream<String, String> stream = streamsBuilder.stream("itcast-topic-input");
        // å¤„ç†æ¶ˆæ¯çš„value
        stream.flatMapValues(new ValueMapper<String, Iterable<String>>() {
            @Override
            public Iterable<String> apply(String value) {
                return Arrays.asList(value.split(" "));
            }
        })
                //æŒ‰ç…§valueè¿›è¡Œèšåˆå¤„ç†
                .groupBy((key,value)->value)
                //æ—¶é—´çª—å£
                .windowedBy(TimeWindows.of(Duration.ofSeconds(10)))
                //ç»Ÿè®¡å•è¯çš„ä¸ªæ•°
                .count()
                //è½¬æ¢ä¸ºkStream
                .toStream()
                .map((key,value)->{
                    System.out.println("key:"+key+",vlaue:"+value);
                    return new KeyValue<>(key.key().toString(),value.toString());
                })
                //å‘é€æ¶ˆæ¯
                .to("itcast-topic-out");
    }
}
```

> (4)æµ‹è¯•å‡†å¤‡

> - ä½¿ç”¨ç”Ÿäº§è€…åœ¨topicä¸ºï¼šitcast_topic_inputä¸­å‘é€å¤šæ¡æ¶ˆæ¯

```java
@SpringBootTest
public class kafkaTest {

    @Autowired
    private KafkaTemplate<String,String> kafkaTemplate;
    
    @Test
    public void testSend() {
        for (int i = 0; i < 5; i++) {
            kafkaTemplate.send("itcast_topic_input","é»‘é©¬ç¨‹åºå‘˜");
        }
    }
}
```

> - ä½¿ç”¨æ¶ˆè´¹è€…æ¥æ”¶topicä¸ºï¼šitcast_topic_out

```java
@Component
public class HelloListener {

    @KafkaListener(topics = "itcast_topic_out")
    public void onMessage1(String message){
        if(!StringUtils.isEmpty(message)){
            User user = JSON.parseObject(message, User.class);
            System.out.println(user);
        }
    }
}
```

> - ç»“æœï¼šé€šè¿‡æµå¼è®¡ç®—ï¼Œä¼šæŠŠç”Ÿäº§è€…çš„å¤šæ¡æ¶ˆæ¯æ±‡æ€»æˆä¸€æ¡å‘é€åˆ°æ¶ˆè´¹è€…ä¸­è¾“å‡º

### SpringBooté›†æˆKafka Stream

> kafka-demoæ¨¡å—æ“ä½œ

> ï¼ˆ1ï¼‰è‡ªå®šé…ç½®å‚æ•°
>

```java
package com.heima.kafka.config;

import lombok.Getter;
import lombok.Setter;
import org.apache.kafka.clients.consumer.ConsumerConfig;
import org.apache.kafka.common.serialization.Serdes;
import org.apache.kafka.streams.StreamsConfig;
import org.apache.kafka.streams.Topology;
import org.springframework.boot.context.properties.ConfigurationProperties;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.kafka.annotation.EnableKafkaStreams;
import org.springframework.kafka.annotation.KafkaStreamsDefaultConfiguration;
import org.springframework.kafka.config.KafkaStreamsConfiguration;
import java.util.HashMap;
import java.util.Map;

// é€šè¿‡é‡æ–°æ³¨å†ŒKafkaStreamsConfigurationå¯¹è±¡ï¼Œè®¾ç½®è‡ªå®šé…ç½®å‚æ•°
@Setter
@Getter
@Configuration
@EnableKafkaStreams
@ConfigurationProperties(prefix="kafka")
public class KafkaStreamConfig {
    private static final int MAX_MESSAGE_SIZE = 16* 1024 * 1024;
    private String hosts;
    private String group;
    @Bean(name = KafkaStreamsDefaultConfiguration.DEFAULT_STREAMS_CONFIG_BEAN_NAME)
    public KafkaStreamsConfiguration defaultKafkaStreamsConfig() {
        Map<String, Object> props = new HashMap<>();
        props.put(StreamsConfig.BOOTSTRAP_SERVERS_CONFIG, hosts);
        props.put(StreamsConfig.APPLICATION_ID_CONFIG, this.getGroup()+"_stream_aid");
        props.put(StreamsConfig.CLIENT_ID_CONFIG, this.getGroup()+"_stream_cid");
        props.put(StreamsConfig.RETRIES_CONFIG, 10);
        props.put(StreamsConfig.DEFAULT_KEY_SERDE_CLASS_CONFIG, 
                  Serdes.String().getClass());
        props.put(StreamsConfig.DEFAULT_VALUE_SERDE_CLASS_CONFIG, 
                  Serdes.String().getClass());
        return new KafkaStreamsConfiguration(props);
    }
}
```

> ä¿®æ”¹application.ymlæ–‡ä»¶ï¼Œåœ¨æœ€ä¸‹æ–¹æ·»åŠ è‡ªå®šä¹‰é…ç½®
>

```yaml
kafka:
  hosts: 192.168.88.101:9092
  group: ${spring.application.name}
```

> (2)æ–°å¢é…ç½®ç±»ï¼Œåˆ›å»ºKStreamå¯¹è±¡ï¼Œè¿›è¡Œèšåˆ
>

```java
package com.heima.kafka.stream;

import lombok.extern.slf4j.Slf4j;
import org.apache.kafka.streams.KeyValue;
import org.apache.kafka.streams.StreamsBuilder;
import org.apache.kafka.streams.kstream.KStream;
import org.apache.kafka.streams.kstream.TimeWindows;
import org.apache.kafka.streams.kstream.ValueMapper;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import java.time.Duration;
import java.util.Arrays;

@Configuration
@Slf4j
public class KafkaStreamHelloListener {

    @Bean
    public KStream<String,String> kStream(StreamsBuilder streamsBuilder){
        //åˆ›å»ºkstreamå¯¹è±¡ï¼ŒåŒæ—¶æŒ‡å®šä»é‚£ä¸ªtopicä¸­æ¥æ”¶æ¶ˆæ¯
        KStream<String, String> stream = streamsBuilder.stream("itcast-topic-input");
        stream.flatMapValues(new ValueMapper<String, Iterable<String>>() {
            @Override
            public Iterable<String> apply(String value) {
                return Arrays.asList(value.split(" "));
            }
        })
                //æ ¹æ®valueè¿›è¡Œèšåˆåˆ†ç»„
                .groupBy((key,value)->value)
                //èšåˆè®¡ç®—æ—¶é—´é—´éš”
                .windowedBy(TimeWindows.of(Duration.ofSeconds(10)))
                //æ±‚å•è¯çš„ä¸ªæ•°
                .count()
                .toStream()
                //å¤„ç†åçš„ç»“æœè½¬æ¢ä¸ºstringå­—ç¬¦ä¸²
                .map((key,value)->{
                    System.out.println("key:"+key+",value:"+value);
                    return new KeyValue<>(key.key().toString(),value.toString());
                })
                //å‘é€æ¶ˆæ¯
                .to("itcast-topic-out");
        return stream;
    }
}
```

> æµ‹è¯•ï¼šå¯åŠ¨å¾®æœåŠ¡ï¼Œæ­£å¸¸å‘é€æ¶ˆæ¯ï¼Œå¯ä»¥æ­£å¸¸æ¥æ”¶åˆ°æ¶ˆæ¯

```java
@SpringBootTest
public class kafkaTest {

    @Autowired
    private KafkaTemplate<String,String> kafkaTemplate;

    @Test
    public void testSend() {
        for (int i = 0; i < 5; i++) {
            kafkaTemplate.send("itcast_topic_input","é»‘é©¬ç¨‹åºå‘˜");
        }
    }
}
```



## çƒ­ç‚¹æ–‡ç« è®¡ç®—

### æ€è·¯è¯´æ˜

![image-20210621235620854](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131559105.png)

### åŠŸèƒ½å®ç°

> ç”¨æˆ·è¡Œä¸ºï¼ˆé˜…è¯»é‡ï¼Œè¯„è®ºï¼Œç‚¹èµï¼Œæ”¶è—ï¼‰å‘é€æ¶ˆæ¯ï¼Œä»¥é˜…è¯»å’Œç‚¹èµä¸ºä¾‹

> â‘ åœ¨heima-leadnews-behaviorå¾®æœåŠ¡ä¸­é›†æˆkafkaç”Ÿäº§è€…é…ç½®
>

> ä¿®æ”¹nacosï¼Œæ–°å¢å†…å®¹

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230702211122909.png" alt="image-20230702211122909" style="zoom:80%;" />

```yaml
spring:
  application:
    name: leadnews-behavior
  kafka:
    bootstrap-servers: 192.168.88.101:9092
    producer:
      retries: 10
      key-serializer: org.apache.kafka.common.serialization.StringSerializer
      value-serializer: org.apache.kafka.common.serialization.StringSerializer
```

> â‘¡ä¿®æ”¹ApLikesBehaviorServiceImplæ–°å¢å‘é€æ¶ˆæ¯
>

> å®šä¹‰æ¶ˆæ¯å‘é€å°è£…ç±»ï¼šUpdateArticleMess
>

```java
package com.heima.model.mess;

import lombok.Data;

@Data
public class UpdateArticleMess {

    // ä¿®æ”¹æ–‡ç« çš„å­—æ®µç±»å‹
    private UpdateArticleType type;
    // æ–‡ç« ID
    private Long articleId;
    // ä¿®æ”¹æ•°æ®çš„å¢é‡ï¼Œå¯ä¸ºæ­£è´Ÿ
    private Integer add;
    public enum UpdateArticleType{
        COLLECTION,COMMENT,LIKES,VIEWS;
    }
}
```

> topicå¸¸é‡ç±»ï¼š
>

```java
package com.heima.common.constants;

public class HotArticleConstants {

    public static final String HOT_ARTICLE_SCORE_TOPIC="hot.article.score.topic";
   
}
```

> å®Œæ•´ä»£ç å¦‚ä¸‹ï¼š
>

```java
package com.heima.behavior.service.impl;

@Service
@Transactional
@Slf4j
public class ApLikesBehaviorServiceImpl implements ApLikesBehaviorService {

    @Autowired
    private CacheService cacheService;

    @Autowired
    private KafkaTemplate<String,String> kafkaTemplate;

    @Override
    public ResponseResult like(LikesBehaviorDto dto) {

        //1.æ£€æŸ¥å‚æ•°
        if (dto == null || dto.getArticleId() == null || checkParam(dto)) {
            return ResponseResult.errorResult(AppHttpCodeEnum.PARAM_INVALID);
        }

        //2.æ˜¯å¦ç™»å½•
        ApUser user = AppThreadLocalUtil.getUser();
        if (user == null) {
            return ResponseResult.errorResult(AppHttpCodeEnum.NEED_LOGIN);
        }

        UpdateArticleMess mess = new UpdateArticleMess();
        mess.setArticleId(dto.getArticleId());
        mess.setType(UpdateArticleMess.UpdateArticleType.LIKES);

        //3.ç‚¹èµ  ä¿å­˜æ•°æ®
        if (dto.getOperation() == 0) {
            Object obj = cacheService.hGet(BehaviorConstants.LIKE_BEHAVIOR + 
                                           dto.getArticleId().toString(), 
                                           user.getId().toString());
            if (obj != null) {
                return ResponseResult.errorResult(AppHttpCodeEnum.PARAM_INVALID, 
                                                  "å·²ç‚¹èµ");
            }
            // ä¿å­˜å½“å‰key
            log.info("ä¿å­˜å½“å‰key:{} ,{}, {}", dto.getArticleId(), user.getId(), dto);
            cacheService.hPut(BehaviorConstants.LIKE_BEHAVIOR + 
                              dto.getArticleId().toString(), 
                              user.getId().toString(), JSON.toJSONString(dto));
            mess.setAdd(1);
        } else {
            // åˆ é™¤å½“å‰key
            log.info("åˆ é™¤å½“å‰key:{}, {}", dto.getArticleId(), user.getId());
            cacheService.hDelete(BehaviorConstants.LIKE_BEHAVIOR +
                                 dto.getArticleId().toString(), 
                                 user.getId().toString());
            mess.setAdd(-1);
        }

        //å‘é€æ¶ˆæ¯ï¼Œæ•°æ®èšåˆ
        kafkaTemplate.send(HotArticleConstants.
                           HOT_ARTICLE_SCORE_TOPIC,JSON.toJSONString(mess));
        return ResponseResult.okResult(AppHttpCodeEnum.SUCCESS);
    }

    // æ£€æŸ¥å‚æ•°
    private boolean checkParam(LikesBehaviorDto dto) {
        if (dto.getType() > 2 || dto.getType() < 0 || dto.getOperation() > 1 || 
            dto.getOperation() < 0) {
            return true;
        }
        return false;
    }
}
```

> â‘¢ä¿®æ”¹é˜…è¯»è¡Œä¸ºçš„ç±»ApReadBehaviorServiceImplå‘é€æ¶ˆæ¯
>

> å®Œæ•´ä»£ç ï¼š
>

```java
package com.heima.behavior.service.impl;

@Service
@Transactional
@Slf4j
public class ApReadBehaviorServiceImpl implements ApReadBehaviorService {

    @Autowired
    private CacheService cacheService;

    @Autowired
    private KafkaTemplate<String,String> kafkaTemplate;

    @Override
    public ResponseResult readBehavior(ReadBehaviorDto dto) {
        //1.æ£€æŸ¥å‚æ•°
        if (dto == null || dto.getArticleId() == null) {
            return ResponseResult.errorResult(AppHttpCodeEnum.PARAM_INVALID);
        }
        //2.æ˜¯å¦ç™»å½•
        ApUser user = AppThreadLocalUtil.getUser();
        if (user == null) {
            return ResponseResult.errorResult(AppHttpCodeEnum.NEED_LOGIN);
        }
        //æ›´æ–°é˜…è¯»æ¬¡æ•°
        String readBehaviorJson = (String) cacheService.hGet(BehaviorConstants
                                  .READ_BEHAVIOR + dto.getArticleId().toString(), 
                                   user.getId().toString());
        if (StringUtils.isNotBlank(readBehaviorJson)) {
            ReadBehaviorDto readBehaviorDto = JSON.parseObject(readBehaviorJson, 
                                                               ReadBehaviorDto.class);
            dto.setCount((short) (readBehaviorDto.getCount() + dto.getCount()));
        }
        // ä¿å­˜å½“å‰key
        log.info("ä¿å­˜å½“å‰key:{} {} {}", dto.getArticleId(), user.getId(), dto);
        cacheService.hPut(BehaviorConstants.READ_BEHAVIOR + 
                          dto.getArticleId().toString(), user.getId().toString(), 
                          JSON.toJSONString(dto));

        //å‘é€æ¶ˆæ¯ï¼Œæ•°æ®èšåˆ
        UpdateArticleMess mess = new UpdateArticleMess();
        mess.setArticleId(dto.getArticleId());
        mess.setType(UpdateArticleMess.UpdateArticleType.VIEWS);
        mess.setAdd(1);
        kafkaTemplate.send(HotArticleConstants.HOT_ARTICLE_SCORE_TOPIC,
                           JSON.toJSONString(mess));
        return ResponseResult.okResult(AppHttpCodeEnum.SUCCESS);
    }
}
```

> ä½¿ç”¨kafkaStreamå®æ—¶æ¥æ”¶æ¶ˆæ¯ï¼Œèšåˆå†…å®¹

> â‘ åœ¨leadnews-articleå¾®æœåŠ¡ä¸­é›†æˆkafkaStream (å‚è€ƒkafka-demo)
>

> â‘¡å®šä¹‰å®ä½“ç±»ï¼Œç”¨äºèšåˆä¹‹åçš„åˆ†å€¼å°è£…
>

```java
package com.heima.model.article.mess;

import lombok.Data;

@Data
public class ArticleVisitStreamMess {
    // æ–‡ç« id
    private Long articleId;
    // é˜…è¯»
    private int view;
    // æ”¶è—
    private int collect;
    // è¯„è®º
    private int comment;
    // ç‚¹èµ
    private int like;
}
```

> ä¿®æ”¹å¸¸é‡ç±»ï¼šå¢åŠ å¸¸é‡
>

```java
package com.heima.common.constans;

public class HotArticleConstants {

    public static final String HOT_ARTICLE_SCORE_TOPIC="hot.article.score.topic";
    public static final String 
        HOT_ARTICLE_INCR_HANDLE_TOPIC="hot.article.incr.handle.topic";
}
```

> â‘¢ å®šä¹‰stream,æ¥æ”¶æ¶ˆæ¯å¹¶èšåˆ
>

```java
package com.heima.article.stream;

@Configuration
@Slf4j
public class HotArticleStreamHandler {

    @Bean
    public KStream<String,String> kStream(StreamsBuilder streamsBuilder){
        //æ¥æ”¶æ¶ˆæ¯
        KStream<String,String> stream = streamsBuilder
            .stream(HotArticleConstants.HOT_ARTICLE_SCORE_TOPIC);
        //èšåˆæµå¼å¤„ç†
        stream.map((key,value)->{
            UpdateArticleMess mess = JSON.parseObject(value, UpdateArticleMess.class);
            //é‡ç½®æ¶ˆæ¯çš„key:1234343434   å’Œ  value: likes:1
            return new KeyValue<>(mess.getArticleId().toString()
                                  ,mess.getType().name()+":"+mess.getAdd());})
                //æŒ‰ç…§æ–‡ç« idè¿›è¡Œèšåˆ
                .groupBy((key,value)->key)
                //æ—¶é—´çª—å£
                .windowedBy(TimeWindows.of(Duration.ofSeconds(10)))
                // è‡ªè¡Œçš„å®Œæˆèšåˆçš„è®¡ç®—
                .aggregate(new Initializer<String>() {
                    // åˆå§‹æ–¹æ³•ï¼Œè¿”å›å€¼æ˜¯æ¶ˆæ¯çš„value
                    @Override
                    public String apply() {
                        return "COLLECTION:0,COMMENT:0,LIKES:0,VIEWS:0";
                    }
                    // çœŸæ­£çš„èšåˆæ“ä½œï¼Œè¿”å›å€¼æ˜¯æ¶ˆæ¯çš„value
                }, new Aggregator<String, String, String>() {
                    @Override
                    public String apply(String key, String value, String aggValue) {
                        if(StringUtils.isBlank(value)){
                            return aggValue;
                        }
                        String[] aggAry = aggValue.split(",");
                        int col = 0,com=0,lik=0,vie=0;
                        for (String agg : aggAry) {
                            String[] split = agg.split(":");
                            // è·å¾—åˆå§‹å€¼ï¼Œä¹Ÿæ˜¯æ—¶é—´çª—å£å†…è®¡ç®—ä¹‹åçš„å€¼
                            switch (UpdateArticleMess
                                    .UpdateArticleType.valueOf(split[0])){
                                case COLLECTION:
                                    col = Integer.parseInt(split[1]);
                                    break;
                                case COMMENT:
                                    com = Integer.parseInt(split[1]);
                                    break;
                                case LIKES:
                                    lik = Integer.parseInt(split[1]);
                                    break;
                                case VIEWS:
                                    vie = Integer.parseInt(split[1]);
                                    break;
                            }
                        }
                        // ç´¯åŠ æ“ä½œ
                        String[] valAry = value.split(":");
                        switch (UpdateArticleMess.UpdateArticleType.valueOf(valAry[0])){
                            case COLLECTION:
                                col += Integer.parseInt(valAry[1]);
                                break;
                            case COMMENT:
                                com += Integer.parseInt(valAry[1]);
                                break;
                            case LIKES:
                                lik += Integer.parseInt(valAry[1]);
                                break;
                            case VIEWS:
                                vie += Integer.parseInt(valAry[1]);
                                break;
                        }

                        String formatStr = String
                            .format("COLLECTION:%d,COMMENT:%d,LIKES:%d,VIEWS:%d", 
                                                         col, com, lik, vie);
                        System.out.println("æ–‡ç« çš„id:"+key);
                        System.out.println("å½“å‰æ—¶é—´çª—å£å†…çš„æ¶ˆæ¯å¤„ç†ç»“æœï¼š"+formatStr);
                        return formatStr;
                    }
                }, Materialized.as("hot-atricle-stream-count-001"))
                .toStream()
                .map((key,value)->{
                    return new KeyValue<>(key.key().toString(),
                                          formatObj(key.key().toString(),value));
                })
                //å‘é€æ¶ˆæ¯
                .to(HotArticleConstants.HOT_ARTICLE_INCR_HANDLE_TOPIC);
        return stream;
    }

    // æ ¼å¼åŒ–æ¶ˆæ¯çš„valueæ•°æ®
    public String formatObj(String articleId,String value){
        ArticleVisitStreamMess mess = new ArticleVisitStreamMess();
        mess.setArticleId(Long.valueOf(articleId));
        //COLLECTION:0,COMMENT:0,LIKES:0,VIEWS:0
        String[] valAry = value.split(",");
        for (String val : valAry) {
            String[] split = val.split(":");
            switch (UpdateArticleMess.UpdateArticleType.valueOf(split[0])){
                case COLLECTION:
                    mess.setCollect(Integer.parseInt(split[1]));
                    break;
                case COMMENT:
                    mess.setComment(Integer.parseInt(split[1]));
                    break;
                case LIKES:
                    mess.setLike(Integer.parseInt(split[1]));
                    break;
                case VIEWS:
                    mess.setView(Integer.parseInt(split[1]));
                    break;
            }
        }
        log.info("èšåˆæ¶ˆæ¯å¤„ç†ä¹‹åçš„ç»“æœä¸º:{}",JSON.toJSONString(mess));
        return JSON.toJSONString(mess);
    }
}
```

> é‡æ–°è®¡ç®—æ–‡ç« çš„åˆ†å€¼ï¼Œæ›´æ–°åˆ°æ•°æ®åº“å’Œç¼“å­˜ä¸­

> â‘ åœ¨ApArticleServiceæ·»åŠ æ–¹æ³•ï¼Œç”¨äºæ›´æ–°æ•°æ®åº“ä¸­çš„æ–‡ç« åˆ†å€¼
>

```java
// æ›´æ–°æ–‡ç« çš„åˆ†å€¼  åŒæ—¶æ›´æ–°ç¼“å­˜ä¸­çš„çƒ­ç‚¹æ–‡ç« æ•°æ®
public void updateScore(ArticleVisitStreamMess mess);
```

> å®ç°ç±»æ–¹æ³•
>

```java
// æ›´æ–°æ–‡ç« çš„åˆ†å€¼  åŒæ—¶æ›´æ–°ç¼“å­˜ä¸­çš„çƒ­ç‚¹æ–‡ç« æ•°æ®
@Override
public void updateScore(ArticleVisitStreamMess mess) {
    //1.æ›´æ–°æ–‡ç« çš„é˜…è¯»ã€ç‚¹èµã€æ”¶è—ã€è¯„è®ºçš„æ•°é‡
    ApArticle apArticle = updateArticle(mess);
    //2.è®¡ç®—æ–‡ç« çš„åˆ†å€¼
    Integer score = computeScore(apArticle);
    score = score * 3;

    //3.æ›¿æ¢å½“å‰æ–‡ç« å¯¹åº”é¢‘é“çš„çƒ­ç‚¹æ•°æ®
    replaceDataToRedis(apArticle, score, ArticleConstants.HOT_ARTICLE_FIRST_PAGE + apArticle.getChannelId());

    //4.æ›¿æ¢æ¨èå¯¹åº”çš„çƒ­ç‚¹æ•°æ®
    replaceDataToRedis(apArticle, score, ArticleConstants.HOT_ARTICLE_FIRST_PAGE + ArticleConstants.DEFAULT_TAG);

}

// æ›¿æ¢æ•°æ®å¹¶ä¸”å­˜å…¥åˆ°redis
private void replaceDataToRedis(ApArticle apArticle, Integer score, String s) {
    String articleListStr = cacheService.get(s);
    if (StringUtils.isNotBlank(articleListStr)) {
        List<HotArticleVo> hotArticleVoList = JSON.parseArray(articleListStr, 
                                                              HotArticleVo.class);
        boolean flag = true;
        //å¦‚æœç¼“å­˜ä¸­å­˜åœ¨è¯¥æ–‡ç« ï¼Œåªæ›´æ–°åˆ†å€¼
        for (HotArticleVo hotArticleVo : hotArticleVoList) {
            if (hotArticleVo.getId().equals(apArticle.getId())) {
                hotArticleVo.setScore(score);
                flag = false;
                break;
            }
        }
        //å¦‚æœç¼“å­˜ä¸­ä¸å­˜åœ¨ï¼ŒæŸ¥è¯¢ç¼“å­˜ä¸­åˆ†å€¼æœ€å°çš„ä¸€æ¡æ•°æ®ï¼Œè¿›è¡Œåˆ†å€¼çš„æ¯”è¾ƒï¼Œ
        // å¦‚æœå½“å‰æ–‡ç« çš„åˆ†å€¼å¤§äºç¼“å­˜ä¸­çš„æ•°æ®ï¼Œå°±æ›¿æ¢
        if (flag) {
            if (hotArticleVoList.size() >= 30) {
                hotArticleVoList = hotArticleVoList.stream()
                    .sorted(Comparator.comparing(HotArticleVo::getScore)
                            .reversed()).collect(Collectors.toList());
                HotArticleVo lastHot = hotArticleVoList.get(hotArticleVoList.size()- 1);
                if (lastHot.getScore() < score) {
                    hotArticleVoList.remove(lastHot);
                    HotArticleVo hot = new HotArticleVo();
                    BeanUtils.copyProperties(apArticle, hot);
                    hot.setScore(score);
                    hotArticleVoList.add(hot);
                }


            } else {
                HotArticleVo hot = new HotArticleVo();
                BeanUtils.copyProperties(apArticle, hot);
                hot.setScore(score);
                hotArticleVoList.add(hot);
            }
        }
        //ç¼“å­˜åˆ°redis
        hotArticleVoList = hotArticleVoList.stream().sorted(Comparator                                                   .comparing(HotArticleVo::getScore)
                                                            .reversed())
            .collect(Collectors.toList());
        cacheService.set(s, JSON.toJSONString(hotArticleVoList));

    }
}

// æ›´æ–°æ–‡ç« è¡Œä¸ºæ•°é‡
private ApArticle updateArticle(ArticleVisitStreamMess mess) {
    ApArticle apArticle = getById(mess.getArticleId());
    apArticle.setCollection(apArticle.getCollection()==null?
                            0:apArticle.getCollection()+mess.getCollect());
    apArticle.setComment(apArticle.getComment()==null?
                         0:apArticle.getComment()+mess.getComment());
    apArticle.setLikes(apArticle.getLikes()==null?
                       0:apArticle.getLikes()+mess.getLike());
    apArticle.setViews(apArticle.getViews()==null?
                       0:apArticle.getViews()+mess.getView());
    updateById(apArticle);
    return apArticle;
}

// è®¡ç®—æ–‡ç« çš„å…·ä½“åˆ†å€¼
private Integer computeScore(ApArticle apArticle) {
    Integer score = 0;
    if(apArticle.getLikes() != null){
        score += apArticle.getLikes() * ArticleConstants.HOT_ARTICLE_LIKE_WEIGHT;
    }
    if(apArticle.getViews() != null){
        score += apArticle.getViews();
    }
    if(apArticle.getComment() != null){
        score += apArticle.getComment() * ArticleConstants.HOT_ARTICLE_COMMENT_WEIGHT;
    }
    if(apArticle.getCollection() != null){
        score += apArticle.getCollection() * 
            ArticleConstants.HOT_ARTICLE_COLLECTION_WEIGHT;
    }
    return score;
}
```

> â‘¡å®šä¹‰ç›‘å¬ï¼Œæ¥æ”¶èšåˆä¹‹åçš„æ•°æ®ï¼Œæ–‡ç« çš„åˆ†å€¼é‡æ–°è¿›è¡Œè®¡ç®—
>

```java
package com.heima.article.listener;

@Component
@Slf4j
public class ArticleIncrHandleListener {

    @Autowired
    private ApArticleService apArticleService;

    @KafkaListener(topics = HotArticleConstants.HOT_ARTICLE_INCR_HANDLE_TOPIC)
    public void onMessage(String mess){
        if(StringUtils.isNotBlank(mess)){
            ArticleVisitStreamMess articleVisitStreamMess = 
                JSON.parseObject(mess,                                                                   ArticleVisitStreamMess.class);
            apArticleService.updateScore(articleVisitStreamMess);

        }
    }
}
```

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230702213241592.png" alt="image-20230702213241592" style="zoom:80%;" />

# é¡¹ç›®éƒ¨ç½²_æŒç»­é›†æˆ

## ä»Šæ—¥å†…å®¹ä»‹ç»

### ä»€ä¹ˆæ˜¯æŒç»­é›†æˆ

> æŒç»­é›†æˆï¼ˆ Continuous integration ï¼Œ ç®€ç§° CI ï¼‰æŒ‡çš„æ˜¯ï¼Œé¢‘ç¹åœ°ï¼ˆä¸€å¤©å¤šæ¬¡ï¼‰å°†ä»£ç é›†æˆåˆ°ä¸»å¹²
>

![image-20210802000658790](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131559767.png)

**æŒç»­é›†æˆçš„ç»„æˆè¦ç´ **

> ä¸€ä¸ªè‡ªåŠ¨æ„å»ºè¿‡ç¨‹ï¼Œ ä»æ£€å‡ºä»£ç ã€ ç¼–è¯‘æ„å»ºã€ è¿è¡Œæµ‹è¯•ã€ ç»“æœè®°å½•ã€ æµ‹è¯•ç»Ÿè®¡ç­‰éƒ½æ˜¯è‡ªåŠ¨å®Œæˆçš„ï¼Œ æ— éœ€äººå·¥å¹²é¢„ã€‚ä¸€ä¸ªä»£ç å­˜å‚¨åº“ï¼Œå³éœ€è¦ç‰ˆæœ¬æ§åˆ¶è½¯ä»¶æ¥ä¿éšœä»£ç çš„å¯ç»´æŠ¤æ€§ï¼ŒåŒæ—¶ä½œä¸ºæ„å»ºè¿‡ç¨‹çš„ç´ æåº“ï¼Œä¸€èˆ¬ä½¿ç”¨SVNæˆ–Gitã€‚ä¸€ä¸ªæŒç»­é›†æˆæœåŠ¡å™¨ï¼Œ Jenkins å°±æ˜¯ä¸€ä¸ªé…ç½®ç®€å•å’Œä½¿ç”¨æ–¹ä¾¿çš„æŒç»­é›†æˆæœåŠ¡å™¨ã€‚
>

### æŒç»­é›†æˆçš„å¥½å¤„

> 1ã€é™ä½é£é™©ï¼Œç”±äºæŒç»­é›†æˆä¸æ–­å»æ„å»ºï¼Œç¼–è¯‘å’Œæµ‹è¯•ï¼Œå¯ä»¥å¾ˆæ—©æœŸå‘ç°é—®é¢˜ï¼Œæ‰€ä»¥ä¿®å¤çš„ä»£ä»·å°±å°‘ï¼›
> 2ã€å¯¹ç³»ç»Ÿå¥åº·æŒç»­æ£€æŸ¥ï¼Œå‡å°‘å‘å¸ƒé£é™©å¸¦æ¥çš„é—®é¢˜ï¼›
> 3ã€å‡å°‘é‡å¤æ€§å·¥ä½œï¼›
> 4ã€æŒç»­éƒ¨ç½²ï¼Œæä¾›å¯éƒ¨ç½²å•å…ƒåŒ…ï¼›
> 5ã€æŒç»­äº¤ä»˜å¯ä¾›ä½¿ç”¨çš„ç‰ˆæœ¬ï¼›
> 6ã€å¢å¼ºå›¢é˜Ÿä¿¡å¿ƒï¼›

### ä»Šæ—¥å†…å®¹

![image-20210802000829722](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131559784.png)



## è½¯ä»¶å¼€å‘æ¨¡å¼

### è½¯ä»¶å¼€å‘ç”Ÿå‘½å‘¨æœŸ

> è½¯ä»¶å¼€å‘ç”Ÿå‘½å‘¨æœŸåˆå«åšSDLCï¼ˆSoftware Development Life Cycleï¼‰ï¼Œå®ƒæ˜¯é›†åˆäº†è®¡åˆ’ã€å¼€å‘ã€æµ‹è¯•å’Œéƒ¨ç½²è¿‡ç¨‹çš„é›†åˆã€‚å¦‚ä¸‹å›¾æ‰€ç¤º ï¼š
>

![image-20210802011508487](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131559787.png)

#### éœ€æ±‚åˆ†æ

> è¿™æ˜¯ç”Ÿå‘½å‘¨æœŸçš„ç¬¬ä¸€é˜¶æ®µï¼Œæ ¹æ®é¡¹ç›®éœ€æ±‚ï¼Œå›¢é˜Ÿæ‰§è¡Œä¸€ä¸ªå¯è¡Œæ€§è®¡åˆ’çš„åˆ†æã€‚é¡¹ç›®éœ€æ±‚å¯èƒ½æ˜¯å…¬å¸å†…éƒ¨æˆ–è€…å®¢æˆ·æå‡ºçš„ã€‚è¿™é˜¶æ®µä¸»è¦æ˜¯å¯¹ä¿¡æ¯çš„æ”¶é›†ï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯å¯¹ç°æœ‰é¡¹ç›®çš„æ”¹å–„å’Œé‡æ–°åšä¸€ä¸ªæ–°çš„é¡¹ç›®ã€‚è¿˜è¦åˆ†æé¡¹ç›®çš„é¢„ç®—å¤šé•¿ï¼Œå¯ä»¥ä»å“ªæ–¹é¢å—ç›ŠåŠå¸ƒå±€ï¼Œè¿™ä¹Ÿæ˜¯é¡¹ç›®åˆ›å»ºçš„ç›®æ ‡ã€‚

#### è®¾è®¡

> ç¬¬äºŒé˜¶æ®µå°±æ˜¯è®¾è®¡é˜¶æ®µï¼Œç³»ç»Ÿæ¶æ„å’Œæ»¡æ„çŠ¶æ€ï¼ˆå°±æ˜¯è¦åšæˆä»€ä¹ˆæ ·å­ï¼Œæœ‰ä»€ä¹ˆåŠŸèƒ½ï¼‰ï¼Œå’Œåˆ›å»ºä¸€ä¸ªé¡¹ç›®è®¡åˆ’ã€‚è®¡åˆ’å¯ä»¥ä½¿ç”¨å›¾è¡¨ï¼Œå¸ƒå±€è®¾è®¡æˆ–è€…æ–‡å­—çš„æ–¹å¼å‘ˆç°ã€‚

#### å®ç°

> ç¬¬ä¸‰é˜¶æ®µå°±æ˜¯å®ç°é˜¶æ®µï¼Œé¡¹ç›®ç»ç†åˆ›å»ºå’Œåˆ†é…å·¥ä½œç»™å¼€è€…ï¼Œå¼€å‘è€…æ ¹æ®ä»»åŠ¡å’Œåœ¨è®¾è®¡é˜¶æ®µå®šä¹‰çš„ç›®æ ‡è¿›è¡Œå¼€å‘ä»£ç ã€‚ä¾æ®é¡¹ç›®çš„å¤§å°å’Œå¤æ‚ç¨‹åº¦ï¼Œå¯ä»¥éœ€è¦æ•°æœˆæˆ–æ›´é•¿æ—¶é—´æ‰èƒ½å®Œæˆã€‚

#### æµ‹è¯•

> æµ‹è¯•äººå‘˜è¿›è¡Œä»£ç æµ‹è¯• ï¼ŒåŒ…æ‹¬åŠŸèƒ½æµ‹è¯•ã€ä»£ç æµ‹è¯•ã€å‹åŠ›æµ‹è¯•ç­‰ã€‚

#### è¿›åŒ–

> æœ€åè¿›é˜¶æ®µå°±æ˜¯å¯¹äº§å“ä¸æ–­çš„è¿›åŒ–æ”¹è¿›å’Œç»´æŠ¤é˜¶æ®µï¼Œæ ¹æ®ç”¨æˆ·çš„ä½¿ç”¨æƒ…å†µï¼Œå¯èƒ½éœ€è¦å¯¹æŸåŠŸèƒ½è¿›è¡Œä¿®æ”¹ï¼Œbugä¿®å¤ï¼ŒåŠŸèƒ½å¢åŠ ç­‰ã€‚

### è½¯ä»¶å¼€å‘ç€‘å¸ƒæ¨¡å‹

> ç€‘å¸ƒæ¨¡å‹æ˜¯æœ€è‘—åå’Œæœ€å¸¸ä½¿ç”¨çš„è½¯ä»¶å¼€å‘æ¨¡å‹ã€‚ç€‘å¸ƒæ¨¡å‹å°±æ˜¯ä¸€ç³»åˆ—çš„è½¯ä»¶å¼€å‘è¿‡ç¨‹ã€‚å®ƒæ˜¯ç”±åˆ¶é€ ä¸šç¹è¡å‡ºæ¥çš„ã€‚ä¸€ä¸ªé«˜åº¦åŒ–çš„ç»“æ„æµç¨‹åœ¨ä¸€ä¸ªæ–¹å‘ä¸ŠæµåŠ¨ï¼Œæœ‰ç‚¹åƒç”Ÿäº§çº¿ä¸€æ ·ã€‚åœ¨ç€‘å¸ƒæ¨¡å‹åˆ›å»ºä¹‹åˆï¼Œæ²¡æœ‰å…¶å®ƒå¼€å‘çš„æ¨¡å‹ï¼Œæœ‰å¾ˆå¤šä¸œè¥¿å…¨é å¼€å‘äººå‘˜å»çŒœæµ‹ï¼Œå»å¼€å‘ã€‚è¿™æ ·çš„æ¨¡å‹ä»…é€‚ç”¨äºé‚£äº›ç®€å•çš„è½¯ä»¶å¼€å‘ï¼Œ ä½†æ˜¯å·²ç»ä¸é€‚åˆç°åœ¨çš„å¼€å‘äº†ã€‚
>

> ä¸‹å›¾å¯¹è½¯ä»¶å¼€å‘æ¨¡å‹çš„ä¸€ä¸ªé˜è¿°ã€‚
>

![image-20210802011525024](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131559786.png)

| ä¼˜åŠ¿                                       | åŠ£åŠ¿                                                         |
| ------------------------------------------ | ------------------------------------------------------------ |
| ç®€å•æ˜“ç”¨å’Œç†è§£                             | å„ä¸ªé˜¶æ®µçš„åˆ’åˆ†å®Œå…¨å›ºå®šï¼Œé˜¶æ®µä¹‹é—´äº§ç”Ÿå¤§é‡çš„æ–‡æ¡£ï¼Œæå¤§åœ°å¢åŠ äº†å·¥ä½œé‡ã€‚ |
| å½“å‰ä¸€é˜¶æ®µå®Œæˆåï¼Œæ‚¨åªéœ€è¦å»å…³æ³¨åç»­é˜¶æ®µã€‚ | ç”±äºå¼€å‘æ¨¡å‹æ˜¯çº¿æ€§çš„ï¼Œç”¨æˆ·åªæœ‰ç­‰åˆ°æ•´ä¸ªè¿‡ç¨‹çš„æœ«æœŸæ‰èƒ½è§åˆ°å¼€å‘æˆæœï¼Œä»è€Œå¢åŠ äº†å¼€å‘é£é™©ã€‚ |
| ä¸ºé¡¹ç›®æä¾›äº†æŒ‰é˜¶æ®µåˆ’åˆ†çš„æ£€æŸ¥èŠ‚ç‚¹           | ç€‘å¸ƒæ¨¡å‹çš„çªå‡ºç¼ºç‚¹æ˜¯ä¸é€‚åº”ç”¨æˆ·éœ€æ±‚çš„å˜åŒ–ã€‚                   |

### è½¯ä»¶çš„æ•æ·å¼€å‘

> ä»€ä¹ˆæ˜¯æ•æ·å¼€å‘ï¼Ÿæ•æ·å¼€å‘ï¼ˆAgile Developmentï¼‰ çš„æ ¸å¿ƒæ˜¯è¿­ä»£å¼€å‘ï¼ˆIterative Developmentï¼‰ ä¸ å¢é‡å¼€å‘ï¼ˆIncremental Developmentï¼‰ã€‚

> ä½•ä¸ºè¿­ä»£å¼€å‘ï¼Ÿå¯¹äºå¤§å‹è½¯ä»¶é¡¹ç›®ï¼Œä¼ ç»Ÿçš„å¼€å‘æ–¹å¼æ˜¯é‡‡ç”¨ä¸€ä¸ªå¤§å‘¨æœŸï¼ˆæ¯”å¦‚ä¸€å¹´ï¼‰è¿›è¡Œå¼€å‘ï¼Œæ•´ä¸ªè¿‡ç¨‹å°±æ˜¯ä¸€æ¬¡"å¤§å¼€å‘"ï¼›è¿­ä»£å¼€å‘çš„æ–¹å¼åˆ™ä¸ä¸€æ ·ï¼Œå®ƒå°†å¼€å‘è¿‡ç¨‹æ‹†åˆ†æˆå¤šä¸ªå°å‘¨æœŸï¼Œå³ä¸€æ¬¡"å¤§å¼€å‘"å˜æˆå¤šæ¬¡"å°å¼€å‘"ï¼Œæ¯æ¬¡å°å¼€å‘éƒ½æ˜¯åŒæ ·çš„æµç¨‹ï¼Œæ‰€ä»¥çœ‹ä¸Šå»å°±å¥½åƒé‡å¤åœ¨åšåŒæ ·çš„æ­¥éª¤ã€‚
>

> ä¸¾ä¾‹æ¥è¯´ï¼ŒSpaceX å…¬å¸æƒ³é€ ä¸€ä¸ªå¤§æ¨åŠ›ç«ç®­ï¼Œå°†äººç±»é€åˆ°ç«æ˜Ÿã€‚ä½†æ˜¯ï¼Œå®ƒä¸æ˜¯ä¸€å¼€å§‹å°±é€ å¤§ç«ç®­ï¼Œè€Œæ˜¯å…ˆé€ ä¸€ä¸ªæœ€ç®€é™‹çš„å°ç«ç®­ Falcon 1ã€‚ç»“æœï¼Œç¬¬ä¸€æ¬¡å‘å°„å°±çˆ†ç‚¸äº†ï¼Œç›´åˆ°ç¬¬å››æ¬¡å‘å°„ï¼Œæ‰æˆåŠŸè¿›å…¥è½¨é“ã€‚ç„¶åï¼Œå¼€å‘äº†ä¸­å‹ç«ç®­ Falcon 9ï¼Œä¹å¹´ä¸­å‘å°„äº†70æ¬¡ã€‚æœ€åï¼Œæ‰å¼€å‘ Falcon é‡å‹ç«ç®­ã€‚å¦‚æœSpaceX ä¸é‡‡ç”¨è¿­ä»£å¼€å‘ï¼Œå®ƒå¯èƒ½ç›´åˆ°ç°åœ¨è¿˜æ— æ³•ä¸Šå¤©ã€‚

> ä½•ä¸ºå¢é‡å¼€å‘ï¼Ÿè½¯ä»¶çš„æ¯ä¸ªç‰ˆæœ¬ï¼Œéƒ½ä¼šæ–°å¢ä¸€ä¸ªç”¨æˆ·å¯ä»¥æ„ŸçŸ¥çš„å®Œæ•´åŠŸèƒ½ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒæŒ‰ç…§æ–°å¢åŠŸèƒ½æ¥åˆ’åˆ†è¿­ä»£ã€‚ä¸¾ä¾‹æ¥è¯´ï¼Œæˆ¿äº§å…¬å¸å¼€å‘ä¸€ä¸ª10æ ‹æ¥¼çš„å°åŒºã€‚å¦‚æœé‡‡ç”¨å¢é‡å¼€å‘çš„æ¨¡å¼ï¼Œè¯¥å…¬å¸ç¬¬ä¸€ä¸ªè¿­ä»£å°±æ˜¯äº¤ä»˜ä¸€å·æ¥¼ï¼Œç¬¬äºŒä¸ªè¿­ä»£äº¤ä»˜äºŒå·æ¥¼......æ¯ä¸ªè¿­ä»£éƒ½æ˜¯å®Œæˆä¸€æ ‹å®Œæ•´çš„æ¥¼ã€‚è€Œä¸æ˜¯ç¬¬ä¸€ä¸ªè¿­ä»£æŒ–å¥½10æ ‹æ¥¼çš„åœ°åŸºï¼Œç¬¬äºŒä¸ªè¿­ä»£å»ºå¥½æ¯æ ‹æ¥¼çš„éª¨æ¶ï¼Œç¬¬ä¸‰ä¸ªè¿­ä»£æ¶è®¾å±‹é¡¶......

> æ•æ·å¼€å‘å¦‚ä½•è¿­ä»£ï¼Ÿè™½ç„¶æ•æ·å¼€å‘å°†è½¯ä»¶å¼€å‘åˆ†æˆå¤šä¸ªè¿­ä»£ï¼Œä½†æ˜¯ä¹Ÿè¦æ±‚ï¼Œæ¯æ¬¡è¿­ä»£éƒ½æ˜¯ä¸€ä¸ªå®Œæ•´çš„è½¯ä»¶å¼€å‘å‘¨æœŸï¼Œå¿…é¡»æŒ‰ç…§è½¯ä»¶å·¥ç¨‹çš„æ–¹æ³•è®ºï¼Œè¿›è¡Œæ­£è§„çš„æµç¨‹ç®¡ç†ã€‚

![image-20210802011540379](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131559790.png)

> æ•æ·å¼€å‘æœ‰ä»€ä¹ˆå¥½å¤„ï¼Ÿ
>

> æ—©æœŸäº¤ä»˜:æ•æ·å¼€å‘çš„ç¬¬ä¸€ä¸ªå¥½å¤„ï¼Œå°±æ˜¯æ—©æœŸäº¤ä»˜ï¼Œä»è€Œå¤§å¤§é™ä½æˆæœ¬ã€‚ è¿˜æ˜¯ä»¥ä¸Šä¸€èŠ‚çš„æˆ¿äº§å…¬å¸ä¸ºä¾‹ï¼Œå¦‚æœæŒ‰ç…§ä¼ ç»Ÿçš„"ç€‘å¸ƒå¼€å‘æ¨¡å¼"ï¼Œå…ˆæŒ–10æ ‹æ¥¼çš„åœ°åŸºã€å†ç›–éª¨æ¶ã€ç„¶åæ¶è®¾å±‹é¡¶ï¼Œæ¯ä¸ªé˜¶æ®µéƒ½ç­‰åˆ°å‰ä¸€ä¸ªé˜¶æ®µå®Œæˆåå¼€å§‹ï¼Œå¯èƒ½éœ€è¦ä¸¤å¹´æ‰èƒ½ä¸€æ¬¡æ€§äº¤ä»˜10æ ‹æ¥¼ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœä¸è€ƒè™‘é¢„å”®ï¼Œè¯¥é¡¹ç›®å¿…é¡»ç­‰åˆ°ä¸¤å¹´åæ‰èƒ½å›æ¬¾ã€‚ æ•æ·å¼€å‘æ˜¯å…­ä¸ªæœˆåäº¤ä»˜ä¸€å·æ¥¼ï¼Œåé¢æ¯ä¸¤ä¸ªæœˆäº¤ä»˜ä¸€æ ‹æ¥¼ã€‚å› æ­¤ï¼ŒåŠå¹´å°±èƒ½å›æ¬¾10%ï¼Œåé¢æ¯ä¸ªæœˆéƒ½ä¼šæœ‰ç°é‡‘æµï¼Œèµ„é‡‘å‹åŠ›å°±å¤§å¤§å‡è½»äº†ã€‚

> é™ä½é£é™©:æ•æ·å¼€å‘çš„ç¬¬äºŒä¸ªå¥½å¤„æ˜¯ï¼ŒåŠæ—¶äº†è§£å¸‚åœºéœ€æ±‚ï¼Œé™ä½äº§å“ä¸é€‚ç”¨çš„é£é™©ã€‚ è¯·æƒ³ä¸€æƒ³ï¼Œå“ªä¸€ç§æƒ…å†µæŸå¤±æ¯”è¾ƒå°ï¼š10æ ‹æ¥¼éƒ½é€ å¥½ä»¥åï¼Œæ‰å‘ç°å–ä¸å‡ºå»ï¼Œè¿˜æ˜¯é€ å¥½ç¬¬ä¸€æ ‹æ¥¼ï¼Œå°±å‘ç°å–ä¸å‡ºå»ï¼Œä»è€Œæ”¹è¿›æˆ–åœå»ºåé¢9æ ‹æ¥¼ï¼Ÿ

## Jenkinså®‰è£…é…ç½®

### Jenkinsä»‹ç»

![image-20210802011553923](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131559797.png)

> Jenkins  æ˜¯ä¸€æ¬¾æµè¡Œçš„å¼€æºæŒç»­é›†æˆï¼ˆContinuous Integrationï¼‰å·¥å…·ï¼Œå¹¿æ³›ç”¨äºé¡¹ç›®å¼€å‘ï¼Œå…·æœ‰è‡ªåŠ¨åŒ–æ„å»ºã€æµ‹è¯•å’Œéƒ¨ç½²ç­‰åŠŸèƒ½ã€‚å®˜ç½‘ï¼š  http://jenkins-ci.org/ã€‚
>

Jenkinsçš„ç‰¹å¾ï¼š

> - å¼€æºçš„ Javaè¯­è¨€å¼€å‘æŒç»­é›†æˆå·¥å…·ï¼Œæ”¯æŒæŒç»­é›†æˆï¼ŒæŒç»­éƒ¨ç½²ã€‚
> - æ˜“äºå®‰è£…éƒ¨ç½²é…ç½®ï¼šå¯é€šè¿‡ yumå®‰è£…,æˆ–ä¸‹è½½waråŒ…ä»¥åŠé€šè¿‡dockerå®¹å™¨ç­‰å¿«é€Ÿå®ç°å®‰è£…éƒ¨ç½²ï¼Œå¯æ–¹ä¾¿webç•Œé¢é…ç½®ç®¡ç†ã€‚
> - æ¶ˆæ¯é€šçŸ¥åŠæµ‹è¯•æŠ¥å‘Šï¼šé›†æˆ RSS/E-mailé€šè¿‡RSSå‘å¸ƒæ„å»ºç»“æœæˆ–å½“æ„å»ºå®Œæˆæ—¶é€šè¿‡e-mailé€šçŸ¥ï¼Œç”ŸæˆJUnit/TestNGæµ‹è¯•æŠ¥å‘Šã€‚
> - åˆ†å¸ƒå¼æ„å»ºï¼šæ”¯æŒ Jenkinsèƒ½å¤Ÿè®©å¤šå°è®¡ç®—æœºä¸€èµ·æ„å»º/æµ‹è¯•ã€‚
> - æ–‡ä»¶è¯†åˆ«ï¼š Jenkinsèƒ½å¤Ÿè·Ÿè¸ªå“ªæ¬¡æ„å»ºç”Ÿæˆå“ªäº›jarï¼Œå“ªæ¬¡æ„å»ºä½¿ç”¨å“ªä¸ªç‰ˆæœ¬çš„jarç­‰ã€‚
> - ä¸°å¯Œçš„æ’ä»¶æ”¯æŒï¼šæ”¯æŒæ‰©å±•æ’ä»¶ï¼Œä½ å¯ä»¥å¼€å‘é€‚åˆè‡ªå·±å›¢é˜Ÿä½¿ç”¨çš„å·¥å…·ï¼Œå¦‚ gitï¼Œsvnï¼Œmavenï¼Œdockerç­‰ã€‚

Jenkinså®‰è£…å’ŒæŒç»­é›†æˆç¯å¢ƒé…ç½®

![image-20210802011607894](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131559334.png)

> 1 ï¼‰é¦–å…ˆï¼Œå¼€å‘äººå‘˜æ¯å¤©è¿›è¡Œä»£ç æäº¤ï¼Œæäº¤åˆ°Gitä»“åº“

> 2ï¼‰ç„¶åï¼ŒJenkinsä½œä¸ºæŒç»­é›†æˆå·¥å…·ï¼Œä½¿ç”¨Gitå·¥å…·åˆ°Gitä»“åº“æ‹‰å–ä»£ç åˆ°é›†æˆæœåŠ¡å™¨ï¼Œå†é…åˆJDKï¼ŒMavenç­‰è½¯ä»¶å®Œæˆä»£ç ç¼–è¯‘ï¼Œä»£ç æµ‹è¯•ä¸å®¡æŸ¥ï¼Œæµ‹è¯•ï¼Œæ‰“åŒ…ç­‰å·¥ä½œï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­æ¯ä¸€æ­¥å‡ºé”™ï¼Œéƒ½é‡æ–°å†æ‰§è¡Œä¸€æ¬¡æ•´ä¸ªæµç¨‹ã€‚

> 3ï¼‰æœ€åï¼ŒJenkinsæŠŠç”Ÿæˆçš„jaræˆ–waråŒ…åˆ†å‘åˆ°æµ‹è¯•æœåŠ¡å™¨æˆ–è€…ç”Ÿäº§æœåŠ¡å™¨ï¼Œæµ‹è¯•äººå‘˜æˆ–ç”¨æˆ·å°±å¯ä»¥è®¿é—®åº”ç”¨ã€‚

### Jenkinsç¯å¢ƒæ­å»º

#### JDK17å®‰è£…

1ã€åˆ›å»ºjdkç›®å½•

```sh
mkdir -p /home/jdk
cd /home/jdk
```

2ã€ä¸‹è½½openjdk17å…å®‰è£…åŒ…

```sh
wget https://download.java.net/java/GA/jdk17.0.2/dfd4a8d0985749f896bed50d7138ee7f/8/GPL/openjdk-17.0.2_linux-x64_bin.tar.gz
```

3ã€è§£å‹å®‰è£…åŒ…

```sh
tar zxf openjdk-17.0.2_linux-x64_bin.tar.gz
```

4ã€é…ç½®ç¯å¢ƒå˜é‡

```sh
vim /etc/profile
#åœ¨unset i ä¸Šæ–¹æ’å…¥ä»¥ä¸‹ç¯å¢ƒ å˜é‡
export JAVA_HOME=/home/jdk/jdk-17.0.2/
export CLASSPATH=$JAVA_HOME/lib:$JRE_HOME/lib:$CLASSPATH
export PATH=$JAVA_HOME/bin:$JRE_HOME/bin:$PATH
```

5ã€æ˜¯å˜é‡é©¬ä¸Šç”Ÿæ•ˆ

```sh
source /etc/profile
```

6ã€æµ‹è¯•æ˜¯å¦æˆåŠŸ

```sh
java -version
#ä¼šæ‰“å°ä»¥ä¸‹å†…å®¹
openjdk version "17.0.2" 2022-01-18
OpenJDK Runtime Environment (build 17.0.2+8-86)
OpenJDK 64-Bit Server VM (build 17.0.2+8-86, mixed mode, sharing)
```

7ã€å¼‚å¸¸ç›¸å…³

```sh
#ä½¿ç”¨å›¾å½¢éªŒè¯ç ï¼ŒæŠ¥font nullç›¸å…³é”™ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ç„¶åé‡å¯æœåŠ¡

yum -y install fontconfig && fc-cache --force
```

#### Jenkinså®‰è£…é…ç½®

```sh
sudo wget -O /etc/yum.repos.d/jenkins.repo \
    https://pkg.jenkins.io/redhat/jenkins.repo
sudo rpm --import https://pkg.jenkins.io/redhat/jenkins.io-2023.key
sudo yum upgrade
# Add required dependencies for the jenkins package
sudo yum install java-17-openjdk
sudo yum install jenkins
```

> é…ç½®ï¼š
>

> ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼š
>

```sh
vi /etc/sysconfig/jenkins
```

> ä¿®æ”¹å†…å®¹ï¼š
>

```sh
# ä¿®æ”¹ä¸ºå¯¹åº”çš„ç›®æ ‡ç”¨æˆ·ï¼Œ è¿™é‡Œä½¿ç”¨çš„æ˜¯root
$JENKINS_USER="root"
# æœåŠ¡ç›‘å¬ç«¯å£
JENKINS_PORT="16060"
```

> ç›®å½•æƒé™ï¼š
>

```sh
chown -R root:root /var/lib/jenkins
chown -R root:root /var/cache/jenkins
chown -R root:root /var/log/jenkins
```

> é‡å¯ï¼š
>

```sh
systemctl restart jenkins
```

> å¦‚æœå¯åŠ¨å¤±è´¥ï¼Œ å‡ºç°é”™è¯¯ä¿¡æ¯ï¼š
>

```sh
Starting Jenkins bash: /usr/bin/java: No such file or directory
```

> åˆ›å»ºJAVAç¯å¢ƒçš„è½¯é“¾æ¥ï¼š
>

```sh
ln -s /usr/local/jdk/bin/java /usr/bin/java
```

> ç®¡ç†åå°åˆå§‹åŒ–è®¾ç½®http://192.168.88.101:16060/
>

> éœ€è¦è¾“å…¥ç®¡ç†å¯†ç ï¼Œ åœ¨ä»¥ä¸‹ä½ç½®æŸ¥çœ‹ï¼š
>

```sh
cat /var/lib/jenkins/secrets/initialAdminPassword
```

#### Jekinså¯åŠ¨åœæ­¢

```sh
cd /etc/init.d
./jenkins start
./jenkins stop
ps -ef | grep jenkins
```

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230702224216023.png" alt="image-20230702224216023" style="zoom:80%;" />



![image-20210802011625800](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131559360.png)

> æŒ‰é»˜è®¤è®¾ç½®ï¼ŒæŠŠå»ºè®®çš„æ’ä»¶éƒ½å®‰è£…ä¸Š
>

![image-20210802011638639](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131559384.png)

è¿™ä¸€æ­¥ç­‰å¾…æ—¶é—´è¾ƒé•¿ï¼Œ å®‰è£…å®Œæˆä¹‹åï¼Œ åˆ›å»ºç®¡ç†å‘˜ç”¨æˆ·ï¼š

![image-20210802011653454](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131559660.png)

é…ç½®è®¿é—®åœ°å€ï¼š

![image-20210802011707013](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131559673.png)



é…ç½®å®Œæˆä¹‹åï¼Œ ä¼šè¿›è¡Œé‡å¯ï¼Œ ä¹‹åå¯ä»¥çœ‹åˆ°ç®¡ç†åå°ï¼š

![image-20210802011723835](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131559691.png)



#### Jenkinsæ’ä»¶å®‰è£…

åœ¨å®ç°æŒç»­é›†æˆä¹‹å‰ï¼Œ éœ€è¦ç¡®ä¿ä»¥ä¸‹æ’ä»¶å®‰è£…æˆåŠŸã€‚

> - Maven Integration pluginï¼š Maven é›†æˆç®¡ç†æ’ä»¶ã€‚
> - Docker pluginï¼š Dockeré›†æˆæ’ä»¶ã€‚
> - GitLab Pluginï¼š GitLabé›†æˆæ’ä»¶ã€‚
> - Publish Over SSHï¼šè¿œç¨‹æ–‡ä»¶å‘å¸ƒæ’ä»¶ã€‚
> - SSH: è¿œç¨‹è„šæœ¬æ‰§è¡Œæ’ä»¶ã€‚

å®‰è£…æ–¹æ³•ï¼š

> 1. è¿›å…¥ã€ç³»ç»Ÿç®¡ç†ã€‘-ã€æ’ä»¶ç®¡ç†ã€‘
> 2. ç‚¹å‡»æ ‡ç­¾é¡µçš„ã€å¯é€‰æ’ä»¶ã€‘åœ¨è¿‡æ»¤æ¡†ä¸­æœç´¢æ’ä»¶åç§°

![image-20210802011740056](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131559973.png)

1. å‹¾é€‰æ’ä»¶ï¼Œ ç‚¹å‡»ç›´æ¥å®‰è£…å³å¯ã€‚

>æ³¨æ„ï¼Œå¦‚æœæ²¡æœ‰å®‰è£…æŒ‰é’®ï¼Œéœ€è¦æ›´æ”¹é…ç½®
>
>åœ¨å®‰è£…æ’ä»¶çš„é«˜çº§é…ç½®ä¸­ï¼Œä¿®æ”¹å‡çº§ç«™ç‚¹çš„è¿æ¥ä¸ºï¼šhttp://updates.jenkins.io/update-center.json   ä¿å­˜
>
>![image-20210802011758588](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131559000.png)
>
>

## æœåŠ¡å™¨ç¯å¢ƒé…ç½®

### Gitå®‰è£…é…ç½®

> yum å®‰è£…æ–¹å¼
>

```sh
yum -y install git
```

> é‡‡ç”¨æºç åŒ…æ–¹å¼å®‰è£…ï¼Œå®‰è£…ä¾èµ–åŒ…
>

```sh
yum -y install curl-devel expat-devel gettext-devel openssl-devel zlib-devel
yum -y install gcc perl-ExtUtils-MakeMaker
```

> å¦‚æœä¹‹å‰æœ‰å®‰è£…æ—§ç‰ˆæœ¬ï¼Œ å…ˆåšå¸è½½ï¼Œ æ²¡æœ‰å®‰è£…åˆ™å¿½ç•¥
>

```sh
yum remove git
```

> ä¸‹è½½æºç åŒ…
>

```sh
cd /usr/local
wget https://mirrors.edge.kernel.org/pub/software/scm/git/git-1.8.3.1.tar.gz
tar -xvf git-1.8.3.1.tar.gz
```

> ä¹Ÿå¯ä»¥å®‰è£…å…¶ä»–ç‰ˆæœ¬ï¼Œ åœ°å€ï¼šhttps://mirrors.edge.kernel.org/pub/software/scm/git/
>

> ç¼–è¯‘å®‰è£…
>

```sh
cd git-1.8.3.1
make prefix=/usr/local/git all
make prefix=/usr/local/git install
echo "export PATH=$PATH:/usr/local/git/bin" >> /etc/bashrc
source /etc/bashrc
```

> æ£€æŸ¥gitç‰ˆæœ¬
>

```sh
git version
```

### Mavenå®‰è£…é…ç½®

æ³¨æ„ï¼šmavenç‰ˆæœ¬ä¸è¦å¤ªé«˜ï¼Œä¸ç„¶æœ‰çš„ä¾èµ–ä¼šè£…ä¸ä¸Š

```apl
cd /usr/local
```

```apl
wget https://dlcdn.apache.org/maven/maven-3/3.6.3/binaries/apache-maven-3.6.3-bin.tar.gz
```

```apl
tar -zxvf apache-maven-3.6.3-bin.tar.gz 
```

å¡«å†™é…ç½®æ–‡ä»¶

```apl
vi /etc/profile
export MAVEN_HOME=/usr/local/apache-maven-3.6.3
export PATH=$PATH:$MAVEN_HOME/bin
source /etc/profile
```

æŸ¥çœ‹æ˜¯å¦æˆåŠŸ

```apl
mvn -version
```

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2022.5.13/202205231107938.png" alt="image-20220523110751868" style="zoom:80%;" />

> é…ç½®é˜¿é‡Œäº‘é•œåƒ,æ³¨æ„ï¼šæ³¨é‡Šæ‰åŸæ¥çš„mirrorï¼ŒåŠ ä¸Šè¿™ä¸ªmirror
>

```xml
<mirrors>
    <mirror>
          <id>alimaven</id>
          <name>aliyun maven</name>
          <url>http://maven.aliyun.com/nexus/content/groups/public/</url>
          <mirrorOf>central</mirrorOf>        
    </mirror>
</mirrors>
```

```apl
mvn -v
```

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2022.6.30/202207030944232.png" alt="image-20220703094412126" style="zoom:67%;" />

### Dockerå®‰è£…é…ç½®

> æ›´æ–°è½¯ä»¶åŒ…ç‰ˆæœ¬
>

```sh
yum -y update
```

> å¸è½½æ—§ç‰ˆæœ¬
>

```sh
yum -y remove docker  docker-common docker-selinux docker-engine
```

> å®‰è£…è½¯ä»¶ä¾èµ–åŒ…
>

```sh
yum install -y yum-utils device-mapper-persistent-data lvm2
```

> è®¾ç½®yumæºä¸ºé˜¿é‡Œäº‘
>

```sh
sudo yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
```

> å®‰è£…åæŸ¥çœ‹dockerç‰ˆæœ¬
>

```sh
docker -v
```

> å¯åŠ¨,è®¾ç½®å¼€æœºå¯åŠ¨ï¼š
>

```sh
systemctl enable docker
```

> å¯åŠ¨docker
>

```sh
systemctl start docker
```

##  Jenkinså·¥å…·é…ç½®

> è¿›å…¥ã€ç³»ç»Ÿç®¡ç†ã€‘--> ã€å…¨å±€å·¥å…·é…ç½®ã€‘
>

![image-20210802011944005](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131559308.png)

> æŒ‡å®šJDKé…ç½®

![image-20210802012010244](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131559619.png)

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230703143116370.png" alt="image-20230703143116370" style="zoom:80%;" />



> æŒ‡å®šMAVEN ç›®å½•
>

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230703143230965.png" alt="image-20230703143230965" style="zoom:80%;" />

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230703152633424.png" alt="image-20230703152633424" style="zoom:80%;" />

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230703152758324.png" alt="image-20230703152758324" style="zoom:80%;" />

> æŒ‡å®šDOCKERç›®å½•
>

![image-20210802012038581](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131559652.png)

å¦‚æœä¸æ¸…æ¥šdockerçš„å®‰è£…çš„ç›®å½•ï¼Œå¯ä»¥ä½¿ç”¨`whereis docker` å‘½ä»¤æŸ¥çœ‹dockerçš„å®‰è£…çš„ç›®å½•


# åç«¯é¡¹ç›®éƒ¨ç½²

## å¤šç¯å¢ƒåˆ‡æ¢

> åœ¨é¡¹ç›®å¼€å‘éƒ¨ç½²çš„è¿‡ç¨‹ä¸­ï¼Œä¸€èˆ¬éƒ½ä¼šæœ‰ä¸‰å¥—é¡¹ç›®ç¯å¢ƒ

> - Development ï¼šå¼€å‘ç¯å¢ƒ
>
> - Production ï¼šç”Ÿäº§ç¯å¢ƒ
>
> - Test ï¼šæµ‹è¯•ç¯å¢ƒ

> ä¾‹å¦‚ï¼šå¼€å‘ç¯å¢ƒçš„mysqlè¿æ¥çš„æ˜¯æœ¬åœ°ï¼Œç”Ÿäº§ç¯å¢ƒéœ€è¦è¿æ¥çº¿ä¸Šçš„mysqlç¯å¢ƒ
>

### å¼€å‘ç¯å¢ƒé…ç½®

> 1.åœ¨userå¾®æœåŠ¡ä¸­çš„bootstrap.ymlä¸­ä¿®æ”¹é…ç½®ï¼ŒåŠ å…¥dev

```yaml
server:
  port: 51801
spring:
  application:
    name: leadnews-user
  cloud:
    nacos:
      discovery:
        server-addr: 192.168.88.101:8848
      config:
        server-addr: 192.168.88.101:8848
        file-extension: yml
  profiles:
    active: dev
```

> 2.åœ¨nacosçš„é…ç½®ä¸­å¿ƒä¸­æ–°å¢å„ä¸ªç¯å¢ƒçš„é…ç½®æ–‡ä»¶ï¼Œåˆ›å»ºå¯¹åº”çš„nacosçš„å¤šç¯å¢ƒé…ç½®ï¼š

![](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230703144350806.png)

```yml
spring:
  datasource:
    driver-class-name: com.mysql.jdbc.Driver
    url: jdbc:mysql://localhost:3306/leadnews_user?useUnicode=true&serverTimezone=UTC
    username: root
    password: 123456
# è®¾ç½®Mapperæ¥å£æ‰€å¯¹åº”çš„XMLæ–‡ä»¶ä½ç½®ï¼Œå¦‚æœä½ åœ¨Mapperæ¥å£ä¸­æœ‰è‡ªå®šä¹‰æ–¹æ³•ï¼Œéœ€è¦è¿›è¡Œè¯¥é…ç½®
mybatis-plus:
  mapper-locations: classpath*:mapper/*.xml
  # è®¾ç½®åˆ«ååŒ…æ‰«æè·¯å¾„ï¼Œé€šè¿‡è¯¥å±æ€§å¯ä»¥ç»™åŒ…ä¸­çš„ç±»æ³¨å†Œåˆ«å
  type-aliases-package: com.heima.model.user.pojos
```

### ç”Ÿäº§ç¯å¢ƒé…ç½®

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230703144552279.png" alt="image-20230703144552279" style="zoom:80%;" />

![image-20210623143417530](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131559849.png)

### æ³¨æ„äº‹é¡¹

> å…¶ä¸­DataIDå±æ€§å‘½åæœ‰è§„èŒƒï¼š

> prefixï¼Œé»˜è®¤ä½¿ç”¨${spring.application.name}ï¼Œä¹Ÿå¯ä»¥é€šè¿‡spring.cloud.nacos.config.prefixæ¥é…ç½®ã€‚

> spring.profile.activeï¼Œå³ä¸ºå½“å‰ç¯å¢ƒå¯¹åº”çš„ profileã€‚ æ³¨æ„ï¼šå½“ spring.profile.active ä¸ºç©ºæ—¶ï¼Œå¯¹åº”çš„è¿æ¥ç¬¦ - ä¹Ÿå°†ä¸å­˜åœ¨ï¼ŒdataId çš„æ‹¼æ¥æ ¼å¼å˜æˆ ${prefix}.${file-extension}

> file-exetensionï¼Œä¸ºé…ç½®å†…å®¹çš„æ•°æ®æ ¼å¼ï¼Œå¯ä»¥é€šè¿‡é…ç½®é¡¹ spring.cloud.nacos.config.file-extension æ¥é…ç½®ã€‚ç›®å‰åªæ”¯æŒ properties å’Œ yaml ç±»å‹ã€‚

## æœåŠ¡é›†æˆDockeré…ç½®

### æ•´ä½“æ€è·¯

> ç›®æ ‡ï¼šæŠŠé»‘é©¬å¤´æ¡çš„appç«¯ç›¸å…³çš„å¾®æœåŠ¡éƒ¨ç½²åˆ°192.168.200.100è¿™å°æœåŠ¡å™¨ä¸Š
>

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230703144644309.png" alt="image-20230703144644309" style="zoom:80%;" />

![image-20210802004007699](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131559073.png)

> ç›®æ ‡ï¼šéƒ¨ç½²çš„æ¯ä¸€ä¸ªå¾®æœåŠ¡éƒ½æ˜¯å…ˆåˆ›å»ºdockeré•œåƒååˆ›å»ºå¯¹åº”å®¹å™¨å¯åŠ¨
>

> æ–¹å¼ä¸€ï¼šæœ¬åœ°å¾®æœåŠ¡æ‰“åŒ…ä»¥åä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼Œç¼–å†™Dockerfileæ–‡ä»¶å®Œæˆã€‚
>

> æ–¹å¼äºŒï¼šä½¿ç”¨dockerfile-maven-pluginæ’ä»¶ï¼Œå¯ä»¥ç›´æ¥æŠŠå¾®æœåŠ¡åˆ›å»ºä¸ºé•œåƒä½¿ç”¨ï¼ˆæ›´çœäº‹ï¼‰
>

### ç äº‘è¿œç¨‹ä»“åº“

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230703145043558.png" alt="image-20230703145043558" style="zoom:80%;" />

```sh
git init 
touch README.md
git add README.md
git commit -m "first commit"
git remote add origin https://gitee.com/sure-s-renshuo/heima-leadnews1.git
git push -u origin "master"
```

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230703145307908.png" alt="image-20230703145307908" style="zoom:80%;" />

### æœåŠ¡é›†æˆDockeré…ç½®

> ç›®æ ‡ï¼šéƒ¨ç½²çš„æ¯ä¸€ä¸ªå¾®æœåŠ¡éƒ½æ˜¯å…ˆåˆ›å»ºdockeré•œåƒååˆ›å»ºå¯¹åº”å®¹å™¨å¯åŠ¨
>
> æ–¹å¼ä¸€ï¼šæœ¬åœ°å¾®æœåŠ¡æ‰“åŒ…ä»¥åä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼Œç¼–å†™Dockerfileæ–‡ä»¶å®Œæˆã€‚
>
> æ–¹å¼äºŒï¼šä½¿ç”¨dockerfile-maven-pluginæ’ä»¶ï¼Œå¯ä»¥ç›´æ¥æŠŠå¾®æœåŠ¡åˆ›å»ºä¸ºé•œåƒä½¿ç”¨ï¼ˆæ›´çœäº‹ï¼‰

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230703145515708.png" alt="image-20230703145515708" style="zoom:80%;" />

> æ¯ä¸ªå¾®æœåŠ¡éƒ½å¼•å…¥è¯¥ä¾èµ–,ä»¥heima-leadnews-userå¾®æœåŠ¡ä¸ºä¾‹
>

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 
                             http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <parent>
        <artifactId>heima-leadnews-service</artifactId>
        <groupId>com.heima</groupId>
        <version>1.0-SNAPSHOT</version>
    </parent>
    <modelVersion>4.0.0</modelVersion>

    <artifactId>heima-leadnews-user</artifactId>

    <properties>
        <maven.compiler.source>8</maven.compiler.source>
        <maven.compiler.target>8</maven.compiler.target>
        <docker.image>docker_storage</docker.image>
    </properties>

    <build>
        <finalName>heima-leadnews-user</finalName>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
                <executions>
                    <execution>
                        <goals>
                            <goal>repackage</goal>
                        </goals>
                    </execution>
                </executions>
            </plugin>
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-compiler-plugin</artifactId>
                <version>3.7.0</version>
                <configuration>
                    <source>${java.version}</source>
                    <target>${java.version}</target>
                </configuration>
            </plugin>
            <plugin>
                <groupId>com.spotify</groupId>
                <artifactId>dockerfile-maven-plugin</artifactId>
                <version>1.3.6</version>
                <configuration>
                    <repository>${docker.image}/${project.artifactId}</repository>
                    <buildArgs>
                        <JAR_FILE>target/${project.build.finalName}.jar</JAR_FILE>
                    </buildArgs>
                </configuration>
            </plugin>
        </plugins>
    </build>

</project>
```

> å’ŒPOMåŒçº§ï¼Œåˆ›å»ºDockerfile,**æœåŠ¡é›†æˆDockerfileæ–‡ä»¶**

```dockerfile
# è®¾ç½®JAVAç‰ˆæœ¬
FROM java:8
# æŒ‡å®šå­˜å‚¨å·, ä»»ä½•å‘/tmpå†™å…¥çš„ä¿¡æ¯éƒ½ä¸ä¼šè®°å½•åˆ°å®¹å™¨å­˜å‚¨å±‚
VOLUME /tmp
# æ‹·è´è¿è¡ŒJARåŒ…
ARG JAR_FILE
COPY ${JAR_FILE} app.jar
# è®¾ç½®JVMè¿è¡Œå‚æ•°ï¼Œ è¿™é‡Œé™å®šä¸‹å†…å­˜å¤§å°ï¼Œå‡å°‘å¼€é”€
ENV JAVA_OPTS="\
-server \
-Xms256m \
-Xmx512m \
-XX:MetaspaceSize=256m \
-XX:MaxMetaspaceSize=512m"
#ç©ºå‚æ•°ï¼Œæ–¹ä¾¿åˆ›å»ºå®¹å™¨æ—¶ä¼ å‚
ENV PARAMS=""
# å…¥å£ç‚¹ï¼Œ æ‰§è¡ŒJAVAè¿è¡Œå‘½ä»¤
ENTRYPOINT ["sh","-c","java -jar $JAVA_OPTS /app.jar $PARAMS"]
```



## JenkinsåŸºç¡€ä¾èµ–æ‰“åŒ…é…ç½®

> åœ¨å¾®æœåŠ¡è¿è¡Œä¹‹å‰éœ€è¦åœ¨æœ¬åœ°ä»“åº“ä¸­å…ˆå»installæ‰€ä¾èµ–çš„jaråŒ…ï¼Œæ‰€ä»¥ç¬¬ä¸€æ­¥åº”è¯¥æ˜¯ä»gitä¸­æ‹‰å–ä»£ç ï¼Œå¹¶ä¸”æŠŠåŸºç¡€çš„ä¾èµ–éƒ¨åˆ†å®‰è£…åˆ°ä»“åº“ä¸­
>

> æ–°å»ºitemï¼Œçˆ¶å·¥ç¨‹heima-leadnews
>

![image-20210802004744531](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131559350.png)

> 2ï¼Œæ‰¾åˆ°è‡ªå·±æŒ‡å®šçš„gitä»“åº“ï¼Œè®¾ç½®ç”¨æˆ·åå’Œå¯†ç 

![image-20210802004803711](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131559377.png)

> 3ï¼ŒæŠŠåŸºç¡€ä¾èµ–ä¿¡æ¯å®‰è£…åˆ°æœåŠ¡å™¨ä¸Šçš„æœ¬åœ°ä»“åº“

> clean install -Dmaven.test.skip=true -f heima-leadnews/pom.xml

![image-20210802004818581](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131559577.png)

> ç‚¹åº”ç”¨å’Œä¿å­˜ï¼Œå›åˆ°åŸå§‹é¡µé¢

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230703150434249.png" alt="image-20230703150434249" style="zoom:80%;" />

> 4ï¼Œæ‰§è¡Œï¼Œæ‰§è¡Œæ—¥å¿—ï¼Œéƒ¨åˆ†æˆªå›¾ï¼Œä¸‹é¢æ˜¯ä»gitä¸­æ‹‰å–ä»£ç 

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230703150531627.png" alt="image-20230703150531627" style="zoom:80%;" />

![image-20210802004838998](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131559669.png)

æ‰§è¡Œæ—¥å¿—ï¼Œéƒ¨åˆ†æˆªå›¾ï¼Œç¼–è¯‘æ‰“åŒ…

![image-20210802004858057](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131559688.png)

æ‰§è¡Œæ—¥å¿—ï¼Œéƒ¨åˆ†æˆªå›¾ï¼Œæ‰§è¡ŒæˆåŠŸ

![image-20210802004915042](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131559964.png)

### jenkinså¾®æœåŠ¡æ‰“åŒ…é…ç½®

æ‰€æœ‰å¾®æœåŠ¡æ‰“åŒ…çš„æ–¹å¼ç±»ä¼¼ï¼Œä»¥heima-leadnews-userå¾®æœåŠ¡ä¸ºä¾‹

1ï¼Œæ–°å»ºä»»åŠ¡

![image-20210802004942366](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131559984.png)

2ï¼Œæ‰¾åˆ°è‡ªå·±æŒ‡å®šçš„gitä»“åº“ï¼Œè®¾ç½®ç”¨æˆ·åå’Œå¯†ç 

![image-20210802005000376](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131559000.png)

3ï¼Œæ‰§è¡Œmavenå‘½ä»¤

![image-20210802005018020](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131559197.png)



![image-20210802005027229](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131559215.png)

```java
clean install -Dmaven.test.skip=true  dockerfile:build -f heima-leadnews/heima-leadnews-service/heima-leadnews-user/pom.xml
```

<font color='red'>æ³¨æ„ï¼šæ ¹æ®è‡ªå·±çš„å®é™…ä»£ç è·¯å¾„é…ç½®</font>

-Dmaven.test.skip=true  è·³è¿‡æµ‹è¯•

dockerfile:build å¯åŠ¨dockerfileæ’ä»¶æ„å»ºå®¹å™¨

-f heima-leadnews-user/pom.xml æŒ‡å®šéœ€è¦æ„å»ºçš„æ–‡ä»¶ï¼ˆå¿…é¡»æ˜¯pomï¼‰

4ï¼Œå¹¶æ‰§è¡Œshellè„šæœ¬

![image-20210802005318464](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131559509.png)

![image-20210802005329034](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131559527.png)

```java
if [ -n  "$(docker ps -a -f  name=$JOB_NAME  --format '{{.ID}}' )" ]
 then
 #åˆ é™¤ä¹‹å‰çš„å®¹å™¨
 docker rm -f $(docker ps -a -f  name=$JOB_NAME  --format '{{.ID}}' )
fi
 # æ¸…ç†é•œåƒ
docker image prune -f 
 # å¯åŠ¨dockeræœåŠ¡
docker run -d --net=host -e PARAMS="--spring.profiles.active=prod"  --name $JOB_NAME docker_storage/$JOB_NAME
```

5ï¼Œæ‰§è¡Œæ—¥å¿—

æ‹‰å–ä»£ç 

![image-20210802005404751](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131559547.png)

ç¼–è¯‘æ‰“åŒ…

![image-20210802005417489](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131559843.png)

æ„å»ºé•œåƒ

![image-20210802005438400](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131559863.png)

æ¸…ç†å®¹å™¨ï¼Œåˆ›å»ºæ–°çš„å®¹å™¨

![image-20210802005452184](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131559885.png)



### éƒ¨ç½²æœåŠ¡åˆ°è¿œç¨‹æœåŠ¡å™¨ä¸Š

ç›®æ ‡ï¼šä½¿ç”¨jenkinsï¼ˆ192.168.200.100ï¼‰æŠŠå¾®æœåŠ¡æ‰“åŒ…éƒ¨ç½²åˆ°192.168.200.130æœåŠ¡å™¨ä¸Š

![image-20210802005538404](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131559150.png)

#### å®‰è£…é…ç½®ç§æœ‰ä»“åº“

å¯¹äºæŒç»­é›†æˆç¯å¢ƒçš„é…ç½®ï¼ŒJenkinsä¼šå‘å¸ƒå¤§é‡çš„å¾®æœåŠ¡ï¼Œ è¦ä¸å¤šå°æœºå™¨è¿›è¡Œäº¤äº’ï¼Œ å¯ä»¥é‡‡ç”¨dockeré•œåƒçš„ä¿å­˜ä¸å¯¼å‡ºåŠŸèƒ½ç»“åˆSSHå®ç°ï¼Œ ä½†è¿™æ ·äº¤äº’ç¹çï¼Œç¨³å®šæ€§å·®ï¼Œ è€Œä¸”ä¸ä¾¿ç®¡ç†ï¼Œ è¿™é‡Œæˆ‘ä»¬é€šè¿‡æ­å»ºDockerçš„ç§æœ‰ä»“åº“æ¥å®ç°ï¼Œ è¿™ä¸ªæœ‰ç‚¹ç±»ä¼¼GITä»“åº“ï¼Œ é›†ä¸­ç»Ÿä¸€ç®¡ç†èµ„æºï¼Œ ç”±å®¢æˆ·ç«¯æ‹‰å–æˆ–æ›´æ–°ã€‚

1. ä¸‹è½½æœ€æ–°Registryé•œåƒ

   ```sh
   docker pull registry:latest
   ```

2. å¯åŠ¨Registryé•œåƒæœåŠ¡

   ```sh
   docker run -d -p 5000:5000 --name registry -v /usr/local/docker/registry:/var/lib/registry registry:latest
   ```

   æ˜ å°„5000ç«¯å£ï¼› -væ˜¯å°†Registryå†…çš„é•œåƒæ•°æ®å·ä¸æœ¬åœ°æ–‡ä»¶å…³è”ï¼Œ ä¾¿äºç®¡ç†å’Œç»´æŠ¤Registryå†…çš„æ•°æ®ã€‚

3. æŸ¥çœ‹ä»“åº“èµ„æº

   è®¿é—®åœ°å€ï¼šhttp://192.168.200.100:5000/v2/_catalog

   å¯åŠ¨æ­£å¸¸ï¼Œ å¯ä»¥çœ‹åˆ°è¿”å›ï¼š

   ```json
   {"repositories":[]}
   ```

   ç›®å‰å¹¶æ²¡æœ‰ä¸Šä¼ é•œåƒï¼Œ æ˜¾ç¤ºç©ºæ•°æ®ã€‚

   å¦‚æœä¸Šä¼ æˆåŠŸï¼Œ å¯ä»¥çœ‹åˆ°æ•°æ®:
   ![image-20210802005839314](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131559165.png)

4. é…ç½®Dockerå®¢æˆ·ç«¯

   æ­£å¸¸ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨ï¼Œ è¦é…ç½®HTTPSæœåŠ¡ï¼Œ ç¡®ä¿å®‰å…¨ï¼Œå†…éƒ¨å¼€å‘æˆ–æµ‹è¯•é›†æˆçš„å±€åŸŸç½‘ç¯å¢ƒï¼Œå¯ä»¥é‡‡ç”¨ç®€ä¾¿çš„æ–¹å¼ï¼Œ ä¸åšå®‰å…¨æ§åˆ¶ã€‚

   å…ˆç¡®ä¿æŒç»­é›†æˆç¯å¢ƒçš„æœºå™¨å·²å®‰è£…å¥½Dockerå®¢æˆ·ç«¯ï¼Œ ç„¶ååšä»¥ä¸‹ä¿®æ”¹ï¼š

   ```sh
   vi /lib/systemd/system/docker.service
   ```

   ä¿®æ”¹å†…å®¹ï¼š

   ```sh
   ExecStart=/usr/bin/dockerd --insecure-registry 192.168.200.100:5000
   ```

   æŒ‡å‘å®‰è£…Registryçš„æœåŠ¡IPä¸ç«¯å£ã€‚

   é‡å¯ç”Ÿæ•ˆï¼š

   ```sh
   systemctl daemon-reolad
   systemctl restart docker.service
   ```

#### jenkinsä¸­å®‰è£…æ’ä»¶

![image-20210802005913026](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131559185.png)

#### jenkinsç³»ç»Ÿé…ç½®è¿œç¨‹æœåŠ¡å™¨é“¾æ¥

ä½ç½®ï¼šManage Jenkins-->Configure System

![image-20210802005937966](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131559406.png)

éœ€è¦æ·»åŠ å‡­è¯

ä½ç½®ï¼šManage Jenkins-->Manage CreDentials

![image-20210802010324224](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131559496.png)

æ·»åŠ é“¾æ¥åˆ°130æœåŠ¡å™¨çš„ç”¨æˆ·åå’Œå¯†ç 

![image-20210802010525665](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131559518.png)

![image-20210802010429136](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131559797.png)

![image-20210802010201146](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131559813.png)

#### jenkinsé¡¹ç›®åˆ›å»ºä¸å…¶ä»–å¾®æœåŠ¡ç›¸åŒ

åˆ›å»ºé¡¹ç›®å‚è€ƒä¹‹å‰åˆ›å»ºè¿‡çš„ç”¨æˆ·å¾®æœåŠ¡

#### è®¾ç½®å‚æ•°

![image-20210802010650039](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131559830.png)

#### æ„å»ºæ‰§è¡ŒExecute shell

![image-20210802010720937](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131559097.png)

mavenå‘½ä»¤

```java
clean install -Dmaven.test.skip=true dockerfile:build -f heima-leadnews/heima-leadnews-service/heima-leadnews-article/pom.xml
```

shellè„šæœ¬

```shell
image_tag=$docker_registry/docker_storage/$JOB_NAME
echo '================dockeré•œåƒæ¸…ç†================'
if [ -n  "$(docker ps -a -f  name=$JOB_NAME  --format '{{.ID}}' )" ]
 then
 #åˆ é™¤ä¹‹å‰çš„å®¹å™¨
 docker rm -f $(docker ps -a -f  name=$JOB_NAME  --format '{{.ID}}' )
fi
 # æ¸…ç†é•œåƒ
docker image prune -f 

# åˆ›å»ºTAG
docker tag docker_storage/$JOB_NAME $image_tag
echo '================dockeré•œåƒæ¨é€================'
# æ¨é€é•œåƒ
docker push $image_tag
# åˆ é™¤TAG
docker rmi $image_tag
echo '================docker tag æ¸…ç† ================'
```

#### åœ¨è¿œç¨‹æœåŠ¡å™¨ä¸Šæ‰§è¡Œè„šæœ¬

![image-20210802010750809](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131559112.png)

è¿œç¨‹æœåŠ¡å™¨æ‰§è¡Œçš„shellè„šæœ¬

```shell
echo '================æ‹‰å–æœ€æ–°é•œåƒ================'
docker pull $docker_registry/docker_storage/$JOB_NAME

echo '================åˆ é™¤æ¸…ç†å®¹å™¨é•œåƒ================'
if [ -n  "$(docker ps -a -f  name=$JOB_NAME  --format '{{.ID}}' )" ]
 then
 #åˆ é™¤ä¹‹å‰çš„å®¹å™¨
 docker rm -f $(docker ps -a -f  name=$JOB_NAME  --format '{{.ID}}' )
fi
 # æ¸…ç†é•œåƒ
docker image prune -f 

echo '===============å¯åŠ¨å®¹å™¨================'
docker run -d   --net=host -e PARAMS="--spring.profiles.active=prod" --name $JOB_NAME $docker_registry/docker_storage/$JOB_NAME
```

#### æ„å»ºå®Œæˆä»¥åï¼Œå¯ä»¥ç™»å½•130æœåŠ¡å™¨ï¼ŒæŸ¥çœ‹æ˜¯å¦æœ‰ç›¸å…³çš„é•œåƒå’Œå®¹å™¨

é•œåƒ

![image-20210802010824088](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131559130.png)

å®¹å™¨

![image-20210802010835702](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131559404.png)

### è”è°ƒæµ‹è¯•

1.å‚è€ƒjenkinsä¸­heima-leadnews-userå¾®æœåŠ¡æŠŠappç«¯ç½‘å…³éƒ¨ç½²èµ·æ¥

2.ä¿®æ”¹æœ¬åœ°nginxä¸­çš„é…ç½®åå‘ä»£ç†åœ°å€ä¸º100è¿™å°æœåŠ¡å™¨ï¼šheima-leadnews-app.conf

```html
upstream  heima-app-gateway{
	server 192.168.200.100:51601;
}
```

3.å¯åŠ¨nginxï¼Œæ‰“å¼€é¡µé¢è¿›è¡Œæµ‹è¯•



## Jenkinsè§¦å‘å™¨é…ç½®

### URLè§¦å‘è¿œç¨‹æ„å»º

è§¦å‘è¿œç¨‹æ„å»ºï¼Œä¿®æ”¹jenkinsçš„é…ç½®ï¼Œå¦‚ä¸‹

![image-20210802011202642](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131559434.png)

è§¦å‘æ„å»ºurlï¼š http://192.168.200.100:16060/job/leadnews-admin/build?token=88888888

### å…¶ä»–å·¥ç¨‹æ„å»ºåè§¦å‘

é…ç½®éœ€è¦è§¦å‘çš„å·¥ç¨‹

![image-20210802011225737](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131559453.png)

### å®šæ—¶æ„å»º

å®šæ—¶æ„å»ºï¼ˆ Build periodicallyï¼‰

![image-20210802011245118](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131559746.png)

å®šæ—¶å­—ç¬¦ä¸²ä»å·¦å¾€å³åˆ†åˆ«ä¸ºï¼š åˆ† æ—¶ æ—¥ æœˆ å‘¨

### å®šæ—¶æ„å»º-å®šæ—¶è¡¨è¾¾å¼

> å®šæ—¶å­—ç¬¦ä¸²ä»å·¦å¾€å³åˆ†åˆ«ä¸ºï¼š åˆ† æ—¶ æ—¥ æœˆ å‘¨
>

| ç»„æˆéƒ¨åˆ† | å«ä¹‰        | å–å€¼èŒƒå›´                   |
| -------- | ----------- | -------------------------- |
| ç¬¬ä¸€éƒ¨åˆ† | minute (åˆ†) | 0~59                       |
| ç¬¬äºŒéƒ¨åˆ† | hour(å°æ—¶)  | 0~23                       |
| ç¬¬ä¸‰éƒ¨åˆ† | day(å¤©)     | 1~31                       |
| ç¬¬å››éƒ¨åˆ† | month(æœˆ)   | 1~12                       |
| ç¬¬äº”éƒ¨åˆ† | week(å‘¨)    | 0~7ï¼Œ0 å’Œ 7 éƒ½æ˜¯è¡¨ç¤ºæ˜ŸæœŸå¤© |

- ç¬¦å·H è¡¨ç¤ºä¸€ä¸ªéšæœºæ•°

- ç¬¦å·*  å–å€¼èŒƒå›´çš„ä»»æ„å€¼

æ¡ˆä¾‹ï¼š

> - æ¯30åˆ†é’Ÿæ„å»ºä¸€æ¬¡ï¼šH/30 * * * * 10:02 10:32
>
> - æ¯2ä¸ªå°æ—¶æ„å»ºä¸€æ¬¡: H H/2 * * *
>
> - æ¯å¤©çš„8ç‚¹ï¼Œ12ç‚¹ï¼Œ22ç‚¹ï¼Œä¸€å¤©æ„å»º3æ¬¡ï¼š (å¤šä¸ªæ—¶é—´ç‚¹ä¸­é—´ç”¨é€—å·éš”å¼€) 0 8,12,22 * * *
>
> - æ¯å¤©ä¸­åˆ12ç‚¹å®šæ—¶æ„å»ºä¸€æ¬¡ H 12 * * *
>
> - æ¯å¤©ä¸‹åˆ18ç‚¹å®šæ—¶æ„å»ºä¸€æ¬¡ H 18 * * *

### è½®è¯¢SCM

> è½®è¯¢ SCMï¼ˆPoll SCMï¼‰,è½®è¯¢SCMï¼Œæ˜¯æŒ‡å®šæ—¶æ‰«ææœ¬åœ°ä»£ç ä»“åº“çš„ä»£ç æ˜¯å¦æœ‰å˜æ›´ï¼Œå¦‚æœä»£ç æœ‰å˜æ›´å°±è§¦å‘é¡¹ç›®æ„å»ºã€‚
>

![image-20210802011431941](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131559760.png)

Jenkinsä¼šå®šæ—¶æ‰«ææœ¬åœ°æ•´ä¸ªé¡¹ç›®çš„ä»£ç ï¼Œå¢å¤§ç³»ç»Ÿçš„å¼€é”€ï¼Œä¸å»ºè®®ä½¿ç”¨ã€‚





